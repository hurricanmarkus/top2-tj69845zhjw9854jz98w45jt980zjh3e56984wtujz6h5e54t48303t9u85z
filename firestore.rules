rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS (Hilfsfunktionen) 
    // ═══════════════════════════════════════════════════════════════
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function hasAppRole(roleName) {
      return isAuthenticated() && request.auth.token != null && request.auth.token.appRole == roleName;
    }
    
    function isAdminOrSystemAdminClaim() {
      return hasAppRole('ADMIN') || hasAppRole('SYSTEMADMIN');
    }
    
    function isSystemAdminClaim() {
      return hasAppRole('SYSTEMADMIN');
    }

    function hasAppUserIdClaim() {
      return isAuthenticated() && request.auth.token != null && request.auth.token.appUserId != null;
    }

    function appUserId() {
      return request.auth.token.appUserId;
    }

    function isSelfAppUser(userId) {
      return hasAppUserIdClaim() && appUserId() == userId;
    }

    function isUserConfigKeyUnchanged() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['key']);
    }

    function currentUserConfig() {
      return get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/public/data/user-config/$(appUserId())).data;
    }

    function adminRoleHasPermission(roleId, permKey) {
      let rolePerms = get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/public/data/admin-roles/$(roleId)).data.permissions;
      return (permKey in rolePerms) && rolePerms[permKey] == true;
    }

    function adminHasPermission(permKey) {
      let u = currentUserConfig();

      // Admins sind über Custom Claim abgesichert
      let isAdminClaim = hasAppRole('ADMIN');

      // Default: wenn adminPermissionType fehlt, behandeln wir es als 'role'
      let permType = ('adminPermissionType' in u) ? u.adminPermissionType : 'role';

      // 1) Individuelle Admin-Rechte
      let hasIndividualPerm = ('adminPermissions' in u) && (permKey in u.adminPermissions) && u.adminPermissions[permKey] == true;

      // 2) Rollen-basierte Admin-Rechte
      let hasRolePerm = ('assignedAdminRoleId' in u) && u.assignedAdminRoleId != null && adminRoleHasPermission(u.assignedAdminRoleId, permKey);

      return isAdminClaim && ((permType == 'individual') ? hasIndividualPerm : hasRolePerm);
    }

    // ═══════════════════════════════════════════════════════════════
    // BENUTZERVERWALTUNG (User Management)
    // ═══════════════════════════════════════════════════════════════
    
    // USER-CONFIG: Benutzerprofile
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/user-config/{userId} {
      allow read: if isAuthenticated();
      allow create: if isSystemAdminClaim() && !('key' in request.resource.data);
      allow delete: if isSystemAdminClaim();
      allow update: if (isAdminOrSystemAdminClaim() || isSelfAppUser(userId)) && isUserConfigKeyUnchanged();
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/private/secrets/{path=**} {
      allow read, write: if false;
    }

    // USER-ROLES: Definitionen der Standard-Rollen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/user-roles/{roleId} {
      allow read: if true;
      allow write: if isSystemAdminClaim();
    }

    // ADMIN-ROLES: Definitionen der Admin-Rollen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/admin-roles/{roleId} {
      allow read: if true;
      allow write: if isSystemAdminClaim();
    }

    // ═══════════════════════════════════════════════════════════════
    // SYSTEM & ADMIN (System & Administration)
    // ═══════════════════════════════════════════════════════════════
    
    // APP-SETTINGS: Anwendungseinstellungen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/app-settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrSystemAdminClaim();
    }

    // AUDIT-LOG: Aktivitätsprotokoll
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/audit-log/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdminOrSystemAdminClaim();
    }

    // ROLE-CHANGE-REQUESTS: Rollenänderungsanfragen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/role-change-requests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isSystemAdminClaim();
    }

    // APPROVAL-REQUESTS: Genehmigungsanfragen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/approval-requests/{requestId} {
      allow read: if isSystemAdminClaim() || (hasAppUserIdClaim() && appUserId() == resource.data.requestedById);
      allow create: if hasAppUserIdClaim() && request.resource.data.requestedById == appUserId() && request.resource.data.status == 'pending';
      allow update: if isSystemAdminClaim() || (
        hasAppUserIdClaim() &&
        appUserId() == resource.data.requestedById &&
        resource.data.status == 'pending' &&
        request.resource.data.status == 'withdrawn' &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'actionTakenByName'])
      );
      allow delete: if isSystemAdminClaim();
    }

    // SETTINGS: Modulspezifische Einstellungen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // CHECKLISTEN-SYSTEM (Checklist System)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklists/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-items/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-groups/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-categories/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-stacks/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-templates/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-templates/{templateId}/template-items/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // TERMINPLANER (Appointment Scheduler)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/votes/{voteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // ZAHLUNGSVERWALTUNG (Payment Management)
    // ═══════════════════════════════════════════════════════════════
    
    // PAYMENTS: Zahlungen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/payments/{paymentId} {
      allow read: if isSystemAdminClaim() || adminHasPermission('canDeleteUser') || adminHasPermission('canRenameUser') || (hasAppUserIdClaim() && resource.data.involvedUserIds.hasAny([appUserId()]));
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId() && request.resource.data.involvedUserIds.hasAny([appUserId()]);
      allow update: if hasAppUserIdClaim() && resource.data.involvedUserIds.hasAny([appUserId()]);
      allow delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }
    
    // PAYMENT-TEMPLATES: Zahlungsvorlagen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/payment-templates/{document} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update, delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }
    
    // PRIVATE-CONTACTS: Private Kontakte
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/private-contacts/{document} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update, delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }

    // PRIVATE-ACCOUNTS: Private Konten
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/private-accounts/{document} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update, delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }
    
    // PAYMENT-CATEGORIES: Zahlungskategorien
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/payment-categories/{category} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update, delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }

    // ═══════════════════════════════════════════════════════════════
    // TICKET SUPPORT (Ticket Support System)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/tickets/{ticketId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // WERTGUTHABEN (Gift Cards & Vouchers Management)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/wertguthaben/{wertguthabenId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
      
      match /transaktionen/{transaktionId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // VERTRAGSVERWALTUNG (Contract Management)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/vertraege/{vertragId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/vertraege_themen/{themaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();

      match /vertraege/{vertragId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }

      match /kategorien/{kategorieId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/vertraege_einladungen/{einladungId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // REZEPTVERWALTUNG (Recipe Management)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/rezepte/{rezeptId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // HAUSHALTSZAHLUNGEN (Household Payments Management)
    // ═══════════════════════════════════════════════════════════════

    // Legacy: Alte Haushaltszahlungen Collection (KANN GELÖSCHT WERDEN wenn keine Daten mehr drin sind)
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/haushaltszahlungen/{eintragId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Themen für Haushaltszahlungen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/haushaltszahlungen_themen/{themaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
      
      // WICHTIG: Einträge als Sub-Collection unter Themen
      match /eintraege/{eintragId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
    }

    // Änderungsprotokoll für Haushaltszahlungen (Daueraufträge)
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/haushaltszahlungen_protokoll/{protokollId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Einladungen für Haushaltszahlungen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/haushaltszahlungen_einladungen/{einladungId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // GESCHENKEMANAGEMENT (Gift Management)
    // ═══════════════════════════════════════════════════════════════

    // User-spezifische Daten (Pfad wird im Frontend über currentUser.mode gebaut)
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/users/{userId} {
      allow read, write: if isAuthenticated();

      match /geschenke_kontakte/{docId} {
        allow read, write: if isAuthenticated();
      }

      match /geschenke_themen/{themaId} {
        allow read, write: if isAuthenticated();

        // Geschenke liegen als Sub-Collection unter Themen
        match /geschenke/{geschenkId} {
          allow read, write: if isAuthenticated();
        }
      }

      match /geschenke_vorlagen/{docId} {
        allow read, write: if isAuthenticated();
      }

      match /geschenke_budgets/{docId} {
        allow read, write: if isAuthenticated();
      }

      match /geschenke_erinnerungen/{docId} {
        allow read, write: if isAuthenticated();
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // NACHRICHTENCENTER (Adressbuch)
    // ═══════════════════════════════════════════════════════════════

    // WICHTIG: Für private Daten wird ein stabiles appUserId Custom-Claim benötigt.
    // Erwartet: request.auth.token.appUserId

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/nachrichtencenter_global_contacts/{contactId} {
      allow read: if isAuthenticated();
      allow create: if isSystemAdminClaim() || (isAuthenticated() && request.auth.token.appUserId == request.resource.data.createdByAppUserId);
      allow update, delete: if isSystemAdminClaim() || (isAuthenticated() && request.auth.token.appUserId == resource.data.createdByAppUserId);
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/nachrichtencenter_private_contacts/{userId}/contacts/{contactId} {
      allow read, write: if isSystemAdminClaim() || (isAuthenticated() && request.auth.token.appUserId == userId);
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/pushover_programs/{recipientId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/pushover_grants_by_sender/{senderId}/recipients/{recipientId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/pushover_grants_by_recipient/{recipientId}/senders/{senderId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // DEFAULT DENY (Alles andere verbieten)
    // ═══════════════════════════════════════════════════════════════
    
    match /{path=**} {
      allow read, write: if false;
    }
  }
}

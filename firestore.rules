rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS (Hilfsfunktionen) 
    // ═══════════════════════════════════════════════════════════════
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function hasAppRole(roleName) {
      return isAuthenticated() && request.auth.token != null && request.auth.token.appRole == roleName;
    }
    
    function isAdminOrSystemAdminClaim() {
      return hasAppRole('ADMIN') || hasAppRole('SYSTEMADMIN');
    }
    
    function isSystemAdminClaim() {
      return hasAppRole('SYSTEMADMIN');
    }

    function hasAppUserIdClaim() {
      return isAuthenticated() && request.auth.token != null && request.auth.token.appUserId != null;
    }

    function appUserId() {
      return request.auth.token.appUserId;
    }

    function isSelfAppUser(userId) {
      return hasAppUserIdClaim() && appUserId() == userId;
    }

    function isUserConfigKeyUnchanged() {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['key']);
    }

    function currentUserConfig() {
      return get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/public/data/user-config/$(appUserId())).data;
    }

    function adminRoleHasPermission(roleId, permKey) {
      let rolePerms = get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/public/data/admin-roles/$(roleId)).data.permissions;
      return (permKey in rolePerms) && rolePerms[permKey] == true;
    }

    function adminHasPermission(permKey) {
      let u = currentUserConfig();

      // Admins sind über Custom Claim abgesichert
      let isAdminClaim = hasAppRole('ADMIN');

      // Default: wenn adminPermissionType fehlt, behandeln wir es als 'role'
      let permType = ('adminPermissionType' in u) ? u.adminPermissionType : 'role';

      // 1) Individuelle Admin-Rechte
      let hasIndividualPerm = ('adminPermissions' in u) && (permKey in u.adminPermissions) && u.adminPermissions[permKey] == true;

      // 2) Rollen-basierte Admin-Rechte
      let hasRolePerm = ('assignedAdminRoleId' in u) && u.assignedAdminRoleId != null && adminRoleHasPermission(u.assignedAdminRoleId, permKey);

      return isAdminClaim && ((permType == 'individual') ? hasIndividualPerm : hasRolePerm);
    }

    // ═══════════════════════════════════════════════════════════════
    // BENUTZERVERWALTUNG (User Management)
    // ═══════════════════════════════════════════════════════════════
    
    // USER-CONFIG: Benutzerprofile
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/user-config/{userId} {
      allow read: if isAuthenticated();
      allow create: if isSystemAdminClaim() && !('key' in request.resource.data);
      allow delete: if isSystemAdminClaim();
      allow update: if (isAdminOrSystemAdminClaim() || isSelfAppUser(userId)) && isUserConfigKeyUnchanged();
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/private/secrets/{path=**} {
      allow read, write: if false;
    }

    // USER-ROLES: Definitionen der Standard-Rollen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/user-roles/{roleId} {
      allow read: if true;
      allow write: if isSystemAdminClaim();
    }

    // ADMIN-ROLES: Definitionen der Admin-Rollen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/admin-roles/{roleId} {
      allow read: if true;
      allow write: if isSystemAdminClaim();
    }

    // ═══════════════════════════════════════════════════════════════
    // SYSTEM & ADMIN (System & Administration)
    // ═══════════════════════════════════════════════════════════════
    
    // APP-SETTINGS: Anwendungseinstellungen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/app-settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrSystemAdminClaim();
    }

    // AUDIT-LOG: Aktivitätsprotokoll
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/audit-log/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdminOrSystemAdminClaim();
    }

    // ROLE-CHANGE-REQUESTS: Rollenänderungsanfragen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/role-change-requests/{requestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isSystemAdminClaim();
    }

    // APPROVAL-REQUESTS: Genehmigungsanfragen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/approval-requests/{requestId} {
      allow read: if isSystemAdminClaim() || (hasAppUserIdClaim() && appUserId() == resource.data.requestedById);
      allow create: if hasAppUserIdClaim() && request.resource.data.requestedById == appUserId() && request.resource.data.status == 'pending';
      allow update: if isSystemAdminClaim() || (
        hasAppUserIdClaim() &&
        appUserId() == resource.data.requestedById &&
        resource.data.status == 'pending' &&
        request.resource.data.status == 'withdrawn' &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'actionTakenByName'])
      );
      allow delete: if isSystemAdminClaim();
    }

    // SETTINGS: Modulspezifische Einstellungen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // CHECKLISTEN-SYSTEM (Checklist System)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklists/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-items/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-groups/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-categories/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-stacks/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-templates/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/checklist-templates/{templateId}/template-items/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // TERMINPLANER (Appointment Scheduler)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/votes/{voteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // ZAHLUNGSVERWALTUNG (Payment Management)
    // ═══════════════════════════════════════════════════════════════
    
    // PAYMENTS: Zahlungen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/payments/{paymentId} {
      allow read: if isSystemAdminClaim() || adminHasPermission('canDeleteUser') || adminHasPermission('canRenameUser') || (hasAppUserIdClaim() && resource.data.involvedUserIds.hasAny([appUserId()]));
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId() && request.resource.data.involvedUserIds.hasAny([appUserId()]);
      allow update: if hasAppUserIdClaim() && resource.data.involvedUserIds.hasAny([appUserId()]);
      allow delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }
    
    // PAYMENT-TEMPLATES: Zahlungsvorlagen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/payment-templates/{document} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update, delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }
    
    // PRIVATE-CONTACTS: Private Kontakte
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/private-contacts/{document} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update, delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }

    // PRIVATE-ACCOUNTS: Private Konten
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/private-accounts/{document} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update, delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }
    
    // PAYMENT-CATEGORIES: Zahlungskategorien
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/payment-categories/{category} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update, delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }

    // ═══════════════════════════════════════════════════════════════
    // TICKET SUPPORT (Ticket Support System)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/tickets/{ticketId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // WERTGUTHABEN (Gift Cards & Vouchers Management)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/wertguthaben/{wertguthabenId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
      
      match /transaktionen/{transaktionId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/lizenzen/{lizenzId} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update: if hasAppUserIdClaim() && resource.data.createdBy == appUserId() && request.resource.data.createdBy == appUserId();
      allow delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/lizenzen_kategorien/{kategorieId} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update: if hasAppUserIdClaim() && resource.data.createdBy == appUserId() && request.resource.data.createdBy == appUserId();
      allow delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/lizenzen_produkte/{produktId} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update: if hasAppUserIdClaim() && resource.data.createdBy == appUserId() && request.resource.data.createdBy == appUserId();
      allow delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }

    // ═══════════════════════════════════════════════════════════════
    // VERTRAGSVERWALTUNG (Contract Management)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/vertraege/{vertragId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/vertraege_themen/{themaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();

      match /vertraege/{vertragId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }

      match /kategorien/{kategorieId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/vertraege_einladungen/{einladungId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // REZEPTVERWALTUNG (Recipe Management)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/rezepte/{rezeptId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // HAUSHALTSZAHLUNGEN (Household Payments Management)
    // ═══════════════════════════════════════════════════════════════

    // Legacy: Alte Haushaltszahlungen Collection (KANN GELÖSCHT WERDEN wenn keine Daten mehr drin sind)
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/haushaltszahlungen/{eintragId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Themen für Haushaltszahlungen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/haushaltszahlungen_themen/{themaId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
      
      // WICHTIG: Einträge als Sub-Collection unter Themen
      match /eintraege/{eintragId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
    }

    // Änderungsprotokoll für Haushaltszahlungen (Daueraufträge)
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/haushaltszahlungen_protokoll/{protokollId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Einladungen für Haushaltszahlungen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/haushaltszahlungen_einladungen/{einladungId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // SENDUNGSVERWALTUNG (Package & Shipment Management)
    // ═══════════════════════════════════════════════════════════════
    
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/sendungen/{sendungId} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update: if hasAppUserIdClaim() && resource.data.createdBy == appUserId() && request.resource.data.createdBy == appUserId();
      allow delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/sendungen_anbieter/{anbieterId} {
      allow read: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
      allow create: if hasAppUserIdClaim() && request.resource.data.createdBy == appUserId();
      allow update: if hasAppUserIdClaim() && resource.data.createdBy == appUserId() && request.resource.data.createdBy == appUserId();
      allow delete: if hasAppUserIdClaim() && resource.data.createdBy == appUserId();
    }

    // ═══════════════════════════════════════════════════════════════
    // GESCHENKEMANAGEMENT (Gift Management)
    // ═══════════════════════════════════════════════════════════════

    // User-spezifische Daten (Pfad wird im Frontend über currentUser.mode gebaut)
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/users/{userId} {
      allow read, write: if isAuthenticated();

      match /geschenke_kontakte/{docId} {
        allow read, write: if isAuthenticated();
      }

      match /geschenke_themen/{themaId} {
        allow read, write: if isAuthenticated();

        // Geschenke liegen als Sub-Collection unter Themen
        match /geschenke/{geschenkId} {
          allow read, write: if isAuthenticated();
        }
      }

      match /geschenke_vorlagen/{docId} {
        allow read, write: if isAuthenticated();
      }

      match /geschenke_budgets/{docId} {
        allow read, write: if isAuthenticated();
      }

      match /geschenke_erinnerungen/{docId} {
        allow read, write: if isAuthenticated();
      }
    }

    // ═══════════════════════════════════════════════════════════════
    // NACHRICHTENCENTER (Adressbuch)
    // ═══════════════════════════════════════════════════════════════

    // WICHTIG: Für private Daten wird ein stabiles appUserId Custom-Claim benötigt.
    // Erwartet: request.auth.token.appUserId

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/nachrichtencenter_global_contacts/{contactId} {
      allow read: if isAuthenticated();
      allow create: if isSystemAdminClaim() || (isAuthenticated() && request.auth.token.appUserId == request.resource.data.createdByAppUserId);
      allow update, delete: if isSystemAdminClaim() || (isAuthenticated() && request.auth.token.appUserId == resource.data.createdByAppUserId);
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/nachrichtencenter_private_contacts/{userId}/contacts/{contactId} {
      allow read, write: if isSystemAdminClaim() || (isAuthenticated() && request.auth.token.appUserId == userId);
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/pushover_programs/{recipientId} {
      allow read: if isSystemAdminClaim() || (
        hasAppUserIdClaim() && (
          appUserId() == recipientId ||
          exists(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/public/data/pushover_grants_by_sender/$(appUserId())/recipients/$(recipientId))
        )
      );
      allow write: if isSystemAdminClaim() || (hasAppUserIdClaim() && appUserId() == recipientId);
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/pushover_grants_by_sender/{senderId}/recipients/{recipientId} {
      allow read: if isSystemAdminClaim() || (hasAppUserIdClaim() && (appUserId() == senderId || appUserId() == recipientId));
      allow write: if isSystemAdminClaim() || (hasAppUserIdClaim() && appUserId() == recipientId);
    }

    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/pushover_grants_by_recipient/{recipientId}/senders/{senderId} {
      allow read: if isSystemAdminClaim() || (hasAppUserIdClaim() && (appUserId() == recipientId || appUserId() == senderId));
      allow write: if isSystemAdminClaim() || (hasAppUserIdClaim() && appUserId() == recipientId);
    }

    // Pushover User-Key Änderungsanfragen
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/pushover_userkey_change_requests/{requestId} {
      allow read: if isSystemAdminClaim() || (hasAppRole('ADMIN') && adminHasPermission('canUseMainPushoverConfig'));
      allow create: if hasAppUserIdClaim() && request.resource.data.userId == appUserId() && request.resource.data.status == 'pending';
      allow delete: if isSystemAdminClaim() || (hasAppRole('ADMIN') && adminHasPermission('canUseMainPushoverConfig'));
    }

    // ═══════════════════════════════════════════════════════════════
    // PUSHMAIL-CENTER BENACHRICHTIGUNGEN (Notification System)
    // ═══════════════════════════════════════════════════════════════
    
    // Pushmail-Einstellungen (pro Benutzer)
    match /artifacts/20LVob88b3ovXRUyX3ra/users/{userId}/settings/{settingId} {
      allow read, write: if isAuthenticated();
    }
    
    // Ausstehende Benachrichtigungen (pro Benutzer)
    match /artifacts/20LVob88b3ovXRUyX3ra/users/{userId}/pushmail_notifications/{notificationId} {
      allow read, write: if isAuthenticated();
    }
    
    // Quittierte Benachrichtigungen (Archiv, pro Benutzer)
    match /artifacts/20LVob88b3ovXRUyX3ra/users/{userId}/pushmail_acknowledged_notifications/{notificationId} {
      allow read, write: if isAuthenticated();
    }

    // ═══════════════════════════════════════════════════════════════
    // NOTIZEN-PROGRAMM (Notes Management with Sharing)
    // ═══════════════════════════════════════════════════════════════

    // Notizen-Kategorien (user-spezifisch)
    match /artifacts/20LVob88b3ovXRUyX3ra/users/{userId}/notizen_kategorien/{kategorieId} {
      allow read: if hasAppUserIdClaim() && (
        appUserId() == userId ||
        (
          resource.data.sharedWith != null &&
          appUserId() in resource.data.sharedWith &&
          resource.data.sharedWith[appUserId()].status == 'active'
        )
      );
      allow create: if hasAppUserIdClaim() && appUserId() == userId && request.resource.data.createdBy == userId;
      allow update: if hasAppUserIdClaim() && (
        appUserId() == userId ||
        (
          resource.data.sharedWith != null &&
          appUserId() in resource.data.sharedWith &&
          resource.data.sharedWith[appUserId()].status == 'active' &&
          resource.data.sharedWith[appUserId()].role == 'write'
        ) ||
        (
          // Shared User darf nur seinen eigenen sharedWith-Eintrag ändern (status ändern oder entfernen)
          resource.data.sharedWith != null &&
          appUserId() in resource.data.sharedWith &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['sharedWith']) &&
          request.resource.data.sharedWith.diff(resource.data.sharedWith).affectedKeys().hasOnly([appUserId()]) &&
          (
            // Entfernen (Teilen beenden)
            !(appUserId() in request.resource.data.sharedWith) ||
            (
              // Nur status-Änderung erlaubt, andere Felder müssen gleich bleiben
              request.resource.data.sharedWith[appUserId()].role == resource.data.sharedWith[appUserId()].role &&
              request.resource.data.sharedWith[appUserId()].since == resource.data.sharedWith[appUserId()].since &&
              request.resource.data.sharedWith[appUserId()].sharedBy == resource.data.sharedWith[appUserId()].sharedBy &&
              request.resource.data.sharedWith[appUserId()].status in ['pending', 'active', 'rejected']
            )
          )
        )
      );
      allow delete: if hasAppUserIdClaim() && appUserId() == userId;

      // Subkategorien als Sub-Collection
      match /subkategorien/{subkategorieId} {
        allow read: if hasAppUserIdClaim() && (
          appUserId() == userId ||
          (
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith != null &&
            appUserId() in get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith &&
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith[appUserId()].status == 'active'
          )
        );
        allow create: if hasAppUserIdClaim() && (
          (appUserId() == userId && request.resource.data.createdBy == userId) ||
          (
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith != null &&
            appUserId() in get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith &&
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith[appUserId()].status == 'active' &&
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith[appUserId()].role == 'write' &&
            request.resource.data.createdBy == appUserId()
          )
        );
        allow update: if hasAppUserIdClaim() && (
          appUserId() == userId ||
          (
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith != null &&
            appUserId() in get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith &&
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith[appUserId()].status == 'active' &&
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen_kategorien/$(kategorieId)).data.sharedWith[appUserId()].role == 'write'
          )
        );
        allow delete: if hasAppUserIdClaim() && appUserId() == userId;
      }
    }

    // Notizen (user-spezifisch mit Sharing-Logik)
    match /artifacts/20LVob88b3ovXRUyX3ra/users/{userId}/notizen/{notizId} {
      // Lesen: Owner oder User mit read/write permission in sharedWith
      allow read: if hasAppUserIdClaim() && (
        appUserId() == userId || 
        (
          resource.data.sharedWith != null &&
          appUserId() in resource.data.sharedWith &&
          resource.data.sharedWith[appUserId()].status == 'active'
        )
      );
      
      // Erstellen: Nur Owner
      allow create: if hasAppUserIdClaim() && appUserId() == userId && request.resource.data.owner == userId;
      
      // Update: Owner oder User mit write permission
      allow update: if hasAppUserIdClaim() && (
        appUserId() == userId || 
        (
          resource.data.sharedWith != null &&
          appUserId() in resource.data.sharedWith &&
          resource.data.sharedWith[appUserId()].status == 'active' &&
          resource.data.sharedWith[appUserId()].role == 'write'
        ) ||
        (
          // Shared User darf nur seinen eigenen sharedWith-Eintrag ändern (status ändern oder entfernen)
          resource.data.sharedWith != null &&
          appUserId() in resource.data.sharedWith &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['sharedWith']) &&
          request.resource.data.sharedWith.diff(resource.data.sharedWith).affectedKeys().hasOnly([appUserId()]) &&
          (
            // Entfernen (Teilen beenden)
            !(appUserId() in request.resource.data.sharedWith) ||
            (
              // Nur status-Änderung erlaubt, andere Felder müssen gleich bleiben
              request.resource.data.sharedWith[appUserId()].role == resource.data.sharedWith[appUserId()].role &&
              request.resource.data.sharedWith[appUserId()].since == resource.data.sharedWith[appUserId()].since &&
              request.resource.data.sharedWith[appUserId()].sharedBy == resource.data.sharedWith[appUserId()].sharedBy &&
              request.resource.data.sharedWith[appUserId()].status in ['pending', 'active', 'rejected']
            )
          )
        )
      );
      
      // Löschen: Nur Owner
      allow delete: if hasAppUserIdClaim() && appUserId() == userId;

      // History als Sub-Collection
      match /history/{historyId} {
        allow read: if hasAppUserIdClaim() && (
          appUserId() == userId || 
          (
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen/$(notizId)).data.sharedWith != null && 
            appUserId() in get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen/$(notizId)).data.sharedWith &&
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen/$(notizId)).data.sharedWith[appUserId()].status == 'active'
          )
        );
        allow create: if hasAppUserIdClaim() && (
          appUserId() == userId || 
          (
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen/$(notizId)).data.sharedWith != null && 
            appUserId() in get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen/$(notizId)).data.sharedWith &&
            get(/databases/$(database)/documents/artifacts/20LVob88b3ovXRUyX3ra/users/$(userId)/notizen/$(notizId)).data.sharedWith[appUserId()].status == 'active'
          )
        );
        allow delete: if hasAppUserIdClaim() && appUserId() == userId;
      }
    }

    // Notizen-Einladungen (public für alle User sichtbar)
    match /artifacts/20LVob88b3ovXRUyX3ra/public/data/notizen_einladungen/{einladungId} {
      // Lesen: Sender oder Empfänger
      allow read: if hasAppUserIdClaim() && (
        appUserId() == resource.data.fromUserId || 
        appUserId() == resource.data.toUserId
      );
      
      // Erstellen: Als fromUserId
      allow create: if hasAppUserIdClaim() && request.resource.data.fromUserId == appUserId() && request.resource.data.status == 'pending';
      
      // Update: Empfänger kann annehmen/ablehnen, Sender kann abbrechen
      allow update: if hasAppUserIdClaim() && (
        // Empfänger: annehmen/ablehnen/revoken
        (appUserId() == resource.data.toUserId && (
          (
            resource.data.status == 'pending' &&
            (request.resource.data.status == 'accepted' || request.resource.data.status == 'rejected')
          ) ||
          (
            resource.data.status == 'rejected' &&
            request.resource.data.status == 'revoked'
          )
        ) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'respondedAt', 'updatedAt'])) ||
        // Sender: abbrechen (pending oder accepted -> cancelled)
        (appUserId() == resource.data.fromUserId && 
          (resource.data.status == 'pending' || resource.data.status == 'accepted') &&
          request.resource.data.status == 'cancelled' &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt'])
        )
      );
      
      // Löschen: Sender oder SYSTEMADMIN
      allow delete: if isSystemAdminClaim() || (hasAppUserIdClaim() && appUserId() == resource.data.fromUserId);
    }

    // ═══════════════════════════════════════════════════════════════
    // DEFAULT DENY (Alles andere verbieten)
    // ═══════════════════════════════════════════════════════════════
    
    match /{path=**} {
      allow read, write: if false;
    }
  }
}

<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOP 2 Smart Home</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="TOP 2 App">
    <meta name="apple-mobile-web-app-title" content="TOP 2">
    <meta name="theme-color" content="#4f46e5" />
    <meta name="msapplication-navbutton-color" content="#4f46e5">
    <meta name="apple-mobile-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" sizes="192x192" href="https://placehold.co/192x192/4f46e5/ffffff?text=T2">
    <link rel="apple-touch-icon" type="image/png" sizes="192x192"
        href="https://placehold.co/192x192/4f46e5/ffffff?text=T2">

    <link rel="manifest" href="app.webmanifest">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            /* Wichtig: Wir entfernen hier alle Flexbox- und Höhen-Eigenschaften,
               damit der Browser "Pull-to-Refresh" wieder uneingeschränkt erlaubt. */
        }

        .app-container {
            /* === START: DIE ENTSCHEIDENDE ÄNDERUNG === */
            /* Wir nehmen den Container aus dem normalen Fluss und nageln ihn
               an den Bildschirmrändern fest. */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: 0 auto;
            /* Zentriert den Container, falls der Bildschirm breiter ist */
            /* === ENDE: DIE ENTSCHEIDENDE ÄNDERUNG === */

            width: 100%;
            max-width: 640px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: white;

            /* Die innere Flexbox-Struktur bleibt erhalten */
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex-grow: 1;
            /* Füllt den verfügbaren Platz zwischen Header und Footer */
            overflow-y: auto;
            /* Erlaubt NUR diesem Bereich zu scrollen */
            min-height: 0;
            /* Ein wichtiger Flexbox-Fix, der das Schrumpfen erlaubt */
            padding: 1rem;
            box-sizing: border-box;
            background-color: #f7f7f9;
        }

        .card {
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 1.25rem;
            height: 1.25rem;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .view {
            display: none;
            flex-direction: column;
            gap: 1rem;
        }

        .view.active {
            display: flex;
        }

        .user-active-toggle:checked~.dot {
            transform: translateX(100%);
            background-color: #ef4444;
            /* Rot */
        }

        .user-active-toggle:checked~.block {
            background-color: #fca5a5;
            /* Hellrot */
        }
    </style>
</head>

<body>

    <div class="app-container">

        <header id="appHeader"
            class="flex-shrink-0 bg-gradient-to-r from-indigo-600 to-cyan-500 text-white border-b border-indigo-700 p-4 flex justify-center items-center shadow-md cursor-pointer">
            <h1 id="headerTitle" class="text-xl font-bold tracking-wider whitespace-nowrap px-2">TOP 2 - Markus <span
                    class="text-red-300">❤️</span> Jasmin</h1>
        </header>

        <main class="main-content space-y-4">

            <div id="homeView" class="view active">

                <div id="homeActionButtons" class="flex justify-end mb-6 gap-2">
                    <button id="mainSettingsButton"
                        class="bg-gray-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-lg hover:bg-gray-700 transition hidden z-10">
                        Einstellungen
                    </button>
                    <button id="mainAdminButton"
                        class="bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-lg hover:bg-red-700 transition hidden z-10">
                        ADMIN
                    </button>
                </div>
                <div id="guestPrompt"
                    class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg hidden">
                    <p class="font-bold">Anmeldung erforderlich</p>
                    <p>Bitte melden Sie sich über den Modus-Bereich unten an, um die Steuerung zu verwenden.</p>
                </div>

                <div id="noPermissionPrompt"
                    class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg hidden">
                    <p class="font-bold">Keine Berechtigung</p>
                    <p>Ihrem Konto wurden keine Berechtigungen zugewiesen. Bitte kontaktieren Sie einen Administrator.
                    </p>
                </div>

                <div id="pushCard" data-permission="PUSHOVER"
                    class="card bg-white p-4 rounded-xl shadow-lg flex items-center space-x-4 w-full border-t-4 border-red-500 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                        class="w-10 h-10 text-red-500 flex-shrink-0">
                        <path fill-rule="evenodd"
                            d="M1.5 6a2.25 2.25 0 0 1 2.25-2.25h16.5A2.25 2.25 0 0 1 22.5 6v12a2.25 2.25 0 0 1-2.25-2.25H3.75A2.25 2.25 0 0 1 1.5 18V6ZM3 17.069v-5.814l4.138 3.551a.75.75 0 0 0 .972-.06l6.26-5.408 4.793 4.116-.167 4.567A.75.75 0 0 0 21 18H3a.75.75 0 0 0-.75.75v-1.681ZM21 6a.75.75 0 0 0-.75-.75H3.75a.75.75 0 0 0-.75.75v.524l8.36 7.199c.07.06.15.1.24.1s.17.04.24.1l8.37-7.21V6Z"
                            clip-rule="evenodd" />
                    </svg>
                    <div class="flex w-full items-center">
                        <div id="pushoverButton" class="flex-grow cursor-pointer pr-4">
                            <span class="text-xl font-bold text-red-500 block">Push-Benachrichtigung</span>
                            <span class="text-sm text-gray-500">Pushover Notifikationen senden.</span>
                        </div>
                        <div id="notrufSettingsButton"
                            class="flex-shrink-0 pl-4 ml-4 border-l border-gray-200 text-right cursor-pointer">
                            <span class="text-xl font-bold text-red-700 block">NOTRUF</span>
                            <span class="text-sm text-gray-500">Einstellungen</span>
                        </div>
                    </div>
                </div>
                <div id="entranceCard" data-permission="ENTRANCE"
                    class="card bg-white p-4 rounded-xl shadow-lg flex items-center space-x-4 hover:shadow-xl transition duration-200 cursor-pointer w-full border-t-4 border-indigo-500 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="w-10 h-10 text-indigo-500 flex-shrink-0">
                        <rect x="4" y="4" width="16" height="18" rx="2" ry="2" />
                        <path d="M12 4h4" />
                        <path d="M14 13h.01" />
                    </svg>
                    <div>
                        <span class="text-xl font-bold text-indigo-500 block">Haupteingang öffnen</span>
                        <span class="text-sm text-gray-500">Steuern Sie den Zugang zum Haupteingang.</span>
                    </div>
                </div>
                <div data-permission="CHECKLIST"
                    class="card bg-white rounded-xl shadow-lg w-full border-t-4 border-green-500 hidden">
                    <div class="p-4 flex items-center space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                            class="w-10 h-10 text-green-500 flex-shrink-0">
                            <path fill-rule="evenodd"
                                d="M19.5 21a3 3 0 0 0 3-3V6a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h15Zm-11.02-7.22L6.9 12.2c-.39-.39-1.02-.39-1.41 0a.996.996 0 0 0 0 1.41l2.38 2.38c.39.39 1.02.39 1.41 0l5.88-5.88a.996.996 0 1 0-1.41-1.41l-5.13 5.13Z"
                                clip-rule="evenodd" />
                        </svg>
                        <span class="text-xl font-bold text-green-500">Checkliste</span>
                    </div>
                    <div class="bg-gray-50 p-2 grid grid-cols-2 gap-2 rounded-b-xl border-t">
                        <div id="currentChecklistCard"
                            class="p-3 text-center rounded-lg hover:bg-green-100 cursor-pointer">
                            <span class="font-semibold text-green-800">Aktuelle Checkliste</span>
                            <span id="current-checklist-name-display"
                                class="text-sm font-bold text-gray-600 mt-1 block"></span>
                        </div>
                        <div id="checklistSettingsCard"
                            class="p-3 text-center rounded-lg hover:bg-gray-200 cursor-pointer flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                class="w-5 h-5 text-gray-600">
                                <path fill-rule="evenodd"
                                    d="M11.078 2.25c-.217 0-.424.034-.622.098l-6.07 1.916a.75.75 0 0 0-.58 1.154l4.335 6.191a.75.75 0 0 0 1.155-.582V4.243a.75.75 0 0 0-.413-.673l-1.38-.771a.75.75 0 0 0-.53-.162Zm-.022 8.355a.75.75 0 0 0-1.155.582v4.664l1.12.352a.75.75 0 0 0 .814-.431l1.632-3.263a.75.75 0 0 0-.25-1.022l-1.751-1.066Z"
                                    clip-rule="evenodd" />
                                <path
                                    d="M12.562 2.02a.75.75 0 0 1 .638.51l3.5 7a.75.75 0 0 1-.51.983l-7 3.5a.75.75 0 0 1-.983-.51l-3.5-7a.75.75 0 0 1 .51-.983l7-3.5a.75.75 0 0 1 .345-.083Zm-2.286 1.044-6.323 3.162 3.162 6.323 6.323-3.162-3.162-6.323Z" />
                            </svg>
                            <span class="font-semibold text-gray-700">Einstellungen</span>
                        </div>
                    </div>
                </div>
                <div id="essensberechnungCard" data-permission="ESSENSBERECHNUNG"
                    class="card bg-white p-4 rounded-xl shadow-lg flex items-center space-x-4 hover:shadow-xl transition duration-200 cursor-pointer w-full border-t-4 border-orange-500 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"
                        class="w-10 h-10 text-orange-500 flex-shrink-0">
                        <path
                            d="M12.75 1.5a.75.75 0 0 0-1.5 0v5.333A3.375 3.375 0 0 0 8.333 10H3a.75.75 0 0 0 0 1.5h5.333a3.375 3.375 0 0 0 2.917 3.167V22.5a.75.75 0 0 0 1.5 0v-7.833A3.375 3.375 0 0 0 15.667 11.5h5.333a.75.75 0 0 0 0-1.5h-5.333a3.375 3.375 0 0 0-2.917-3.167V1.5Z" />
                        <path
                            d="M14.013 7.857a24.417 24.417 0 0 0-4.025 0 .75.75 0 0 0 0 1.486 22.918 22.918 0 0 1 4.025 0 .75.75 0 0 0 0-1.486Z" />
                    </svg>
                    <div>
                        <span class="text-xl font-bold text-orange-500 block">Essensberechnung</span>
                        <span class="text-sm text-gray-500">Mahlzeiten abwiegen und Portionen berechnen.</span>
                    </div>
                </div>

            </div>




            <div id="adminView" class="view">
                <div class="back-link-container w-full mb-2">
                    <button class="back-link flex items-center text-gray-600 hover:text-indigo-600 transition"
                        data-target="home">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                            class="w-5 h-5 mr-1">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        <span class="text-sm font-semibold">zurück</span>
                    </button>
                    <div class="border-t border-gray-300 mt-2"></div>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Einstellungen</h2>

                <div id="noAdminPermissionsPrompt"
                    class="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 rounded-lg hidden">
                    <p class="font-bold">Keine Berechtigungen</p>
                    <p>Für Ihr Admin-Konto sind keine Verwaltungs-Module freigeschaltet. Bitte kontaktieren Sie einen
                        Systemadministrator.</p>
                </div>

                <div id="adminRightsSection" class="hidden">
                    <div id="adminRightsToggle"
                        class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-yellow-500 cursor-pointer hover:shadow-xl transition duration-200">
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-gray-800">ADMIN - Rechteverwaltung</span>
                            <svg id="adminRightsToggleIcon" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"
                                class="w-6 h-6 transform transition-transform">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                            </svg>
                        </div>
                    </div>
                    <div id="adminRightsArea" class="bg-white rounded-xl shadow-lg mt-2 p-4 hidden flex-col gap-4">
                    </div>
                </div>

                <div id="roleManagementSection" class="hidden">
                    <div id="roleSettingsToggle"
                        class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-purple-500 cursor-pointer hover:shadow-xl transition duration-200">
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-gray-800">Rollenverwaltung</span>
                            <svg id="roleToggleIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke-width="2.5" stroke="currentColor" class="w-6 h-6 transform transition-transform">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                            </svg>
                        </div>
                    </div>
                    <div id="roleManagementArea" class="bg-white rounded-xl shadow-lg mt-2 p-4 hidden flex-col gap-4">
                    </div>
                </div>

                <div id="passwordSection">
                    <div id="passwordSettingsToggle"
                        class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-red-500 cursor-pointer hover:shadow-xl transition duration-200">
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-gray-800">Passwörter</span>
                            <svg id="passwordToggleIcon" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"
                                class="w-6 h-6 transform transition-transform">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                            </svg>
                        </div>
                    </div>
                    <div id="passwordManagementArea"
                        class="bg-white rounded-xl shadow-lg mt-2 p-4 hidden flex-col gap-4">
                        <div id="userKeyList" class="space-y-4"></div>
                    </div>
                </div>

                <div id="userSection">
                    <div id="userManagementToggle"
                        class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-blue-500 cursor-pointer hover:shadow-xl transition duration-200">
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-gray-800">Benutzersteuerung</span>
                            <svg id="userManagementToggleIcon" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"
                                class="w-6 h-6 transform transition-transform">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                            </svg>
                        </div>
                    </div>
                    <div id="userManagementArea" class="bg-white rounded-xl shadow-lg mt-2 p-4 hidden flex-col gap-4">
                    </div>
                </div>
                <div id="mainFunctionsSection">
                    <div id="mainFunctionsToggle"
                        class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-cyan-500 cursor-pointer hover:shadow-xl transition duration-200">
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-gray-800">Adminfunktionen Hauptseite</span>
                            <svg id="mainFunctionsToggleIcon" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"
                                class="w-6 h-6 transform transition-transform">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                            </svg>
                        </div>
                    </div>


                    <div id="mainFunctionsArea" class="bg-white rounded-xl shadow-lg mt-2 p-4 hidden flex-col gap-4">
                        <div class="mb-4">
                            <h3 class="text-sm font-semibold text-gray-500 mb-1 px-1">Funktion auswählen</h3>
                            <div id="main-functions-tabs"
                                class="grid grid-cols-3 gap-1 border rounded-lg bg-gray-100 p-1">
                                <button data-target-card="card-main-push"
                                    class="settings-tab-btn p-2 text-sm font-semibold rounded-md text-gray-600">Push</button>
                                <button data-target-card="card-main-entrance"
                                    class="settings-tab-btn p-2 text-sm font-semibold rounded-md text-gray-600">Eingang</button>
                                <button data-target-card="card-main-checklist"
                                    class="settings-tab-btn p-2 text-sm font-semibold rounded-md text-gray-600">Checkliste</button>
                            </div>
                        </div>

                        <div id="main-functions-content-area" class="space-y-4">

                            <div id="main-functions-prompt" class="text-center p-4 bg-gray-50 rounded-lg">
                                <p class="font-semibold text-gray-600">Bitte wählen Sie oben eine Funktion aus, um sie
                                    anzuzeigen.</p>
                            </div>

                            <div id="card-main-push" class="main-functions-card hidden">
                                <div class="p-4 bg-gray-50 rounded-lg text-center">
                                    <p class="font-semibold text-gray-600">Hier gibt es aktuell keinen Inhalt.</p>
                                    <p class="text-sm text-gray-500 mt-1">Die Funktion befindet sich auf der Hauptseite.
                                    </p>
                                </div>
                            </div>
                            <div id="card-main-entrance" class="main-functions-card hidden">
                                <div class="p-4 bg-gray-50 rounded-lg text-center">
                                    <p class="font-semibold text-gray-600">Hier gibt es aktuell keinen Inhalt.</p>
                                    <p class="text-sm text-gray-500 mt-1">Die Funktion befindet sich auf der Hauptseite.
                                    </p>
                                </div>
                            </div>
                            <div id="card-main-checklist" class="main-functions-card hidden">
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <button id="permanently-delete-items-btn"
                                        class="w-full py-2 px-4 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 transition flex items-center justify-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                            class="w-5 h-5">
                                            <path fill-rule="evenodd"
                                                d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193v-.443A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                        Papierkorb endgültig leeren
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="approvalProcessSection">
                    <div id="approvalProcessToggle"
                        class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-green-500 cursor-pointer hover:shadow-xl transition duration-200">
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-gray-800">Genehmigungsprozess</span>
                            <svg id="approvalToggleIcon" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"
                                class="w-6 h-6 transform transition-transform">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                            </svg>
                        </div>
                    </div>
                    <div id="approvalProcessArea" class="bg-white rounded-xl shadow-lg mt-2 p-4 hidden flex-col gap-4">
                    </div>
                </div>

                <div id="protocolHistorySection">
                    <div id="protocolHistoryToggle"
                        class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-gray-500 cursor-pointer hover:shadow-xl transition duration-200">
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold text-gray-800">Protokoll History</span>
                            <svg id="protocolHistoryToggleIcon" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"
                                class="w-6 h-6 transform transition-transform">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                            </svg>
                        </div>
                    </div>
                    <div id="protocolHistoryArea" class="bg-white rounded-xl shadow-lg mt-2 p-4 hidden flex-col gap-4">
                    </div>
                </div>
            </div>



            <div id="userSettingsView" class="view">
                <div class="back-link-container w-full mb-2">
                    <button class="back-link flex items-center text-gray-600 hover:text-indigo-600 transition"
                        data-target="home">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                            class="w-5 h-5 mr-1">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        <span class="text-sm font-semibold">zurück</span>
                    </button>
                    <div class="border-t border-gray-300 mt-2"></div>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Eigene Einstellungen</h2>

                <div id="currentUserKeyDisplay"
                    class="bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg"
                    style="display: none;">
                </div>

                <div class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-blue-500">
                    <h3 id="userSettingsName" class="font-bold text-gray-800 mb-2">Passwort für ... ändern</h3>
                    <p class="text-sm text-gray-600 mb-4">Geben Sie ein neues Passwort ein, um Ihr altes zu
                        ersetzen.
                    </p>
                    <div class="flex space-x-2 mt-3">
                        <input type="password" id="userSettingsNewKeyInput"
                            class="flex-grow p-2 border border-blue-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Neuen Schlüssel eingeben (mind. 4 Zeichen)">
                        <button id="userSettingsSaveKeyButton"
                            class="py-2 px-3 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition">Speichern</button>
                    </div>
                </div>
            </div>

            <div id="entranceView" class="view">
                <div class="back-link-container w-full mb-2">
                    <button class="back-link flex items-center text-gray-600 hover:text-indigo-600 transition"
                        data-target="home">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                            class="w-5 h-5 mr-1">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        <span class="text-sm font-semibold">zurück</span>
                    </button>
                    <div class="border-t border-gray-300 mt-2"></div>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 mb-4">Haupteingang Steuerung</h2>

                <button data-delay="0"
                    class="action-button w-full py-4 px-6 bg-indigo-700 text-white text-xl font-extrabold rounded-xl shadow-lg hover:bg-indigo-800 transition duration-200 flex items-center justify-center">
                    <span class="button-text">SOFORT ÖFFNEN</span>
                    <div class="loading-spinner"></div>
                </button>

                <div class="w-full grid grid-cols-3 gap-4">
                    <button data-delay="5"
                        class="action-button py-4 bg-gray-200 text-gray-800 font-semibold rounded-xl shadow-md hover:bg-gray-300 transition duration-200 flex items-center justify-center">
                        <span class="button-text">5 Sek</span>
                        <div class="loading-spinner"></div>
                    </button>
                    <button data-delay="10"
                        class="action-button py-4 bg-gray-200 text-gray-800 font-semibold rounded-xl shadow-md hover:bg-gray-300 transition duration-200 flex items-center justify-center">
                        <span class="button-text">10 Sek</span>
                        <div class="loading-spinner"></div>
                    </button>
                    <button data-delay="15"
                        class="action-button py-4 bg-gray-200 text-gray-800 font-semibold rounded-xl shadow-md hover:bg-gray-300 transition duration-200 flex items-center justify-center">
                        <span class="button-text">15 Sek</span>
                        <div class="loading-spinner"></div>
                    </button>
                </div>
            </div>

            <div id="pushoverView" class="view">
                <div class="back-link-container w-full mb-2">
                    <button class="back-link flex items-center text-gray-600 hover:text-indigo-600 transition"
                        data-target="home">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                            class="w-5 h-5 mr-1">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        <span class="text-sm font-semibold">zurück</span>
                    </button>
                    <div class="border-t border-gray-300 mt-2"></div>
                </div>

                <h2 class="text-2xl font-bold text-gray-800">Nachricht senden</h2>

                <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-100">
                    <div class="mb-4">
                        <label for="pushoverTitle" class="block text-sm font-medium text-gray-700 mb-1">Titel</label>
                        <input type="text" id="pushoverTitle" placeholder="Info über TOP 2 APP"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            value="Wichtig: TOP 2 Meldung">
                    </div>

                    <div class="mb-4">
                        <label for="pushoverMessage"
                            class="block text-sm font-medium text-gray-700 mb-1">Nachricht</label>
                        <textarea id="pushoverMessage" rows="3"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Ihre Nachricht..."></textarea>
                    </div>

                    <div class="mb-6">
                        <label for="pushoverRecipient"
                            class="block text-sm font-medium text-gray-700 mb-1">Empfänger</label>
                        <select id="pushoverRecipient"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-5900 bg-white">
                            <option value="Markus">Markus</option>
                            <option value="Jasmin">Jasmin</option>
                            <option value="ALLE">ALLE</option>
                        </select>
                    </div>

                    <button id="sendDynamicPostButton"
                        class="w-full py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-200 flex items-center justify-center">
                        <span class="button-text">Nachricht senden</span>
                        <div class="loading-spinner"></div>
                    </button>
                </div>
            </div>

            <div id="checklistView" class="view">
            </div>

            <div id="checklistSettingsView" class="view">
            </div>

            <div id="essensberechnungView" class="view">
                <div class="back-link-container w-full mb-2">
                    <button class="back-link flex items-center text-gray-600 hover:text-indigo-600 transition"
                        data-target="home">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                            class="w-5 h-5 mr-1">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        <span class="text-sm font-semibold">zurück</span>
                    </button>
                    <div class="border-t border-gray-300 mt-2"></div>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Essensberechnung</h2>

                <div id="meal-composition-area" class="space-y-4">

                    <div class="card bg-white p-4 rounded-xl shadow-lg">
                        <label for="meal-name" class="block text-sm font-medium text-gray-700 mb-1">Name der
                            Mahlzeit</label>
                        <input type="text" id="meal-name" placeholder="z.B. Mittagessen Montag"
                            class="w-full p-2 border rounded-lg">
                    </div>

                    <div class="card bg-white p-4 rounded-xl shadow-lg">
                        <h3 class="font-bold text-gray-800 mb-2">Einzelne Produkte</h3>
                        <div class="flex gap-2">
                            <input type="text" id="single-product-name" class="flex-grow p-2 border rounded-lg"
                                placeholder="Produkt (z.B. Hähnchen)">
                            <input type="number" id="single-product-weight" class="w-24 p-2 border rounded-lg"
                                placeholder="Gewicht (g)">
                            <button id="add-single-product-btn"
                                class="py-2 px-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">+</button>
                        </div>
                        <div id="single-products-list" class="mt-3 space-y-1"></div>
                    </div>

                    <div class="card bg-white p-4 rounded-xl shadow-lg">
                        <h3 class="font-bold text-gray-800 mb-2">Rezepte</h3>
                        <div id="recipes-area" class="space-y-3">
                        </div>
                        <button id="add-recipe-btn"
                            class="w-full mt-3 py-2 text-sm text-blue-600 font-semibold hover:underline">+ Neues Rezept
                            hinzufügen</button>
                    </div>
                </div>

                <div id="portion-definition-form"
                    class="card bg-gray-50 p-4 rounded-xl space-y-4 transition-colors duration-300">
                    <h3 class="font-bold text-gray-800 mb-2">1. Portion definieren</h3>

                    <div class="p-3 border bg-white rounded-lg space-y-3">
                        <div class="flex items-center gap-2">
                            <select id="person-select" class="flex-grow p-2 border rounded-lg bg-white"></select>
                            <button id="rest-mode-btn"
                                class="py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition flex-shrink-0">Rest</button>
                        </div>
                        <input type="text" id="portion-name" class="w-full p-2 border rounded-lg"
                            placeholder="Name der Portion (z.B. Mittwoch)">

                        <div id="product-weights-for-person" class="space-y-2 pt-2 border-t">
                        </div>

                        <div id="recipe-weights-for-person" class="space-y-2 pt-2 border-t">
                        </div>

                        <div id="product-weights-for-person" class="space-y-2 pt-2 border-t">
                        </div>

                        <div class="flex items-center gap-2 pt-2 border-t">
                            <label for="portion-anzahl" class="text-sm font-semibold text-gray-700">Anzahl:</label>
                            <input type="number" id="portion-anzahl" class="w-24 p-2 border rounded-lg" value="1"
                                min="1">
                        </div>
                    </div>

                    <button id="add-portion-definition-btn"
                        class="w-full py-2 px-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">
                        + Portion hinzufügen
                    </button>
                    <div class="flex gap-2">
                        <button id="update-portion-definition-btn"
                            class="w-full py-2 px-3 bg-yellow-500 text-black font-semibold rounded-lg hover:bg-yellow-600 hidden">
                            Änderung übernehmen
                        </button>
                        <button id="delete-portion-definition-btn"
                            class="w-full py-2 px-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 hidden">
                            Portion löschen
                        </button>
                    </div>
                </div>

                <div class="card bg-white p-4 rounded-xl shadow-lg">
                    <h3 class="font-bold text-gray-800 mb-2">2. Definierte Portionen</h3>
                    <div id="distribution-list" class="space-y-2">
                        <p class="text-sm text-center text-gray-400">Noch keine Portionen definiert.</p>
                    </div>
                </div>

                <div class="card bg-gray-50 p-4 rounded-xl mt-4">
                    <h3 class="font-bold text-gray-800 mb-2">3. Berechnung starten</h3>
                    <button id="run-calculation-btn"
                        class="w-full py-3 px-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">
                        Finale Aufteilung berechnen
                    </button>
                </div>
                <div id="calculation-results-area" class="mt-6 pt-6 border-t-2 border-gray-200">
                    <h2 class="text-xl font-bold text-gray-700">Berechnungsergebnis</h2>

                    <div id="calculation-view-switcher" class="flex flex-wrap gap-2 my-4 p-2 bg-gray-100 rounded-lg">
                    </div>

                    <div id="results-table" class="mt-2">
                        <p class="text-sm text-gray-500 text-center">Bitte eine Ansicht (Gesamt, Rest oder eine Portion)
                            auswählen, um das Ergebnis anzuzeigen.</p>
                    </div>
                </div>
            </div>


            <div id="notrufSettingsView" class="view">
                <div class="back-link-container w-full mb-2">
                    <button class="back-link flex items-center text-gray-600 hover:text-indigo-600 transition"
                        data-target="home">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                            class="w-5 h-5 mr-1">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        <span class="text-sm font-semibold">zurück</span>
                    </button>
                    <div class="border-t border-gray-300 mt-2"></div>
                </div>

                <div class="mb-6">
                    <div id="notruf-settings-tabs" class="grid grid-cols-2 gap-1 border rounded-lg bg-gray-100 p-1">
                        <button data-target-card="card-flic-notruf"
                            class="settings-tab-btn p-2 text-sm font-semibold rounded-md text-gray-600">
                            Flic-Notruf-Button
                        </button>
                        <button data-target-card="card-app-notruf"
                            class="settings-tab-btn p-2 text-sm font-semibold rounded-md text-gray-600">
                            APP-Notruf
                        </button>
                    </div>
                </div>

                <div id="notruf-prompt" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg">
                    <p class="font-bold">Bitte wählen Sie oben einen Menüpunkt aus, um die Einstellungen zu bearbeiten.
                    </p>
                </div>

                <div id="card-flic-notruf" class="notruf-settings-card hidden space-y-6">

                    <div class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-indigo-500 mb-6">
                        <div class="flex justify-between items-center mb-4 pb-3 border-b">
                            <h2 class="text-xl font-bold text-gray-800">Flic-Button Klick-Zuweisungen</h2>
                            <button id="notrufOpenModeEditor"
                                class="py-1 px-3 bg-blue-100 text-blue-600 text-sm font-semibold rounded-lg hover:bg-blue-200 transition">
                                Modi Verwalten
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div data-klick-typ="einfach"
                                class="flic-column-block p-4 bg-gray-50 rounded-lg border border-gray-200 cursor-pointer hover:border-indigo-300 transition-all duration-200">
                                <h4 class="text-sm font-bold text-gray-800 mb-2 border-b pb-1">Klick: EINFACH</h4>
                                <span class="text-xs font-semibold text-gray-500">Aktueller Modus:</span>
                                <span id="flicDisplayModeName-einfach"
                                    class="text-lg font-semibold text-indigo-700 block break-words"
                                    title="Kein Modus">Kein Modus</span>
                                <span id="flicDisplayModeDesc-einfach" class="text-xs text-gray-600 mt-1 block"></span>
                            </div>

                            <div data-klick-typ="doppel"
                                class="flic-column-block p-4 bg-gray-50 rounded-lg border border-gray-200 cursor-pointer hover:border-indigo-300 transition-all duration-200">
                                <h4 class="text-sm font-bold text-gray-800 mb-2 border-b pb-1">Klick: DOPPEL</h4>
                                <span class="text-xs font-semibold text-gray-500">Aktueller Modus:</span>
                                <span id="flicDisplayModeName-doppel"
                                    class="text-lg font-semibold text-indigo-700 block break-words"
                                    title="Kein Modus">Kein Modus</span>
                                <span id="flicDisplayModeDesc-doppel" class="text-xs text-gray-600 mt-1 block"></span>
                            </div>

                            <div data-klick-typ="halten"
                                class="flic-column-block p-4 bg-gray-50 rounded-lg border border-gray-200 cursor-pointer hover:border-indigo-300 transition-all duration-200">
                                <h4 class="text-sm font-bold text-gray-800 mb-2 border-b pb-1">Klick: HOLD</h4>
                                <span class="text-xs font-semibold text-gray-500">Aktueller Modus:</span>
                                <span id="flicDisplayModeName-halten"
                                    class="text-lg font-semibold text-indigo-700 block break-words"
                                    title="Kein Modus">Kein Modus</span>
                                <span id="flicDisplayModeDesc-halten" class="text-xs text-gray-600 mt-1 block"></span>
                            </div>
                        </div>
                    </div>

                    <div id="flic-details-editor-container" class="hidden mt-4 space-y-3">
                        <div class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-indigo-500">
                            <h3 id="flic-editor-title" class="text-lg font-bold text-gray-800 mb-3">Modus ändern</h3>

                            <select id="flic-editor-selector"
                                class="flic-assignment-selector w-full p-2 border rounded-lg bg-white">
                            </select>

                            <div id="flic-editor-details"
                                class="bg-blue-50 text-blue-900 text-xs p-3 rounded mt-3 min-h-[60px]">
                            </div>
                        </div>

                        <button id="saveFlicAssignmentsBtn"
                            class="w-full py-2 px-4 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition flex items-center justify-center gap-2">
                            Zuweisungen Speichern
                            <div class="loading-spinner"></div>
                        </button>
                    </div>
                    <div id="modeEditorArea" class="hidden space-y-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800">Flic-Button Notrufmodus Verwalten</h2>
                            <button id="notrufCloseModeEditor"
                                class="text-gray-400 hover:text-red-600 font-bold text-2xl">&times;</button>
                        </div>
                        <div class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-gray-300">
                            <h3 class="font-bold text-gray-800 mb-3">Vorhandene Modi</h3>
                            <div id="existingModesList" class="space-y-2 mb-4 max-h-48 overflow-y-auto">
                            </div>
                            <button id="notrufAddNewModeButton"
                                class="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                                + Neuen Modus anlegen
                            </button>
                        </div>

                        <div id="modeConfigFormContainer" class="hidden">
                            <h3 id="modeConfigFormTitle" class="text-xl font-bold text-gray-800 mb-4">Modus
                                Konfigurieren</h3>
                            <div id="notrufConfigArea"
                                class="bg-white rounded-xl shadow-lg p-4 flex flex-col gap-4 border-t-4 border-orange-500">
                                <input type="hidden" id="editingModeId">

                                <div>
                                    <label for="notrufModeTitle"
                                        class="block text-sm font-medium text-gray-700 mb-1">Titel des Modus</label>
                                    <input type="text" id="notrufModeTitle" class="w-full p-2 border rounded-lg"
                                        placeholder="z.B. Standard Notruf">
                                </div>
                                <div>
                                    <label for="notrufModeDescInput"
                                        class="block text-sm font-medium text-gray-700 mb-1">Kurzbeschreibung (für
                                        Flic-Button Übersicht)</label>
                                    <input type="text" id="notrufModeDescInput" class="w-full p-2 border rounded-lg"
                                        placeholder="z.B. Sendet an alle Kontakte">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">API-Token</label>
                                    <div class="flex gap-2 items-center">
                                        <div id="notrufApiTokenDisplay"
                                            class="flex-grow p-2 border rounded-lg bg-gray-100 min-h-[40px] text-sm text-gray-600 flex flex-wrap gap-1 items-center">
                                            <span class="text-gray-400 italic">Kein Token ausgewählt</span>
                                        </div>
                                        <button id="notrufOpenApiTokenBook"
                                            class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition"
                                            title="API-Token auswählen/verwalten">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                fill="currentColor" class="w-5 h-5">
                                                <path fill-rule="evenodd"
                                                    d="M11.986 4.31a3.75 3.75 0 0 0-7.344 1.294.75.75 0 0 1-1.48-.216A5.25 5.25 0 0 1 12.23 3.07a.75.75 0 0 1-.244 1.24Zm-1.46-1.54a.75.75 0 0 1 1.054-.09l3 2.5a.75.75 0 1 1-.968 1.148l-3-2.5a.75.75 0 0 1-.086-1.058ZM6 9a.75.75 0 0 1 .75-.75h1.59l1.11-2.22a.75.75 0 1 1 1.34.67l-1.1 2.2h.11A3.75 3.75 0 0 1 13 12.75V15a.75.75 0 0 1-1.5 0v-2.25a2.25 2.25 0 0 0-2.25-2.25H7.5A.75.75 0 0 1 6 9.75v-.75Zm7.78 6.09a.75.75 0 0 0-1.06-.08l-3 2.5a.75.75 0 1 0 .96 1.16l3-2.5a.75.75 0 0 0 .1-.98Zm1.22-.99-.002-.002A5.25 5.25 0 0 0 7.77 16.93a.75.75 0 1 0 .245 1.478A6.75 6.75 0 0 1 17.5 10.5a.75.75 0 0 0-1.5 0c0 .98-.198 1.906-.55 2.72l.001.002a.75.75 0 0 0 1.05 1.05Z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">User Key
                                        (Empfänger)</label>
                                    <div class="flex gap-2 items-center">
                                        <div id="notrufUserKeyDisplay"
                                            class="flex-grow p-2 border rounded-lg bg-gray-100 min-h-[40px] text-sm text-gray-600 flex flex-wrap gap-1">
                                        </div>
                                        <button id="notrufOpenContactBook"
                                            class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition"
                                            title="Kontaktbuch öffnen">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                fill="currentColor" class="w-5 h-5">
                                                <path
                                                    d="M3 4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H3Zm2 2h10v1a.75.75 0 0 1-1.5 0V6H6v.75a.75.75 0 0 1-1.5 0V6Zm11 6a.75.75 0 0 1-.75.75H4.75a.75.75 0 0 1 0-1.5h10.5a.75.75 0 0 1 .75.75Z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label for="notrufTitle" class="block text-sm font-medium text-gray-700 mb-1">Titel
                                        der Benachrichtigung</label>
                                    <input type="text" id="notrufTitle" class="w-full p-2 border rounded-lg"
                                        placeholder="z.B. Notfall bei Oma">
                                </div>

                                <div>
                                    <label for="notrufMessage"
                                        class="block text-sm font-medium text-gray-700 mb-1">Nachricht</label>
                                    <textarea id="notrufMessage" rows="3"
                                        class="w-full p-2 border rounded-lg"></textarea>
                                </div>

                                <div class="pt-3 border-t">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Sound</label>
                                    <div class="flex gap-2 items-center">
                                        <div id="notrufSoundDisplay"
                                            class="flex-grow p-2 border rounded-lg bg-gray-100 min-h-[40px] text-sm text-gray-600 flex flex-wrap gap-1 items-center">
                                            <span class="text-gray-400 italic">Standard (pushover)</span>
                                        </div>
                                        <button id="notrufOpenSoundBook"
                                            class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition"
                                            title="Sound auswählen/verwalten">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                fill="currentColor" class="w-5 h-5">
                                                <path
                                                    d="M12.016 4.39a.75.75 0 0 0-1.182.046l-4 6a.75.75 0 0 0 .586 1.137h1.498V13a.75.75 0 0 0 1.5 0v-1.427h1.498a.75.75 0 0 0 .586-1.137l-4-6ZM6.25 7.5A.75.75 0 0 1 7 8.25v3a.75.75 0 0 1-1.5 0v-3A.75.75 0 0 1 6.25 7.5Zm7.5 0a.75.75 0 0 1 .75.75v3a.75.75 0 0 1-1.5 0v-3a.75.75 0 0 1 .75-.75Z" />
                                                <path fill-rule="evenodd"
                                                    d="M10 2a8 8 0 1 0 0 16 8 8 0 0 0 0-16ZM9 1a9 9 0 0 0-9 9 9 9 0 0 0 9 9 9 9 0 0 0 9-9 9 9 0 0 0-9-9Z"
                                                    clip-rule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <div class="pt-3 border-t">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Priorität</label>
                                    <div id="priority-buttons-container"
                                        class="grid grid-cols-5 gap-1 p-1 bg-gray-100 rounded-lg">
                                        <button data-priority="-2"
                                            class="priority-btn p-2 text-xs font-semibold rounded-md text-gray-600 hover:bg-gray-200">
                                            -2<br><span class="font-normal">(Leise)</span>
                                        </button>
                                        <button data-priority="-1"
                                            class="priority-btn p-2 text-xs font-semibold rounded-md text-gray-600 hover:bg-gray-200">
                                            -1<br><span class="font-normal">(Wenig)</span>
                                        </button>
                                        <button data-priority="0"
                                            class="priority-btn p-2 text-xs font-semibold rounded-md text-gray-600 hover:bg-gray-200">
                                            0<br><span class="font-normal">(Normal)</span>
                                        </button>
                                        <button data-priority="1"
                                            class="priority-btn p-2 text-xs font-semibold rounded-md text-gray-600 hover:bg-gray-200">
                                            1<br><span class="font-normal">(Hoch)</span>
                                        </button>
                                        <button data-priority="2"
                                            class="priority-btn p-2 text-xs font-semibold rounded-md text-gray-600 hover:bg-gray-200">
                                            2<br><span class="font-normal">(Notfall)</span>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Notfall (-2) erfordert Retry/Expire.</p>
                                </div>

                                <div class="pt-3 border-t">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Wiederholungsintervall
                                        (Retry - für Notfall-Prio)</label>
                                    <div class="flex items-center gap-3 mb-2">
                                        <input type="checkbox" id="retryDeaktiviert" class="h-4 w-4">
                                        <label for="retryDeaktiviert" class="text-sm">Deaktiviert</label>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="retrySecondsInput" min="30" max="10800" step="1"
                                            value="30"
                                            class="w-24 p-2 border rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100 disabled:cursor-not-allowed">
                                        <span class="text-sm text-gray-600">Sekunden (Minimum: 30, Maximum:
                                            10800)</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Expire wird automatisch auf das Maximum
                                        (10800s / 3h) gesetzt.</p>
                                </div>

                                <div class="flex gap-2 mt-4">
                                    <button id="notrufCancelEditModeButton"
                                        class="w-1/2 py-3 bg-gray-300 text-black font-bold rounded-lg shadow-md hover:bg-gray-400 transition">
                                        Abbrechen
                                    </button>
                                    <button id="notrufSaveModeButton"
                                        class="w-1/2 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition">
                                        Modus Speichern
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="card-app-notruf" class="notruf-settings-card hidden space-y-6">
                    <div class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-gray-400">
                        <h2 class="text-xl font-bold text-gray-800">APP-Notruf</h2>
                        <p class="mt-2 text-gray-600">Diese Funktion befindet sich derzeit im Aufbau.</p>
                    </div>
                </div>

            </div>
            <div id="userSelectionModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Benutzer auswählen</h3>
                    <p class="text-sm text-gray-600 mb-4">Wählen Sie den Modus, in dem Sie sich anmelden möchten.
                    </p>
                    <div id="modalUserButtons" class="space-y-3"></div>
                    <div class="flex justify-end mt-4">
                        <button id="cancelSelectionButton"
                            class="py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">Abbrechen</button>
                    </div>
                </div>
            </div>

            <div id="pinModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs">
                    <div id="pinRegularContent">
                        <h3 id="pinModalTitle" class="text-xl font-bold mb-4 text-gray-800">Schlüssel eingeben</h3>
                        <p class="text-sm text-gray-600 mb-4">Geben Sie den Schlüssel für den gewählten Benutzer
                            ein.
                        </p>
                        <input type="password" id="adminPinInput"
                            class="w-full p-3 border-2 border-gray-300 rounded-lg text-center tracking-widest text-lg focus:ring-blue-500 focus:border-blue-500"
                            maxlength="20">
                        <div id="pinError" class="text-red-500 text-sm mt-2 hidden">Falscher Schlüssel!</div>
                        <div class="flex justify-between space-x-3 mt-6">
                            <button id="backToSelectionButton"
                                class="py-2 px-3 bg-gray-400 text-white font-medium rounded-lg hover:bg-gray-500 transition">Zurück</button>
                            <button id="submitAdminKeyButton"
                                class="py-2 px-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition">Bestätigen</button>
                        </div>
                    </div>
                    <div id="pinLockedContent" class="hidden text-center">
                        <h3 class="text-xl font-bold mb-4 text-red-700">Zugriff verweigert</h3>
                        <p class="text-gray-600 mb-6">Dieser Benutzer ist gesperrt. Bitte kontaktieren Sie einen
                            Administrator.</p>
                        <button id="closeLockedModalButton"
                            class="w-full py-2 px-4 bg-gray-600 text-white font-medium rounded-lg hover:bg-gray-700 transition">Zurück
                            zur Auswahl</button>
                    </div>
                </div>
            </div>


            <div id="logoutConfirmModal"
                class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Abmelden</h3>
                    <p class="text-sm text-gray-600 mb-6">Möchten Sie sich wirklich abmelden?</p>
                    <div class="flex justify-between space-x-3 mt-4">
                        <button id="confirmLogoutNo"
                            class="flex-1 py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">NEIN</button>
                        <button id="confirmLogoutYes"
                            class="flex-1 py-2 px-4 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition">JA</button>
                    </div>
                </div>
            </div>

        </main>

        <footer id="appFooter"
            class="flex-shrink-0 bg-gray-700 text-white border-t border-gray-600 p-2 flex justify-between items-center text-sm shadow-inner">
            <div id="footerStatus" class="flex items-center text-xs sm:text-sm font-bold text-gray-500">
                Status: <span class="ml-1 text-green-500">OK</span>
            </div>
            <div id="footerUser" class="font-medium text-xs sm:text-sm text-center">
            </div>
            <div id="footerLogout" class="flex items-center justify-end text-xs sm:text-sm">
            </div>
        </footer>

        <div id="templateApplyModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-30">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Container-Inhalt einfügen</h3>
                    <button id="closeTemplateModalBtn" class="text-gray-400 hover:text-red-600">&times;</button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">1. Quell-Typ wählen</label>
                        <div class="grid grid-cols-2 gap-2 p-1 bg-gray-200 rounded-lg">
                            <label class="relative flex items-center justify-center cursor-pointer">
                                <input type="radio" name="template-type" value="Container" class="peer sr-only" checked>
                                <span
                                    class="w-full text-center py-1.5 px-3 rounded-md text-sm font-semibold text-gray-700 peer-checked:bg-white peer-checked:shadow">Container</span>
                            </label>
                            <label class="relative flex items-center justify-center cursor-pointer">
                                <input type="radio" name="template-type" value="Schiff" class="peer sr-only">
                                <span
                                    class="w-full text-center py-1.5 px-3 rounded-md text-sm font-semibold text-gray-700 peer-checked:bg-white peer-checked:shadow">Schiff</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label for="template-select" class="block text-sm font-medium text-gray-700 mb-1">2. Quelle
                            auswählen</label>
                        <select id="template-select" class="w-full p-2 border rounded-lg bg-white">
                            <option value="">Bitte zuerst Typ wählen...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">3. Inhalte zum Einfügen
                            auswählen</label>
                        <div id="template-items-container"
                            class="max-h-48 overflow-y-auto p-3 border rounded-lg bg-gray-50 space-y-2">
                        </div>
                    </div>
                    <div id="template-mode-section" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">4. Einfüge-Methode</label>
                        <div class="flex gap-4 p-2 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="insert-mode" value="einfuegen" class="h-4 w-4" checked>
                                <span>Zur Liste hinzufügen</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="insert-mode" value="ersetzen" class="h-4 w-4">
                                <span>Liste komplett ersetzen</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancel-template-modal-btn"
                        class="py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">Abbrechen</button>
                    <button id="apply-template-btn"
                        class="py-2 px-4 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition">Anwenden</button>
                </div>
            </div>
        </div>
        <div id="deletedListsModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Gelöschte Checklisten</h3>
                <div id="deletedListsContainer" class="space-y-3 max-h-96 overflow-y-auto">
                </div>
                <div class="flex justify-end mt-6">
                    <button id="closeDeletedListsModal"
                        class="py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">Schließen</button>
                </div>
            </div>
        </div>

        <div id="archivedListsModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Archivierte Checklisten</h3>
                <div id="archivedListsContainer" class="space-y-3 max-h-96 overflow-y-auto">
                </div>
                <div class="flex justify-end mt-6">
                    <button id="closeArchivedListsModal"
                        class="py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">Schließen</button>
                </div>
            </div>
        </div>

        <div id="permanentDeleteModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-30">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h3 class="text-xl font-bold mb-4 text-red-800">Papierkorb endgültig leeren</h3>
                <p class="text-sm text-gray-600 mb-4">Wählen Sie die Checklisten aus, die unwiderruflich gelöscht werden
                    sollen. Diese Aktion kann nicht rückgängig gemacht werden.</p>

                <div class="p-2 border-b mb-2">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="permanent-delete-select-all"
                            class="h-5 w-5 rounded border-gray-400 text-indigo-600 focus:ring-indigo-500">
                        <span class="font-semibold text-gray-700">Alle auswählen / abwählen</span>
                    </label>
                </div>

                <div id="permanentDeleteListsContainer"
                    class="space-y-2 max-h-64 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                </div>

                <div class="flex justify-between items-center space-x-3 mt-6">
                    <button id="cancelPermanentDeleteBtn"
                        class="flex-1 py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition">Abbrechen</button>
                    <button id="confirmPermanentDeleteBtn"
                        class="flex-1 py-2 px-4 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition">Auswahl
                        endgültig löschen</button>
                </div>
            </div>
        </div>

        <div id="contactBookModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-30">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg flex flex-col gap-4">
                <h3 class="text-xl font-bold text-gray-800">Kontaktbuch</h3>

                <div id="contactBookList" class="space-y-2 max-h-48 overflow-y-auto p-3 border rounded-lg bg-gray-50">
                    <p class="text-sm text-center text-gray-400">Keine Kontakte gefunden.</p>
                </div>

                <div class="p-4 border rounded-xl bg-green-50 space-y-2">
                    <h4 class="font-semibold text-green-800">Neuen Kontakt anlegen</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <select id="contactIsGroup" class="p-2 border rounded-lg bg-white">
                            <option value="User" selected>User</option>
                            <option value="Gruppe">Gruppe</option>
                        </select>
                        <input type="text" id="contactName" class="p-2 border rounded-lg" placeholder="Anzeigename">
                    </div>
                    <input type="text" id="contactUserKey" class="w-full p-2 border rounded-lg"
                        placeholder="User / Group Key">
                    <button id="contactAddButton"
                        class="w-full py-2 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700">Hinzufügen</button>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="contactBookCloseButton"
                        class="py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300">Schließen</button>
                    <button id="contactBookApplyButton"
                        class="py-2 px-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Auswahl
                        übernehmen</button>
                </div>
            </div>
        </div>

        <div id="apiTokenBookModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-40">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg flex flex-col gap-4">
                <h3 class="text-xl font-bold text-gray-800">API-Token Verwalten</h3>
                <div id="apiTokenBookList" class="space-y-2 max-h-48 overflow-y-auto p-3 border rounded-lg bg-gray-50">
                    <p class="text-sm text-center text-gray-400">Keine Tokens gefunden.</p>
                </div>
                <div class="p-4 border rounded-xl bg-green-50 space-y-2">
                    <h4 class="font-semibold text-green-800">Neuen Token anlegen</h4>
                    <input type="text" id="apiTokenName" class="w-full p-2 border rounded-lg"
                        placeholder="Bezeichnung (z.B. App Name)">
                    <input type="text" id="apiTokenKey" class="w-full p-2 border rounded-lg"
                        placeholder="API / Application Key">
                    <button id="apiTokenAddButton"
                        class="w-full py-2 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700">Hinzufügen</button>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="apiTokenBookCloseButton"
                        class="py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300">Schließen</button>
                    <button id="apiTokenBookApplyButton"
                        class="py-2 px-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Auswahl
                        übernehmen</button>
                </div>
            </div>
        </div>

        <div id="soundBookModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-40">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg flex flex-col gap-4">
                <h3 class="text-xl font-bold text-gray-800">Sounds Verwalten</h3>
                <div id="soundBookList" class="space-y-2 max-h-48 overflow-y-auto p-3 border rounded-lg bg-gray-50">
                    <div class="flex items-center justify-between p-2 hover:bg-gray-100 rounded-md">
                        <label class="flex items-center gap-3 cursor-pointer flex-grow">
                            <input type="radio" name="soundSelection" value="default" class="h-4 w-4 sound-radio">
                            <div>
                                <span class="font-semibold text-gray-800">Standard (pushover)</span>
                                <p class="text-xs text-gray-500 italic">Verwendet den in der Pushover-App eingestellten
                                    Ton</p>
                            </div>
                        </label>
                    </div>
                    <p id="sound-list-placeholder" class="text-sm text-center text-gray-400 hidden">Keine eigenen Sounds
                        gefunden.</p>
                </div>
                <div class="p-4 border rounded-xl bg-green-50 space-y-2">
                    <h4 class="font-semibold text-green-800">Neuen Sound anlegen</h4>
                    <input type="text" id="soundCode" class="w-full p-2 border rounded-lg"
                        placeholder="Soundcode (von Pushover)">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="soundUseCustomName" class="h-4 w-4">
                        <label for="soundUseCustomName" class="text-sm font-medium">Eigenen Anzeigenamen
                            verwenden</label>
                    </div>
                    <input type="text" id="soundCustomName" class="w-full p-2 border rounded-lg hidden"
                        placeholder="Eigener Anzeigename">
                    <button id="soundAddButton"
                        class="w-full py-2 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700">Hinzufügen</button>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="soundBookCloseButton"
                        class="py-2 px-4 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300">Schließen</button>
                    <button id="soundBookApplyButton"
                        class="py-2 px-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Auswahl
                        übernehmen</button>
                </div>
            </div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getFirestore, collection, doc, onSnapshot, setDoc, updateDoc, deleteDoc, getDocs, writeBatch, addDoc, query, where, serverTimestamp, orderBy, limit, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

            const PUSHOVER_TOKEN = 'aeqwab5g325hvmk33gtq7s3bz8z7x6';
            const RECIPIENT_KEYS = {
                Markus: 'ue2n25mzqfjnt5mwxkzgik35xotswi',
                Jasmin: 'ugag4tcjpdpq6cfca5ezkrav9pn2va',
                ALLE: 'gaqm7tzrvqxmkjsd8a1t53cvghdog8'
            };
            // FÜGE DIESEN BLOCK GANZ OBEN IM SCRIPT EIN
            const COLOR_PALETTE = {
                gray: { name: 'Grau', bg: 'bg-gray-100', text: 'text-gray-800', border: 'border-gray-400' },
                red: { name: 'Rot', bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-500' },
                orange: { name: 'Orange', bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-500' },
                amber: { name: 'Bernstein', bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-500' },
                yellow: { name: 'Gelb', bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-500' },
                lime: { name: 'Limette', bg: 'bg-lime-100', text: 'text-lime-800', border: 'border-lime-500' },
                green: { name: 'Grün', bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-500' },
                emerald: { name: 'Smaragd', bg: 'bg-emerald-100', text: 'text-emerald-800', border: 'border-emerald-500' },
                teal: { name: 'Türkis', bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-500' },
                cyan: { name: 'Cyan', bg: 'bg-cyan-100', text: 'text-cyan-800', border: 'border-cyan-500' },
                sky: { name: 'Himmelblau', bg: 'bg-sky-100', text: 'text-sky-800', border: 'border-sky-500' },
                blue: { name: 'Blau', bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-500' },
                indigo: { name: 'Indigo', bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-500' },
                violet: { name: 'Violett', bg: 'bg-violet-100', text: 'text-violet-800', border: 'border-violet-500' },
                purple: { name: 'Lila', bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-500' },
                fuchsia: { name: 'Fuchsia', bg: 'bg-fuchsia-100', text: 'text-fuchsia-800', border: 'border-fuchsia-500' },
                pink: { name: 'Pink', bg: 'bg-pink-100', text: 'text-pink-800', border: 'border-pink-500' },
                rose: { name: 'Rose', bg: 'bg-rose-100', text: 'text-rose-800', border: 'border-rose-500' },
            };
            const IFTTT_EVENT = 'NFC_Stick_Switchbot_Bauteil_2_Wohnungsanlage_oeffnen';
            const IFTTT_KEY = 'pECKM4iJ9sI_3ZF4DdYTzsH60p3cCg0yLbnPGzUFbFO';
            const IFTTT_URL = `https://maker.ifttt.com/trigger/${IFTTT_EVENT}/with/key/${IFTTT_KEY}`;

            const USER_COLORS = {
                ADMIN: ['bg-red-600', 'hover:bg-red-700'],
                SYSTEMADMIN: ['bg-purple-800', 'hover:bg-purple-900'],
                DEFAULT: ['bg-indigo-600', 'hover:bg-indigo-700']
            };

            let USERS = {};
            let CHECKLISTS = {};
            let ARCHIVED_CHECKLISTS = {};
            let CHECKLIST_STACKS = {};
            let CHECKLIST_ITEMS = {};
            let DELETED_CHECKLISTS = {};
            let CHECKLIST_CATEGORIES = {};
            let CHECKLIST_GROUPS = {};
            let ROLES = {};
            let TEMPLATES = {};
            let TEMPLATE_ITEMS = {};
            let notrufSettingsDocRef;
            let activeFlicEditorKlickTyp = null;
            // START: Füge diesen neuen Block am Anfang des Scripts ein
            // === ERSETZE diesen Block ===
            let notrufSettings = {
                modes: [],      // Array für die Modi: { id, title, description, config: { ... } }
                contacts: [],   // Kontaktbuch bleibt global
                flicAssignments: { // NEU: Speichert, welcher Klick welchen Modus (per ID) auslöst
                    einfach: null,   // ID des Modus für Einfach-Klick
                    doppel: null,    // ID des Modus für Doppel-Klick
                    halten: null     // ID des Modus für Halten
                },
                // NEUE FELDER HINZUFÜGEN:
                apiTokens: [],  // { id, name, key }
                sounds: []      // { id, code, useCustomName, customName }
            };
            let tempSelectedApiTokenId = null; // Für das Bearbeiten-Formular
            let tempSelectedSoundId = null;    // Für das Bearbeiten-Formular
            // === Bis hier ersetzen ===            let selectedTemplateId = null;
            let unsubscribeTemplateItems = null;

            function renderTemplateList() {
                const container = document.getElementById('template-list-container');
                const editor = document.getElementById('template-item-editor');

                if (Object.keys(TEMPLATES).length === 0) {
                    container.innerHTML = '<p class="text-sm text-center text-gray-400">Keine Container gefunden. Erstellen Sie einen neuen!</p>';
                    editor.classList.add('hidden');
                    selectedTemplateId = null;
                    return;
                }

                container.innerHTML = '';

                Object.values(TEMPLATES).forEach(template => {
                    const isSelected = template.id === selectedTemplateId;
                    container.innerHTML += `
            <div data-template-id="${template.id}" class="template-selection-item p-3 border rounded-lg flex justify-between items-center cursor-pointer hover:bg-gray-100 transition ${isSelected ? 'bg-indigo-50 border-indigo-300' : ''}">
                <span class="font-semibold">${template.name}</span>
            </div>
        `;
                });
            }


            function renderTemplateItemsEditor() {
                const itemsListContainer = document.getElementById('template-items-list');
                const items = TEMPLATE_ITEMS[selectedTemplateId] || [];

                itemsListContainer.innerHTML = '';

                if (items.length === 0) {
                    itemsListContainer.innerHTML = '<p class="text-xs text-center text-gray-400">Dieser Container hat noch keine Einträge.</p>';
                    return;
                }

                items.forEach(item => {
                    const isImportantClass = item.important ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'bg-white';
                    let detailsHTML = '';
                    if (item.categoryName) {
                        const colorKey = item.categoryColor || 'gray';
                        const color = COLOR_PALETTE[colorKey] || COLOR_PALETTE.gray;
                        detailsHTML += `<span class="ml-2 text-xs font-semibold py-0.5 px-2 rounded-full whitespace-nowrap ${color.bg} ${color.text}">${item.categoryName}</span>`;
                    }
                    if (item.assignedToName) {
                        detailsHTML += `<span class="ml-2 text-xs bg-gray-200 text-gray-700 font-semibold py-0.5 px-2 rounded-full whitespace-nowrap">${item.assignedToName}</span>`;
                    }

                    itemsListContainer.innerHTML += `
            <div class="p-2 border rounded-md flex justify-between items-center ${isImportantClass}">
                <div class="flex items-center flex-wrap">
                    <span>${item.text}</span>
                    <div class="flex items-center mt-1 sm:mt-0">
                        ${detailsHTML}
                    </div>
                </div>
                <button data-item-id="${item.id}" class="delete-template-item-btn p-1 text-red-400 hover:text-red-600 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1H2V3Zm2 2h8v8a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5Z" /></svg>
                </button>
            </div>
        `;
                });
            }

            function renderContainerList() {
                const editorDiv = document.getElementById('container-list-editor');
                if (!editorDiv) return;

                editorDiv.innerHTML = `<h3 class="font-bold text-gray-800 mb-2 mt-6">Bestehende Container verwalten</h3>`;

                const stacks = Object.values(CHECKLIST_STACKS);
                const containers = Object.values(TEMPLATES);
                const stackOptions = `<option value="">Keinen Stack zuweisen</option>` + Object.values(CHECKLIST_STACKS).map(stack => `<option value="${stack.id}">${stack.name}</option>`).join('');

                const createContainerItemHTML = (container) => {
                    const isSelected = container.id === selectedTemplateId;
                    const currentStackName = container.stackName || "Kein Stack zugewiesen";

                    // HIER IST DIE ÄNDERUNG: Der data-template-id und die Klasse sind jetzt auf dem äußeren Div
                    return `
            <div data-template-id="${container.id}" class="template-selection-item p-2 border rounded-md bg-white cursor-pointer hover:bg-gray-100 ${isSelected ? 'bg-indigo-50 border-indigo-300' : ''}">
                <p class="font-semibold">${container.name}</p>
                
                <div class="mt-2 p-2 bg-gray-50 rounded-lg">
                    <div id="stack-display-container-${container.id}" class="flex justify-between items-center">
                        <p class="text-sm">Aktueller Stack: <span class="font-bold text-teal-800">${currentStackName}</span></p>
                        <button data-container-id="${container.id}" class="change-stack-btn text-sm font-semibold text-blue-600 hover:underline">ändern</button>
                    </div>
                    <div id="stack-edit-container-${container.id}" class="hidden flex gap-2 items-center">
                        <select class="stack-assign-switcher flex-grow p-1 border rounded-lg bg-white text-sm">${stackOptions}</select>
                        <button data-container-id="${container.id}" class="save-stack-assignment-btn py-1 px-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 text-xs">Speichern</button>
                    </div>
                </div>
            </div>
        `;
                };

                const containersWithoutStack = containers.filter(c => !c.stackId);

                stacks.forEach(stack => {
                    const containersInStack = containers.filter(c => c.stackId === stack.id);
                    if (containersInStack.length > 0) {
                        editorDiv.innerHTML += `<h4 class="font-semibold text-sm text-gray-600 mt-4 mb-1">${stack.name}</h4>`;
                        containersInStack.forEach(container => {
                            editorDiv.innerHTML += createContainerItemHTML(container);
                        });
                    }
                });

                if (containersWithoutStack.length > 0) {
                    editorDiv.innerHTML += `<h4 class="font-semibold text-sm text-gray-600 mt-4 mb-1">Ohne Stack</h4>`;
                    containersWithoutStack.forEach(container => {
                        editorDiv.innerHTML += createContainerItemHTML(container);
                    });
                }

                if (containers.length === 0) {
                    editorDiv.innerHTML += `<p class="text-sm text-center text-gray-400">Keine Container gefunden.</p>`;
                }
            }

            async function applyTemplateLogic() {
                const modal = document.getElementById('templateApplyModal');
                const targetListId = modal.dataset.targetListId;
                const applyBtn = document.getElementById('apply-template-btn');

                if (!targetListId) {
                    alertUser("Fehler: Keine Ziel-Checkliste gefunden.", "error");
                    return;
                }

                setButtonLoading(applyBtn, true);

                try {
                    const batch = writeBatch(db);
                    const selectedType = modal.querySelector('input[name="template-type"]:checked').value;
                    const insertMode = modal.querySelector('input[name="insert-mode"]:checked')?.value;

                    if (selectedType === 'Schiff' && insertMode === 'ersetzen') {
                        const itemsToDeleteQuery = query(checklistItemsCollectionRef, where("listId", "==", targetListId));
                        const itemsToDeleteSnapshot = await getDocs(itemsToDeleteQuery);
                        itemsToDeleteSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                    }

                    const selectedItemsCheckboxes = modal.querySelectorAll('.template-item-cb:checked');
                    if (selectedItemsCheckboxes.length === 0) {
                        alertUser("Bitte wählen Sie mindestens einen Eintrag zum Einfügen aus.", "error");
                        setButtonLoading(applyBtn, false);
                        return;
                    }

                    selectedItemsCheckboxes.forEach(checkbox => {
                        const newItemRef = doc(checklistItemsCollectionRef);
                        const newItemData = {
                            listId: targetListId,
                            text: checkbox.dataset.text,
                            status: 'open',
                            important: checkbox.dataset.important === 'true',
                            addedBy: currentUser.displayName,
                            addedAt: serverTimestamp(),
                            assignedTo: checkbox.dataset.assignedTo || null,
                            assignedToName: checkbox.dataset.assignedToName || null,
                            categoryId: checkbox.dataset.categoryId || null,
                            categoryName: checkbox.dataset.categoryName || null,
                            categoryColor: checkbox.dataset.categoryColor || null
                        };
                        batch.set(newItemRef, newItemData);
                    });

                    await batch.commit();

                    alertUser(`${selectedItemsCheckboxes.length} Einträge wurden erfolgreich hinzugefügt!`, "success");
                    closeTemplateModal();

                } catch (error) {
                    console.error("Fehler beim Anwenden des Inhalts:", error);
                    alertUser("Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.", "error");
                } finally {
                    setButtonLoading(applyBtn, false);
                }
            }



            let adminSettings = {};
            const GUEST_MODE = 'Gast';
            const ADMIN_STORAGE_KEY = 't2_user_mode';
            let currentUser = {
                mode: GUEST_MODE,
                displayName: GUEST_MODE,
                permissions: [],
                role: null
            };
            let selectedUserForLogin = null;
            let adminSectionsState = { password: false, user: false, role: false, approval: false, protocol: false, adminRights: false, mainFunctions: false }; let localUpdateInProgress = false;
            let roleManagementSectionsState = { userRolesOpen: false, adminRolesOpen: false };
            let ADMIN_ROLES = {};
            let adminRolesCollectionRef;

            let db;
            let checklistsCollectionRef, checklistItemsCollectionRef;
            let checklistGroupsCollectionRef;
            let checklistCategoriesCollectionRef;
            let auth;
            let usersCollectionRef, rolesCollectionRef, roleChangeRequestsCollectionRef, settingsDocRef, auditLogCollectionRef;
            const appId = typeof __app_id !== 'undefined' ? __app_id : '20LVob88b3ovXRUyX3ra';
            const firebaseConfigFromUser = {
                apiKey: "AIzaSyCCQML1UOy7NB5ohbiPZmOE6dB6oIpzlQk",
                authDomain: "top2-e9ac0.firebaseapp.com",
                projectId: "top2-e9ac0",
                storageBucket: "top2-e9ac0.firebasestorage.app",
                messagingSenderId: "21327088897",
                appId: "1:21327088897:web:3d1496dabc5dceb534df00",
                measurementId: "G-TXFM8WC5HC"
            };
            const usingEnvConfig = typeof __firebase_config !== 'undefined' && __firebase_config;
            const firebaseConfig = usingEnvConfig ? JSON.parse(__firebase_config) : firebaseConfigFromUser;

            async function logAdminAction(action, details) {
                try {
                    if (!auditLogCollectionRef) return;
                    const logData = {
                        action: action,
                        details: details,
                        performedById: currentUser.mode,
                        performedByName: currentUser.displayName,
                        performedByRole: currentUser.role,
                        timestamp: serverTimestamp()
                    }; await addDoc(auditLogCollectionRef, logData); return logData;
                } catch (error) {
                    console.error("Error logging action:", error);
                }
            }

            async function createApprovalRequest(type, userId, details = {}) {
                try {
                    // NEU: Stellt sicher, dass der Benutzername auch für neue Benutzer korrekt ausgelesen wird.
                    let reqUserName;
                    if (type === 'CREATE_USER' && details.userData) {
                        reqUserName = details.userData.name;
                    } else {
                        reqUserName = USERS[userId]?.name || 'Unbekannt';
                    }

                    const requestData = {
                        type: type,
                        userId: userId,
                        userName: reqUserName,
                        requestedById: currentUser.mode,
                        requestedByName: currentUser.displayName,
                        details: details,
                        status: 'pending',
                        timestamp: serverTimestamp()
                    };
                    await addDoc(roleChangeRequestsCollectionRef, requestData);
                    alertUser('Ihre Anfrage wurde zur Genehmigung eingereicht.', 'success');
                    localUpdateInProgress = true;
                    rememberAdminScroll();
                    renderUserManagement();
                } catch (error) {
                    console.error("Error creating approval request:", error);
                    alertUser('Fehler beim Erstellen der Anfrage.', 'error');
                }
            }


            async function initializeFirebase() {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    usersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'user-config');
                    rolesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'user-roles');
                    adminRolesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'admin-roles');
                    roleChangeRequestsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'role-change-requests');
                    auditLogCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'audit-log');
                    settingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'app-settings', 'main');
                    notrufSettingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'app-settings', 'notruf');
                    checklistsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklists');
                    checklistItemsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-items');
                    checklistGroupsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-groups');
                    checklistCategoriesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-categories');
                    const checklistStacksCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-stacks');

                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            try {
                                onSnapshot(settingsDocRef, (docSnap) => {
                                    if (docSnap.exists()) {
                                        adminSettings = docSnap.data();
                                    } else {
                                        const defaultSettings = {
                                            approvalRules: { ADMIN: true, DELETE_USER: false, CREATE_USER: false },
                                            logAccess: { adminCanSeeSysadminLogs: false },
                                            adminPermissions: { canSeePasswords: true, canSeeUsers: true, canSeeApprovals: true, canViewLogs: false },
                                            adminPermissionType: 'individual',
                                            assignedAdminRoleId: null
                                        };
                                        setDoc(settingsDocRef, defaultSettings).then(() => { adminSettings = defaultSettings; });
                                    }
                                    updateUIForMode();
                                    if (adminSectionsState.adminRights) renderAdminRightsManagement();
                                }, (error) => {
                                    console.error("Error listening to settings:", error);
                                });

                                try {
                                    onSnapshot(notrufSettingsDocRef, (docSnap) => {
                                        if (docSnap.exists()) {
                                            notrufSettings = docSnap.data();
                                            if (!notrufSettings.modes) notrufSettings.modes = [];
                                            if (!notrufSettings.contacts) notrufSettings.contacts = [];
                                            // NEUE ZEILEN ZUR INITIALISIERUNG:
                                            if (!notrufSettings.apiTokens) notrufSettings.apiTokens = [];
                                            if (!notrufSettings.sounds) notrufSettings.sounds = [];
                                            if (!notrufSettings.flicAssignments) notrufSettings.flicAssignments = { einfach: null, doppel: null, halten: null };
                                        } else {
                                            // Standardwerte, falls das Dokument nicht existiert
                                            notrufSettings = {
                                                modes: [],
                                                contacts: [],
                                                apiTokens: [],
                                                sounds: [],
                                                flicAssignments: { einfach: null, doppel: null, halten: null }
                                            };
                                            setDoc(notrufSettingsDocRef, notrufSettings);
                                        }
                                        // Wenn die Einstellungsseite offen ist, aktualisiere die UI
                                    }, (error) => {
                                        console.error("Error listening to notruf settings:", error);
                                    });
                                } catch (error) {
                                    console.error("Error setting up notruf listener:", error);
                                }

                                await seedInitialData();
                                listenForRoleUpdates();
                                listenForAdminRoleUpdates();
                                listenForUserUpdates();
                                listenForApprovalRequests();
                                listenForChecklists();
                                listenForChecklistItems();
                                listenForChecklistGroups();
                                listenForChecklistCategories();
                                listenForTemplates();

                                // KORRIGIERTER LISTENER FÜR STACKS
                                onSnapshot(query(checklistStacksCollectionRef, orderBy('name')), (snapshot) => {
                                    CHECKLIST_STACKS = {};
                                    snapshot.forEach((doc) => {
                                        CHECKLIST_STACKS[doc.id] = { id: doc.id, ...doc.data() };
                                    });

                                    const settingsView = document.getElementById('checklistSettingsView');
                                    if (settingsView.classList.contains('active')) {
                                        const activeTab = settingsView.querySelector('#settings-tabs .settings-tab-btn.bg-white');
                                        const activeTabId = activeTab ? activeTab.dataset.targetCard : null;

                                        // Nur neu rendern, wenn der "Stack & Container" Tab aktiv ist.
                                        if (activeTabId === 'card-templates') {
                                            renderChecklistSettingsView();
                                            const tabToReactivate = document.querySelector('button[data-target-card="card-templates"]');
                                            if (tabToReactivate) tabToReactivate.click();
                                        }
                                    }
                                });

                            } catch (error) {
                                console.error("Fatal error during app initialization:", error);
                                alertUser("Ein kritischer Fehler ist beim Start aufgetreten.", "error");
                                switchToGuestMode(false);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    });
                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    alertUser("Firebase konnte nicht initialisiert werden. Bitte Seite neu laden.", "error");
                }
            }
            async function seedInitialData() {
                try {
                    const rolesSnapshot = await getDocs(rolesCollectionRef);
                    if (rolesSnapshot.empty) {
                        const batch = writeBatch(db);
                        const defaultRoles = {
                            SYSTEMADMIN: { name: 'Systemadmin', permissions: ['ENTRANCE', 'PUSHOVER', 'CHECKLIST', 'CHECKLIST_SWITCH', 'CHECKLIST_SETTINGS', 'ESSENSBERECHNUNG'], deletable: false },
                            ADMIN: { name: 'Admin', permissions: ['ENTRANCE', 'PUSHOVER'], deletable: false },
                            ANGEMELDET: { name: 'Angemeldet', permissions: ['ENTRANCE'], deletable: true },
                            NO_RIGHTS: { name: '- Keine Rechte -', permissions: [], deletable: false }
                        };
                        Object.keys(defaultRoles).forEach(roleId => batch.set(doc(rolesCollectionRef, roleId), defaultRoles[roleId]));
                        await batch.commit();
                    } else {
                        // Stellt sicher, dass die neue Rolle auch bei bestehenden Installationen hinzugefügt wird
                        const noRightsDoc = doc(rolesCollectionRef, 'NO_RIGHTS');
                        const noRightsSnap = await getDoc(noRightsDoc);
                        if (!noRightsSnap.exists()) {
                            await setDoc(noRightsDoc, { name: '- Keine Rechte -', permissions: [], deletable: false });
                        }
                    }

                    const adminRolesSnapshot = await getDocs(adminRolesCollectionRef);
                    const emptyRoleDoc = doc(adminRolesCollectionRef, 'LEERE_ROLLE');
                    const emptyRoleSnapshot = await getDoc(emptyRoleDoc);
                    if (!emptyRoleSnapshot.exists()) {
                        await setDoc(emptyRoleDoc, { name: '** Leere Rolle**', permissions: {}, deletable: false });
                    }

                    const usersSnapshot = await getDocs(usersCollectionRef);
                    if (usersSnapshot.empty) {
                        await setDoc(doc(usersCollectionRef, 'SYSTEMADMIN'), { name: 'Systemadmin', key: 'top2sys', role: 'SYSTEMADMIN', isActive: true });
                    }
                } catch (error) {
                    console.error("Error in seedInitialData:", error);
                    throw error;
                }
            }
            const views = { home: { id: 'homeView' }, entrance: { id: 'entranceView' }, pushover: { id: 'pushoverView' }, admin: { id: 'adminView' }, userSettings: { id: 'userSettingsView' }, checklist: { id: 'checklistView' }, checklistSettings: { id: 'checklistSettingsView' }, essensberechnung: { id: 'essensberechnungView' }, notrufSettings: { id: 'notrufSettingsView' } }; const viewElements = Object.fromEntries(Object.keys(views).map(key => [key + 'View', document.getElementById(views[key].id)]));
            const appHeader = document.getElementById('appHeader');
            const footerModeHandler = document.getElementById('footerModeHandler');
            const modeTextDisplay = document.getElementById('modeTextDisplay');
            const userSelectionModal = document.getElementById('userSelectionModal');
            const pinModal = document.getElementById('pinModal');
            const pinModalTitle = document.getElementById('pinModalTitle');
            const modalUserButtons = document.getElementById('modalUserButtons');
            const adminPinInput = document.getElementById('adminPinInput');
            const pinError = document.getElementById('pinError');
            const mainSettingsButton = document.getElementById('mainSettingsButton');
            const adminRightsSection = document.getElementById('adminRightsSection');
            const adminRightsToggle = document.getElementById('adminRightsToggle');
            const adminRightsArea = document.getElementById('adminRightsArea');
            const adminRightsToggleIcon = document.getElementById('adminRightsToggleIcon');
            const roleManagementSection = document.getElementById('roleManagementSection');
            const roleSettingsToggle = document.getElementById('roleSettingsToggle');
            const roleManagementArea = document.getElementById('roleManagementArea');
            const roleToggleIcon = document.getElementById('roleToggleIcon');
            const passwordSection = document.getElementById('passwordSection');
            const passwordSettingsToggle = document.getElementById('passwordSettingsToggle');
            const passwordManagementArea = document.getElementById('passwordManagementArea');
            const passwordToggleIcon = document.getElementById('passwordToggleIcon');
            const userSection = document.getElementById('userSection');
            const userManagementToggle = document.getElementById('userManagementToggle');
            const userManagementArea = document.getElementById('userManagementArea');
            const userManagementToggleIcon = document.getElementById('userManagementToggleIcon');
            const approvalProcessSection = document.getElementById('approvalProcessSection');
            const approvalProcessToggle = document.getElementById('approvalProcessToggle');
            const approvalProcessArea = document.getElementById('approvalProcessArea');
            const approvalToggleIcon = document.getElementById('approvalToggleIcon');
            const protocolHistorySection = document.getElementById('protocolHistorySection');
            const protocolHistoryToggle = document.getElementById('protocolHistoryToggle');
            const protocolHistoryArea = document.getElementById('protocolHistoryArea');
            const protocolHistoryToggleIcon = document.getElementById('protocolHistoryToggleIcon');
            const noAdminPermissionsPrompt = document.getElementById('noAdminPermissionsPrompt');
            const mainFunctionsSection = document.getElementById('mainFunctionsSection');
            const mainFunctionsToggle = document.getElementById('mainFunctionsToggle');
            const mainFunctionsArea = document.getElementById('mainFunctionsArea');
            const mainFunctionsToggleIcon = document.getElementById('mainFunctionsToggleIcon');
            const notrufView = document.getElementById('notrufSettingsView'); // <--- ADD THIS LINE IF MISSING

            function listenForRoleUpdates() {
                onSnapshot(rolesCollectionRef, (snapshot) => {
                    ROLES = {};
                    snapshot.forEach((doc) => { ROLES[doc.id] = { id: doc.id, ...doc.data() }; });
                    checkCurrentUserValidity();
                    if (adminSectionsState.role) renderRoleManagement();
                    if (adminSectionsState.adminRights) renderAdminRightsManagement();
                }, (error) => {
                    console.error("Error listening for role updates:", error);
                });
            }

            function listenForAdminRoleUpdates() {
                onSnapshot(adminRolesCollectionRef, (snapshot) => {
                    ADMIN_ROLES = {};
                    snapshot.forEach((doc) => { ADMIN_ROLES[doc.id] = { id: doc.id, ...doc.data() }; });
                    if (adminSectionsState.adminRights) renderAdminRightsManagement();
                    if (adminSectionsState.role) renderRoleManagement();
                }, (error) => {
                    console.error("Error listening for admin role updates:", error);
                });
            }


            function listenForUserUpdates() {
                const mainContent = document.querySelector('.main-content');

                onSnapshot(usersCollectionRef, (snapshot) => {

                    USERS = {};
                    snapshot.forEach((doc) => { USERS[doc.id] = { id: doc.id, ...doc.data() }; });

                    // Verhindert ein Neuzeichnen, wenn die Änderung vom User selbst kam
                    checkCurrentUserValidity();
                    renderModalUserButtons();

                    // Prüft, ob geöffnete Admin-Sektionen neu gezeichnet werden müssen
                    // Prüft, ob geöffnete Admin-Sektionen neu gezeichnet werden müssen
                    const isAdminViewActive = document.getElementById('adminView').classList.contains('active');

                    if (isAdminViewActive) {
                        if (adminSectionsState.password) {
                            renderUserKeyList();
                        }
                        if (adminSectionsState.user) {
                            renderUserManagement();
                        }
                        if (adminSectionsState.role) {
                            renderRoleManagement();
                        }
                        if (adminSectionsState.protocol) {
                            renderProtocolHistory();
                        }
                    }
                }, (error) => {
                    console.error("Error listening for user updates:", error);
                });

            }

            function listenForApprovalRequests() {
                onSnapshot(query(roleChangeRequestsCollectionRef, orderBy('timestamp', 'desc')), (snapshot) => {
                    if (adminSectionsState.approval) {
                        renderApprovalProcess(snapshot);
                    }
                    if (adminSectionsState.user) {
                        renderUserManagement();
                    }
                });
            }

            // NEUE FUNKTION HINZUFÜGEN
            // NEUE FUNKTION HINZUFÜGEN
            function setDefaultPortionName() {
                const personId = document.getElementById('person-select').value;
                const nameInput = document.getElementById('portion-name');
                if (!nameInput || !personId) {
                    nameInput.value = ''; // Leeren, wenn keine Person gewählt ist
                    return;
                };

                const weekdays = ["Sonntag", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag"];
                const today = new Date();

                // Beginne mit dem heutigen Tag
                let nextDayIndex = today.getDay();

                let suggestedName = '';
                // Loop durch maximal 7 Tage, um einen freien Tag zu finden
                for (let i = 0; i < 7; i++) {
                    const potentialName = weekdays[nextDayIndex];
                    // Prüfen, ob dieser Name für den gewählten User schon existiert
                    const nameExists = currentMeal.userInputDistribution.some(
                        p => p.personId === personId && p.portionName.toLowerCase() === potentialName.toLowerCase()
                    );

                    if (!nameExists) {
                        suggestedName = potentialName;
                        break; // Freien Tag gefunden, Schleife beenden
                    }
                    // Zum nächsten Tag weitergehen
                    nextDayIndex = (nextDayIndex + 1) % 7;
                }

                // Setze den gefundenen Namen oder einen Fallback, falls alle Tage belegt sind
                nameInput.value = suggestedName || weekdays[nextDayIndex];
            } function listenForTemplates() {
                const templatesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-templates');
                onSnapshot(query(templatesCollectionRef, orderBy('name')), (snapshot) => {
                    TEMPLATES = {};
                    snapshot.forEach((doc) => {
                        TEMPLATES[doc.id] = { id: doc.id, ...doc.data() };
                    });

                    const settingsView = document.getElementById('checklistSettingsView');
                    if (settingsView.classList.contains('active')) {
                        const activeTab = settingsView.querySelector('#settings-tabs .settings-tab-btn.bg-white');
                        if (activeTab && activeTab.dataset.targetCard === 'card-templates') {
                            renderContainerList(); // Ruft nur die Funktion zum Neuzeichnen der Container-Liste auf
                        }
                    }
                });
            }

            function checkCurrentUserValidity() {
                // Dieser "Spion" sagt uns, wann die Funktion aufgerufen wird.
                console.log("--- Prüfe Benutzerberechtigungen ---");

                if (Object.keys(USERS).length === 0 || Object.keys(ROLES).length === 0) {
                    return;
                }

                const storedKey = localStorage.getItem(ADMIN_STORAGE_KEY);
                const user = USERS[storedKey];

                // Dieser Spion zeigt uns das komplette Benutzer-Objekt, mit dem wir arbeiten.
                if (user) {
                    console.log("Aktuelles Benutzer-Objekt aus der Datenbank:", user);
                }

                if (user && user.isActive) {
                    let userPermissions = [];
                    let permissionSource = "Unbekannt"; // Eine Notiz, woher die Rechte kommen.

                    if (user.role === 'SYSTEMADMIN') {
                        userPermissions = ['ENTRANCE', 'PUSHOVER', 'CHECKLIST', 'CHECKLIST_SWITCH', 'CHECKLIST_SETTINGS', 'ESSENSBERECHNUNG'];
                        permissionSource = "Feste Regel für SYSTEMADMIN";
                    } else if (user.role === 'ADMIN') {
                        userPermissions = ROLES['ADMIN']?.permissions || [];
                        permissionSource = "Aus der Rollenverwaltung für 'ADMIN'";
                        // Dieser Spion zeigt uns, was genau für die ADMIN-Rolle gefunden wurde.
                        console.log("Für ADMIN-Rolle gefundene Rechte:", ROLES['ADMIN']?.permissions);

                    } else if (user.permissionType === 'individual') {
                        userPermissions = user.customPermissions || [];
                        permissionSource = "Aus den individuellen Einstellungen des Benutzers";

                    } else if (user.role && ROLES[user.role]) {
                        userPermissions = ROLES[user.role].permissions || [];
                        permissionSource = `Aus der Rollenverwaltung für '${user.role}'`;
                    }

                    // Dieser Spion gibt das Endergebnis aus.
                    console.log(`Quelle der Berechtigungen: ${permissionSource}`);
                    console.log("Final zugewiesene Berechtigungen:", userPermissions);

                    currentUser = {
                        mode: storedKey,
                        displayName: user.name,
                        role: user.role,
                        permissions: userPermissions
                    };
                } else {
                    if (currentUser.mode !== GUEST_MODE) {
                        switchToGuestMode(true, "Ihr Profil ist nicht mehr gültig oder wurde deaktiviert.");
                    } else if (storedKey && USERS[storedKey] && !USERS[storedKey].isActive) {
                        switchToGuestMode(true, "Ihr Profil wurde deaktiviert.");
                    } else {
                        switchToGuestMode(false);
                    }
                }
                updateUIForMode();

                const activeView = document.querySelector('.view.active');
                if (!activeView) return;
                const isAdminView = activeView.id === 'adminView';
                if (isAdminView && !(currentUser.role === 'ADMIN' || currentUser.role === 'SYSTEMADMIN')) {
                    alertUser("Ihre Administrator-Rechte wurden entzogen.", "error");
                    navigate('home');
                }
            }
            function alertUser(message, type) {
                const tempAlert = document.createElement('div');
                tempAlert.textContent = message;
                tempAlert.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-4 rounded-xl text-white font-bold shadow-lg transition-opacity duration-300 z-50 text-center ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
                document.body.appendChild(tempAlert);
                setTimeout(() => tempAlert.style.opacity = '1', 10);
                setTimeout(() => {
                    tempAlert.style.opacity = '0';
                    setTimeout(() => tempAlert.remove(), 300);
                }, 3000);
            }

            function setButtonLoading(button, isLoading) {
                const text = button.querySelector('.button-text');
                const spinner = button.querySelector('.loading-spinner');
                button.disabled = isLoading;
                if (text) text.style.display = isLoading ? 'none' : 'inline-block';
                if (spinner) spinner.style.display = isLoading ? 'inline-block' : 'none';
            }


            function navigate(targetViewName) {
                const targetView = views[targetViewName];
                if (!targetView) return;

                const userPermissions = currentUser.permissions;
                if (['entrance', 'pushover'].includes(targetViewName) && !userPermissions.includes(targetViewName.toUpperCase())) {
                    return alertUser("Zugriff verweigert.", 'error');
                }
                const isAdmin = currentUser.role === 'ADMIN' || currentUser.role === 'SYSTEMADMIN';
                if (targetViewName === 'admin' && !isAdmin) {
                    return alertUser("Zugriff verweigert.", 'error');
                }

                document.querySelector('.main-content').scrollTop = 0;
                Object.values(viewElements).forEach(el => el && el.classList.remove('active'));
                document.getElementById(targetView.id).classList.add('active');

                updateUIForMode();

                if (targetViewName === 'userSettings') {
                    document.getElementById('userSettingsName').textContent = `Passwort für ${currentUser.displayName} ändern`;
                    const user = USERS[currentUser.mode];
                    document.getElementById('currentUserKeyDisplay').style.display = user?.key ? 'block' : 'none';
                    if (user?.key) document.getElementById('currentUserKeyDisplay').innerHTML = `<p class="text-lg">Dein aktuelles Passwort lautet: <strong class="font-bold">${user.key}</strong></p>`;
                }
                if (targetViewName === 'essensberechnung') {
                    initializeEssensberechnungView();
                }
                // HIER DEN NEUEN BLOCK HINZUFÜGEN
                // Ersetze diesen Block in der 'navigate()'-Funktion:
                // Ersetze diesen Block in der 'navigate()'-Funktion:
                if (targetViewName === 'notrufSettings') {
                    initializeNotrufSettingsView(); // Lädt Daten im Hintergrund

                    // Setzt den visuellen Standard-Zustand zurück (Prompt sichtbar)
                    const prompt = document.getElementById('notruf-prompt');
                    if (prompt) prompt.style.display = 'block';

                    const flicCard = document.getElementById('card-flic-notruf');
                    if (flicCard) flicCard.classList.add('hidden');

                    const appCard = document.getElementById('card-app-notruf');
                    if (appCard) appCard.classList.add('hidden');

                    // Tab-Stile zurücksetzen
                    document.querySelectorAll('#notruf-settings-tabs .settings-tab-btn').forEach(tab => {
                        tab.classList.remove('bg-white', 'shadow', 'text-indigo-600');
                        tab.classList.add('text-gray-600');
                    });

                    // Akkordeon einklappen, falls es offen war
                    const configArea = document.getElementById('notrufConfigArea');
                    const configIcon = document.getElementById('notrufConfigToggleIcon'); // Hole das Icon

                    // --- KORREKTUR START ---
                    // Stelle sicher, dass BEIDE Elemente (configArea UND configIcon) existieren,
                    // bevor du versuchst, Klassen zu ändern.
                    if (configArea && configIcon && !configArea.classList.contains('hidden')) {
                        configArea.classList.add('hidden');
                        configIcon.classList.remove('rotate-180'); // Jetzt ist der Zugriff sicher
                    }
                    // --- KORREKTUR ENDE ---
                }
            }


            function switchToGuestMode(showNotification = true, message = "Abgemeldet. Modus ist nun 'Gast'.") {
                currentUser = { mode: GUEST_MODE, displayName: GUEST_MODE, permissions: [], role: null };
                localStorage.removeItem(ADMIN_STORAGE_KEY);
                updateUIForMode();
                navigate('home');
                if (showNotification) alertUser(message, 'success');
            }

            function renderModalUserButtons() {
                modalUserButtons.innerHTML = '';
                // NEU: Farben für den linken Rand der Karten definieren
                const ROLE_BORDER_COLORS = {
                    ADMIN: 'border-red-500',
                    SYSTEMADMIN: 'border-purple-700',
                    DEFAULT: 'border-indigo-500'
                };

                const allUsers = Object.values(USERS).filter(u => u.name);

                allUsers.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'select-user-button w-full p-4 bg-gray-50 hover:bg-indigo-50 rounded-lg shadow-sm flex items-center gap-4 cursor-pointer transition duration-150 border-l-4';
                    userCard.dataset.user = user.id;

                    const borderColor = ROLE_BORDER_COLORS[user.role] || ROLE_BORDER_COLORS.DEFAULT;
                    userCard.classList.add(borderColor);

                    userCard.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6 text-gray-400">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.99 5.99 0 0 0-4.793 2.39A6.483 6.483 0 0 0 10 16.5a6.483 6.483 0 0 0 4.793-2.11A5.99 5.99 0 0 0 10 12Z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-lg font-medium text-gray-800">${user.name}</span>
                `;
                    modalUserButtons.appendChild(userCard);
                });
            }

            function updateUIForMode() {
                const isAdmin = currentUser.role === 'ADMIN';
                const isSysAdmin = currentUser.role === 'SYSTEMADMIN';
                let effectiveAdminPerms = {};
                if (isAdmin) {
                    const adminUser = USERS[currentUser.mode];
                    if (adminUser) {
                        if (adminUser.permissionType === 'role' && adminUser.assignedAdminRoleId && ADMIN_ROLES[adminUser.assignedAdminRoleId]) {
                            effectiveAdminPerms = ADMIN_ROLES[adminUser.assignedAdminRoleId].permissions || {};
                        } else {
                            effectiveAdminPerms = adminUser.adminPermissions || {};
                        }
                    }
                }

                document.querySelectorAll('[data-permission]').forEach(card => {
                    const permission = card.dataset.permission;
                    if (permission === 'CHECKLIST') {
                        card.style.display = currentUser.permissions.includes('CHECKLIST') ? 'block' : 'none';
                    } else {
                        card.style.display = currentUser.permissions.includes(permission) ? 'flex' : 'none';
                    }
                });

                const settingsButton = document.getElementById('mainSettingsButton');
                const adminButton = document.getElementById('mainAdminButton');
                settingsButton.style.display = 'none';
                adminButton.style.display = 'none';

                if (document.getElementById('homeView').classList.contains('active')) {
                    if (isSysAdmin) {
                        adminButton.style.display = 'block';
                        adminButton.textContent = 'SYS-ADMIN';
                        adminButton.className = 'bg-purple-800 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-lg hover:bg-opacity-80 transition z-10';
                    } else if (isAdmin) {
                        adminButton.style.display = 'block';
                        adminButton.textContent = 'ADMIN';
                        adminButton.className = 'bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-lg shadow-lg hover:bg-red-700 transition z-10';
                    }

                    // --- START DER ÄNDERUNG ---
                    // Prüft, ob der Benutzer die Passwort-Sektion sehen darf.
                    const canSeePasswords = isSysAdmin || (isAdmin && effectiveAdminPerms.canSeePasswords);

                    // Der "Einstellungen"-Button wird angezeigt, wenn der Benutzer angemeldet ist UND die Passwort-Sektion NICHT sehen darf.
                    // Das gilt für normale Benutzer und für Admins ohne das entsprechende Recht.
                    if (currentUser.mode !== GUEST_MODE && !canSeePasswords) {
                        settingsButton.style.display = 'block';
                    }
                    // --- ENDE DER ÄNDERUNG ---
                }

                const checklistSettingsCard = document.getElementById('checklistSettingsCard');
                if (checklistSettingsCard) {
                    checklistSettingsCard.style.display = currentUser.permissions.includes('CHECKLIST_SETTINGS') ? 'flex' : 'none';
                }

                adminRightsSection.style.display = isSysAdmin ? 'block' : 'none';
                roleManagementSection.style.display = isSysAdmin || (isAdmin && effectiveAdminPerms.canSeeRoleManagement) ? 'block' : 'none';
                passwordSection.style.display = isSysAdmin || (isAdmin && effectiveAdminPerms.canSeePasswords) ? 'block' : 'none';
                userSection.style.display = isSysAdmin || (isAdmin && effectiveAdminPerms.canSeeUsers) ? 'block' : 'none';

                // --- START DER ÄNDERUNG ---
                // Die Sichtbarkeit dieses Menüpunkts wird jetzt durch die Rechte gesteuert.
                const mainFunctionsSection = document.getElementById('mainFunctionsSection');
                mainFunctionsSection.style.display = isSysAdmin || (isAdmin && effectiveAdminPerms.canSeeMainFunctions) ? 'block' : 'none';
                // --- ENDE DER ÄNDERUNG ---

                approvalProcessSection.style.display = isSysAdmin || (isAdmin && effectiveAdminPerms.canSeeApprovals) ? 'block' : 'none';
                protocolHistorySection.style.display = isSysAdmin || (isAdmin && effectiveAdminPerms.canViewLogs) ? 'block' : 'none';

                const guestPrompt = document.getElementById('guestPrompt');
                const noPermissionPrompt = document.getElementById('noPermissionPrompt');
                guestPrompt.style.display = 'none';
                noPermissionPrompt.style.display = 'none';
                noAdminPermissionsPrompt.style.display = 'none';

                if (currentUser.mode === GUEST_MODE) {
                    guestPrompt.style.display = 'block';
                } else if (currentUser.permissions.length === 0 && !isAdmin && !isSysAdmin) {
                    noPermissionPrompt.style.display = 'block';
                }

                if (isAdmin && document.getElementById('adminView').classList.contains('active')) {
                    const hasAnyPermission = Object.values(effectiveAdminPerms).some(perm => perm === true);
                    noAdminPermissionsPrompt.style.display = hasAnyPermission ? 'none' : 'block';
                }

                const footerUser = document.getElementById('footerUser');
                const footerLogout = document.getElementById('footerLogout');
                footerUser.innerHTML = '';
                footerLogout.innerHTML = '';

                if (currentUser.mode === GUEST_MODE) {
                    footerUser.textContent = 'Nicht angemeldet';
                    const loginButton = document.createElement('button');
                    loginButton.textContent = 'Anmelden';
                    loginButton.className = 'font-bold text-indigo-400 hover:text-indigo-300';
                    loginButton.onclick = () => userSelectionModal.style.display = 'flex';
                    footerLogout.appendChild(loginButton);
                } else {
                    const user = USERS[currentUser.mode];
                    const effectiveRoleId = user?.role || user?.displayRole;
                    const roleName = ROLES[effectiveRoleId]?.name || 'Unbekannt';

                    let roleColor = 'text-gray-300';
                    if (currentUser.role === 'SYSTEMADMIN') roleColor = 'text-purple-400 font-bold';
                    if (currentUser.role === 'ADMIN') roleColor = 'text-red-400 font-bold';

                    footerUser.innerHTML = `${currentUser.displayName} <span class="mx-1 text-gray-400">❖</span> <span class="${roleColor} italic">(${roleName})</span>`;

                    const logoutButton = document.createElement('button');
                    logoutButton.id = 'logoutButton';
                    logoutButton.textContent = 'Ausloggen';
                    logoutButton.className = 'font-bold text-white hover:text-gray-300';
                    footerLogout.appendChild(logoutButton);

                    logoutButton.onclick = () => {
                        footerLogout.innerHTML = '';
                        const confirmationText = document.createElement('span');
                        confirmationText.className = 'font-bold mr-3';
                        confirmationText.textContent = 'Sicher ausloggen?';
                        const noButton = document.createElement('button');
                        noButton.textContent = 'NEIN';
                        noButton.className = 'font-bold text-gray-300 hover:text-white mr-3';
                        noButton.onclick = () => updateUIForMode();
                        const yesButton = document.createElement('button');
                        yesButton.textContent = 'JA';
                        yesButton.className = 'font-bold text-red-400 hover:text-red-300';
                        yesButton.onclick = () => switchToGuestMode();
                        footerLogout.append(confirmationText, noButton, yesButton);
                    };
                }

                const checklistNameDisplay = document.getElementById('current-checklist-name-display');
                if (checklistNameDisplay) {
                    const defaultListId = adminSettings.defaultChecklistId;
                    const checklistName = CHECKLISTS[defaultListId]?.name;
                    if (checklistName) {
                        checklistNameDisplay.textContent = checklistName;
                    } else {
                        checklistNameDisplay.textContent = '(Keine Liste gewählt)';
                    }
                }
            }
            function renderUserKeyList() {
                userKeyList.innerHTML = '';
                const isAdmin = currentUser.role === 'ADMIN';
                const isSysAdmin = currentUser.role === 'SYSTEMADMIN';

                Object.values(USERS).sort((a, b) => a.name.localeCompare(b.name)).forEach(user => {
                    const userId = user.id;
                    if (!user.name) return;

                    const isSelf = userId === currentUser.mode;
                    const isTargetSysAdmin = user.role === 'SYSTEMADMIN';

                    // Ein SysAdmin kann nur sich selbst, aber keinen anderen SysAdmin bearbeiten.
                    // Ein normaler Admin kann keinen SysAdmin bearbeiten.
                    const canEditKey = isSelf || (isSysAdmin && !isTargetSysAdmin) || (isAdmin && !isTargetSysAdmin);

                    // Die Sichtbarkeit des Schlüssels unterliegt den gleichen Regeln.
                    const canViewKey = canEditKey;

                    const keyDisplay = canViewKey ? (user.key || 'Nicht gesetzt') : '••••••••••';
                    const currentUserLabel = isSelf ? '<span class="bg-indigo-100 text-indigo-800 font-bold text-xs px-2 py-1 rounded-full ml-2">AKTUELL</span>' : '';

                    const userDiv = document.createElement('div');
                    // Visuelles Feedback: Gesperrte Karten werden ausgegraut
                    userDiv.className = `p-3 border rounded-lg ${!canEditKey ? 'bg-gray-200 opacity-70' : 'bg-gray-50'}`;
                    userDiv.innerHTML = `
            <p class="font-bold text-gray-800 flex items-center">${user.name} ${currentUserLabel}</p>
            <p class="text-xs text-gray-500 mb-2">Rolle: ${ROLES[user.role]?.name || ROLES[user.displayRole]?.name || 'Keine Rolle'}</p>
            <div class="mb-3"><label class="block text-xs font-medium text-gray-600">Aktueller Schlüssel</label><input type="text" value="${keyDisplay}" class="w-full p-2 bg-gray-200 border rounded-md text-sm text-gray-700" readonly></div>
            <div class="flex space-x-2">
                <input type="password" class="new-key-input flex-grow p-2 border rounded-lg text-sm" placeholder="Neuen Schlüssel eingeben" ${!canEditKey ? 'disabled' : ''}>
                <button class="save-key-button py-2 px-3 bg-blue-600 text-white text-sm font-semibold rounded-lg ${!canEditKey ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-700'}" data-userid="${userId}" ${!canEditKey ? 'disabled' : ''}>Speichern</button>
            </div>`;
                    userKeyList.appendChild(userDiv);
                });

                userKeyList.querySelectorAll('.save-key-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userId = e.target.dataset.userid;
                        const isSelf = userId === currentUser.mode;
                        if (!isSelf && !confirm(`Möchten Sie das Passwort für ${USERS[userId].name} wirklich ändern?`)) return;

                        const newKey = e.target.previousElementSibling.value;
                        if (newKey.length < 4) return alertUser("Schlüssel muss mind. 4 Zeichen haben.", "error");

                        await updateDoc(doc(usersCollectionRef, userId), { key: newKey });
                        await logAdminAction('password_changed', `Passwort für '${USERS[userId].name}' wurde geändert.`);
                        alertUser(`Schlüssel für ${USERS[userId].name} wurde aktualisiert!`, "success");
                        e.target.previousElementSibling.value = '';
                    });
                });
            }

            // Scroll-Position vor/neben einem Live-Reload merken/wiederherstellen
            function rememberAdminScroll() {
                const scroller = document.querySelector('.main-content') || document.scrollingElement || document.documentElement;
                if (scroller) sessionStorage.setItem('adminScrollY', String(scroller.scrollTop));
            }

            function restoreAdminScrollIfAny() {
                const scroller = document.querySelector('.main-content') || document.scrollingElement || document.documentElement;
                const y = Number(sessionStorage.getItem('adminScrollY'));
                if (scroller && !Number.isNaN(y)) {
                    scroller.scrollTo({ top: y, behavior: 'instant' in scroller ? 'instant' : undefined });
                    sessionStorage.removeItem('adminScrollY');
                }
            }

            // ### Globaler Restore: funktioniert ohne DOMContentLoaded und wartet auf den Container
            (function setupGlobalScrollRestore() {
                const ROOT_SELECTOR = '.main-content'; // <— falls dein Haupt-Container anders heißt, hier anpassen

                let observer = null;

                function initObserver(rootEl) {
                    if (!rootEl) return;
                    if (observer) observer.disconnect();

                    observer = new MutationObserver(() => {
                        if (sessionStorage.getItem('adminScrollY') !== null) {
                            restoreAdminScrollIfAny(); // nutzt deine Helfer-Funktion
                        }
                    });

                    observer.observe(rootEl, { childList: true, subtree: true });
                }

                function getRootCandidate() {
                    return document.querySelector(ROOT_SELECTOR) || document.body || document.documentElement;
                }

                // Wiederholt versuchen, bis der richtige Container existiert
                (function waitForRoot() {
                    const root = getRootCandidate();
                    if (root) {
                        initObserver(root);

                        // Falls anfangs nur <body> existiert und später .main-content kommt, hängen wir uns um
                        const reattachWatcher = new MutationObserver(() => {
                            const main = document.querySelector(ROOT_SELECTOR);
                            if (main && main !== root) {
                                initObserver(main);
                                reattachWatcher.disconnect();
                            }
                        });
                        reattachWatcher.observe(document.documentElement, { childList: true, subtree: true });
                        return;
                    }
                    // Noch nicht bereit? Im nächsten Frame nochmal probieren.
                    requestAnimationFrame(waitForRoot);
                })();
            })();


            async function renderUserManagement() {
                if (!roleChangeRequestsCollectionRef) {
                    userManagementArea.innerHTML = `<p class="text-center text-red-500">Datenbankverbindung wird noch aufgebaut. Bitte warten Sie einen Moment...</p>`;
                    setTimeout(renderUserManagement, 500);
                    return;
                }

                let effectiveAdminPerms = {};
                const isAdmin = currentUser.role === 'ADMIN';
                const isSysAdminEditing = currentUser.role === 'SYSTEMADMIN';

                if (isAdmin) {
                    const adminUser = USERS[currentUser.mode];
                    if (adminUser) {
                        if (adminUser.permissionType === 'role' && adminUser.assignedAdminRoleId && ADMIN_ROLES[adminUser.assignedAdminRoleId]) {
                            effectiveAdminPerms = ADMIN_ROLES[adminUser.assignedAdminRoleId].permissions || {};
                        } else {
                            effectiveAdminPerms = adminUser.adminPermissions || {};
                        }
                    }
                }

                userManagementArea.innerHTML = `
        <button id="showAddUserFormBtn" class="w-full p-3 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition shadow-md">+ Benutzer anlegen</button>
        <div id="addUserFormContainer" class="p-4 border rounded-xl bg-green-50 hidden">
             <h4 class="font-bold text-lg text-green-800 mb-2">Neuen Benutzer anlegen</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <input type="text" id="newUserName" class="p-2 border rounded-lg" placeholder="Anzeigename">
                <input type="password" id="newUserKey" class="p-2 border rounded-lg" placeholder="Passwort (mind. 4 Zeichen)">
                <select id="newUserRole" class="p-2 border rounded-lg bg-white"></select>
                <button id="saveNewUserButton" class="p-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Erstellen</button>
            </div>
        </div>`;

                const showAddUserFormBtn = userManagementArea.querySelector('#showAddUserFormBtn');
                const canCreate = isSysAdminEditing || (isAdmin && effectiveAdminPerms.canCreateUser);
                if (!canCreate) {
                    showAddUserFormBtn.style.display = 'none';
                }

                const q = query(roleChangeRequestsCollectionRef, where("status", "==", "pending"));
                const pendingSnapshot = await getDocs(q);
                const pendingRequests = pendingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const newUserRoleSelect = userManagementArea.querySelector('#newUserRole');
                if (newUserRoleSelect) {
                    Object.values(ROLES).filter(r => r.id !== 'SYSTEMADMIN' && r.id !== 'ADMIN' && r.id !== 'NO_RIGHTS').forEach(role => {
                        newUserRoleSelect.innerHTML += `<option value="${role.id}" ${role.id === 'ANGEMELDET' ? 'selected' : ''}>${role.name}</option>`;
                    });
                }

                const allPermissions = {
                    'ENTRANCE': 'Haupteingang öffnen',
                    'PUSHOVER': 'Push-Nachricht senden',
                    'CHECKLIST': 'Aktuelle Checkliste',
                    'CHECKLIST_SWITCH': '-> Listen umschalten',
                    'CHECKLIST_SETTINGS': '-> Checkliste-Einstellungen',
                    'ESSENSBERECHNUNG': 'Essensberechnung' // <-- DIESE ZEILE HINZUFÜGEN
                };
                const displayRoleOptions = Object.values(ROLES)
                    .filter(r => (isSysAdminEditing || r.id !== 'SYSTEMADMIN'))
                    .map(role => {
                        const cleanName = role.name.replace(/-/g, '').trim();
                        return `<option value="${role.id}">${cleanName}</option>`;
                    })
                    .join('');


                Object.values(USERS).sort((a, b) => a.name.localeCompare(b.name)).forEach(user => {
                    const userId = user.id;
                    const isSelf = userId === currentUser.mode;
                    const isTargetSysAdmin = user.role === 'SYSTEMADMIN';
                    const isTargetAdmin = user.role === 'ADMIN';

                    // --- START DER ÄNDERUNG ---
                    let canEdit = false;
                    if (isSysAdminEditing) {
                        // Ein Systemadmin darf jeden bearbeiten, außer sich selbst.
                        canEdit = !isSelf;
                    }
                    else if (isAdmin) {
                        // Ein normaler Admin darf niemanden bearbeiten, der Admin oder Systemadmin ist.
                        canEdit = !isTargetSysAdmin && !isTargetAdmin;
                    }
                    // --- ENDE DER ÄNDERUNG ---

                    const permSet = (isSysAdminEditing) ? { canToggleUserActive: true, canDeleteUser: true, canRenameUser: true, canChangeUserPermissionType: true } : effectiveAdminPerms;
                    const canToggle = permSet.canToggleUserActive && canEdit && !isSelf;
                    const canDelete = permSet.canDeleteUser && canEdit && !isSelf;
                    const canRename = permSet.canRenameUser && canEdit;
                    const canChangePerms = permSet.canChangeUserPermissionType && canEdit;

                    let selectedDisplayRole;
                    if (user.role === 'ADMIN' && user.permissionType === 'individual') {
                        selectedDisplayRole = 'ADMIN';
                    } else {
                        selectedDisplayRole = user.displayRole || 'NO_RIGHTS';
                    }
                    const finalDisplayRoleOptionsWithSelection = displayRoleOptions.replace(`value="${selectedDisplayRole}"`, `value="${selectedDisplayRole}" selected`);

                    let permissionsHTML = `
            <div class="mt-4 pt-3 border-t" data-userid="${userId}">
                <label class="block text-sm font-medium text-gray-700 mb-2">Berechtigungs-Typ</label>
                <div class="flex items-center gap-4">
                    <label class="flex items-center"><input type="radio" name="perm-type-${userId}" value="role" class="perm-type-toggle h-4 w-4" ${user.permissionType !== 'individual' ? 'checked' : ''} ${!canChangePerms ? 'disabled' : ''}> <span class="ml-2">Rolle</span></label>
                    <label class="flex items-center"><input type="radio" name="perm-type-${userId}" value="individual" class="perm-type-toggle h-4 w-4" ${user.permissionType === 'individual' ? 'checked' : ''} ${!canChangePerms ? 'disabled' : ''}> <span class="ml-2">Individuell</span></label>
                </div>
                <div class="role-selection-area mt-2 ${user.permissionType !== 'individual' ? '' : 'hidden'}">
                    <select class="user-role-select w-full p-2 border rounded-lg bg-white text-sm" ${!canChangePerms ? 'disabled' : ''}>
${Object.values(ROLES).filter(r => (isSysAdminEditing || (r.id !== 'SYSTEMADMIN' && r.id !== 'ADMIN'))).map(role => `<option value="${role.id}" ${user.role === role.id ? 'selected' : ''}>${role.name}</option>`).join('')}                    </select>
                </div>
                <div class="individual-perms-area mt-3 ${user.permissionType === 'individual' ? '' : 'hidden'}">
                    <div class="flex items-center gap-3 p-2 bg-indigo-50 rounded-lg">
                         <label class="text-sm font-medium text-gray-700 whitespace-nowrap">Angezeigter Status:</label>
                         <select class="display-role-select w-full p-1 border rounded-lg bg-white text-sm" ${!canChangePerms ? 'disabled' : ''}>
                            ${finalDisplayRoleOptionsWithSelection}
                         </select>
                    </div>
                    <div class="space-y-2 mt-3 pt-3 border-t">
                        ${Object.keys(allPermissions).map(permKey => { const isSubPermission = permKey.startsWith('CHECKLIST_'); const marginLeft = isSubPermission ? 'pl-6' : ''; return `<label class="flex items-center ${marginLeft}"><input type="checkbox" class="custom-perm-checkbox h-4 w-4" data-perm="${permKey}" ${user.customPermissions && user.customPermissions.includes(permKey) ? 'checked' : ''} ${!canChangePerms ? 'disabled' : ''}><span class="ml-2 text-sm">${allPermissions[permKey]}</span></label>`; }).join('')}
                    </div>
                </div>
                <div class="flex justify-end mt-3 hidden save-perms-container">
                     <button class="save-perms-button py-1 px-3 text-xs font-semibold bg-blue-600 text-white rounded-lg hover:bg-blue-700">Berechtigungen speichern</button>
                </div>
            </div>`;

                    const currentUserLabel = isSelf ? '<span class="bg-indigo-100 text-indigo-800 font-bold text-xs px-2 py-1 rounded-full ml-2">AKTUELL</span>' : '';
                    const effectiveRoleId = user.role || user.displayRole || 'NO_RIGHTS';
                    const roleName = ROLES[effectiveRoleId]?.name || 'Keine Rolle';

                    let roleColorClass = 'text-gray-500';
                    if (user.role === 'SYSTEMADMIN') roleColorClass = 'text-purple-600 font-bold';
                    if (user.role === 'ADMIN') roleColorClass = 'text-red-600 font-bold';

                    const userCard = document.createElement('div');
                    userCard.className = `p-3 border rounded-lg flex flex-col gap-3 ${!canEdit && !isSelf ? 'bg-gray-200 opacity-70' : 'bg-gray-50'}`;
                    userCard.innerHTML = `
            <div class="flex justify-between items-start">
                 <div class="flex-grow">
                     <div class="flex items-center gap-2">
                        <div data-userid="${userId}" class="name-display font-bold text-gray-800">${user.name} ${currentUserLabel}</div>
                        <div data-userid="${userId}" class="name-edit-container hidden flex-grow"><input type="text" value="${user.name}" class="p-1 border rounded w-full" ${!canRename ? 'disabled' : ''}><button class="save-name-btn p-1 ml-1 bg-green-500 text-white rounded">✔️</button></div>
                        ${canRename ? `<button class="rename-user-btn p-1" data-userid="${userId}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 text-gray-500 hover:text-indigo-600"><path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L6.75 6.775a.75.75 0 0 0-.22.53l-.5 2.5a.75.75 0 0 0 .913.913l2.5-.5a.75.75 0 0 0 .53-.22l4.263-4.262a1.75 1.75 0 0 0 0-2.475Z" /><path d="M4.75 3.5c-.69 0-1.25.56-1.25 1.25v9.5c0 .69.56 1.25 1.25 1.25h9.5c.69 0 1.25-.56 1.25-1.25V9.5a.75.75 0 0 1 1.5 0v5.25A2.75 2.75 0 0 1 14.25 18h-9.5A2.75 2.75 0 0 1 2 15.25v-9.5A2.75 2.75 0 0 1 4.75 3.5h5.25a.75.75 0 0 1 0 1.5H4.75Z" /></svg></button>` : ''}
                    </div>
                    <p class="text-xs ${roleColorClass}">${roleName}</p>
                </div>
                <label class="flex items-center ${canToggle ? 'cursor-pointer' : 'cursor-not-allowed'}"><span class="mr-2 text-sm font-medium">Gesperrt: <span class="${!user.isActive ? 'text-red-700' : 'text-green-700'} font-bold">${!user.isActive ? 'JA' : 'NEIN'}</span></span>
                    <div class="relative"><input type="checkbox" class="sr-only user-active-toggle" data-userid="${userId}" ${!user.isActive ? 'checked' : ''} ${!canToggle ? 'disabled' : ''}><div class="block bg-gray-300 w-10 h-6 rounded-full"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div></div>
                </label>
            </div>
            ${permissionsHTML}
            <div class="flex justify-end mt-2"><button class="delete-user-button py-1 px-3 text-xs font-semibold bg-red-600 text-white rounded-lg ${!canDelete ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-700'}" data-userid="${userId}" ${!canDelete ? 'disabled' : ''}>Löschen</button></div>`;
                    userManagementArea.appendChild(userCard);
                });

                // Der restliche Code der Funktion bleibt unverändert...
                // ########## START VOLLSTÄNDIGER EVENT-LISTENER BLOCK ##########
                const addUserBtn = userManagementArea.querySelector('#showAddUserFormBtn');
                if (addUserBtn) {
                    addUserBtn.addEventListener('click', (e) => {
                        e.currentTarget.style.display = 'none';
                        userManagementArea.querySelector('#addUserFormContainer').classList.remove('hidden');
                    });
                }

                const saveNewUserButton = userManagementArea.querySelector('#saveNewUserButton');
                if (saveNewUserButton) {
                    saveNewUserButton.addEventListener('click', async () => {
                        const name = userManagementArea.querySelector('#newUserName').value.trim();
                        const key = userManagementArea.querySelector('#newUserKey').value.trim();
                        const role = userManagementArea.querySelector('#newUserRole').value;
                        const newUserId = name.toUpperCase().replace(/\s/g, '');

                        if (!name || key.length < 4 || !role || !newUserId) return alertUser("Bitte alle Felder korrekt ausfüllen.", "error");
                        if (USERS[newUserId]) return alertUser(`ID '${newUserId}' existiert bereits.`, "error");

                        const userData = { name, key, role, isActive: true, newUserId };

                        if (isAdmin && effectiveAdminPerms.approvalRequired?.createUser) {
                            await createApprovalRequest('CREATE_USER', newUserId, { userData });
                        } else {
                            await setDoc(doc(usersCollectionRef, newUserId), { name, key, role, isActive: true });
                            await logAdminAction('user_created', `Benutzer '${name}' (${newUserId}) erstellt.`);
                        }
                        userManagementArea.querySelector('#addUserFormContainer').classList.add('hidden');
                        const showBtn = userManagementArea.querySelector('#showAddUserFormBtn');
                        if (showBtn) showBtn.style.display = 'block';
                    });
                }

                userManagementArea.querySelectorAll('.user-active-toggle').forEach(toggle => {
                    toggle.addEventListener('change', async e => {
                        const userId = e.target.dataset.userid;
                        const isChecked = e.target.checked;
                        if (!confirm(`Möchten Sie den Status von ${USERS[userId].name} wirklich ändern?`)) {
                            e.target.checked = !isChecked; return;
                        }

                        if (isAdmin && effectiveAdminPerms.approvalRequired?.toggleUserActive) {
                            e.target.checked = !isChecked;
                            await createApprovalRequest('TOGGLE_USER_ACTIVE', userId, { isActive: !isChecked });
                        } else {
                            await updateDoc(doc(usersCollectionRef, userId), { isActive: !isChecked });
                            await logAdminAction('user_activation_changed', `Benutzer '${USERS[userId].name}' wurde ${isChecked ? 'gesperrt' : 'entsperrt'}.`);
                        }
                    });
                });

                userManagementArea.querySelectorAll('.delete-user-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const userId = e.currentTarget.dataset.userid;
                        if (!confirm(`Möchten Sie ${USERS[userId].name} wirklich löschen?`)) return;

                        if (isAdmin && effectiveAdminPerms.approvalRequired?.deleteUser) {
                            await createApprovalRequest('DELETE_USER', userId);
                        } else {
                            await deleteDoc(doc(usersCollectionRef, userId));
                            await logAdminAction('user_deleted', `Benutzer '${USERS[userId].name}' gelöscht.`);
                            alertUser(`${USERS[userId].name} wurde gelöscht.`, 'success');
                        }
                    });
                });

                userManagementArea.querySelectorAll('.rename-user-btn').forEach(button => {
                    button.addEventListener('click', e => {
                        const userId = e.currentTarget.dataset.userid;
                        const card = e.currentTarget.closest('.p-3');
                        card.querySelector(`.name-display[data-userid="${userId}"]`).classList.add('hidden');
                        card.querySelector(`.rename-user-btn[data-userid="${userId}"]`).classList.add('hidden');
                        card.querySelector(`.name-edit-container[data-userid="${userId}"]`).classList.remove('hidden');
                    });
                });

                userManagementArea.querySelectorAll('.save-name-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const container = e.currentTarget.closest('.name-edit-container');
                        const userId = container.dataset.userid;
                        const newName = container.querySelector('input').value.trim();
                        if (!newName || newName === USERS[userId].name) {
                            renderUserManagement(); return;
                        }
                        if (!confirm(`Möchten Sie '${USERS[userId].name}' wirklich in '${newName}' umbenennen?`)) return;

                        if (isAdmin && effectiveAdminPerms.approvalRequired?.renameUser) {
                            await createApprovalRequest('RENAME_USER', userId, { newName: newName });
                        } else {
                            await updateDoc(doc(usersCollectionRef, userId), { name: newName });
                            await logAdminAction('user_renamed', `Benutzer '${USERS[userId].name}' in '${newName}' umbenannt.`);
                        }
                    });
                });

                const setupPermsChangeListener = (container) => {
                    const saveBtnContainer = container.querySelector('.save-perms-container');
                    if (saveBtnContainer) saveBtnContainer.classList.remove('hidden');
                };

                userManagementArea.querySelectorAll('.perm-type-toggle, .user-role-select, .custom-perm-checkbox, .display-role-select').forEach(el => {
                    el.addEventListener('change', (e) => {
                        const container = e.target.closest('[data-userid]');
                        if (e.target.classList.contains('perm-type-toggle')) {
                            container.querySelector('.role-selection-area').classList.toggle('hidden', e.target.value !== 'role');
                            container.querySelector('.individual-perms-area').classList.toggle('hidden', e.target.value !== 'individual');
                        }
                        setupPermsChangeListener(container);
                    });
                });

                userManagementArea.querySelectorAll('.save-perms-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const container = e.target.closest('[data-userid]');
                        const userId = container.dataset.userid;
                        const type = container.querySelector('input[name^="perm-type-"]:checked').value;
                        localUpdateInProgress = true;

                        rememberAdminScroll();

                        if (type === 'role') {
                            const newRole = container.querySelector('.user-role-select').value;
                            const updateData = {
                                role: newRole,
                                permissionType: 'role',
                                customPermissions: [],
                                displayRole: null,
                            };
                            if (newRole === 'ADMIN' || newRole === 'SYSTEMADMIN') {
                                updateData.assignedAdminRoleId = null;
                                updateData.adminPermissions = {};
                            }
                            await updateDoc(doc(usersCollectionRef, userId), updateData);
                        } else { // type === 'individual'
                            const customPermissions = Array.from(container.querySelectorAll('.custom-perm-checkbox:checked')).map(cb => cb.dataset.perm);
                            const selectedDisplayRole = container.querySelector('.display-role-select').value || 'NO_RIGHTS';
                            const updateData = {
                                permissionType: 'individual',
                                customPermissions: customPermissions,
                                role: null,
                                displayRole: 'NO_RIGHTS',
                            };

                            if (selectedDisplayRole === 'ADMIN' || selectedDisplayRole === 'SYSTEMADMIN') {
                                updateData.role = selectedDisplayRole;
                            } else {
                                updateData.displayRole = selectedDisplayRole;
                            }
                            await updateDoc(doc(usersCollectionRef, userId), updateData);
                        }

                        container.querySelector('.save-perms-container').classList.add('hidden');
                        alertUser("Berechtigungen gespeichert!", "success");
                    });
                });
                restoreAdminScrollIfAny();
            }

            const setupPermsChangeListener = (container) => {
                const saveBtnContainer = container.querySelector('.save-perms-container');
                if (saveBtnContainer) saveBtnContainer.classList.remove('hidden');
            };

            userManagementArea.querySelectorAll('.perm-type-toggle, .user-role-select, .custom-perm-checkbox, .display-role-select').forEach(el => {
                el.addEventListener('change', (e) => {
                    const container = e.target.closest('[data-userid]');
                    if (e.target.classList.contains('perm-type-toggle')) {
                        container.querySelector('.role-selection-area').classList.toggle('hidden', e.target.value !== 'role');
                        container.querySelector('.individual-perms-area').classList.toggle('hidden', e.target.value !== 'individual');
                    }
                    setupPermsChangeListener(container);
                });
            });

            // FINALE KORREKTUR DER SPEICHERLOGIK
            userManagementArea.querySelectorAll('.save-perms-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const container = e.target.closest('[data-userid]');
                    const userId = container.dataset.userid;
                    const type = container.querySelector('input[name^="perm-type-"]:checked').value;
                    localUpdateInProgress = true;

                    rememberAdminScroll();

                    if (type === 'role') {
                        const newRole = container.querySelector('.user-role-select').value;
                        const updateData = {
                            role: newRole,
                            permissionType: 'role',
                            customPermissions: [],
                            displayRole: null,
                        };
                        if (newRole === 'ADMIN' || newRole === 'SYSTEMADMIN') {
                            updateData.assignedAdminRoleId = null;
                            updateData.adminPermissions = {};
                        }
                        await updateDoc(doc(usersCollectionRef, userId), updateData);
                    } else { // type === 'individual'
                        const customPermissions = Array.from(container.querySelectorAll('.custom-perm-checkbox:checked')).map(cb => cb.dataset.perm);
                        const selectedDisplayRole = container.querySelector('.display-role-select').value || null;

                        const updateData = {
                            permissionType: 'individual',
                            customPermissions: customPermissions,
                            role: null,
                            displayRole: null,
                        };

                        // Wenn der Status "Admin" oder "Systemadmin" ist, wird die ECHTE Rolle gesetzt
                        if (selectedDisplayRole === 'ADMIN' || selectedDisplayRole === 'SYSTEMADMIN') {
                            updateData.role = selectedDisplayRole;
                            // Ein Admin mit individuellen Rechten hat keine displayRole
                        } else {
                            // Ansonsten wird nur die Anzeige-Rolle gesetzt
                            updateData.displayRole = selectedDisplayRole;
                        }
                        await updateDoc(doc(usersCollectionRef, userId), updateData);
                    }

                    container.querySelector('.save-perms-container').classList.add('hidden');
                    alertUser("Berechtigungen gespeichert!", "success");
                });
            });



            function renderRoleManagement() {
                roleManagementArea.innerHTML = '';
                let effectiveAdminPerms = {};
                const isAdmin = currentUser.role === 'ADMIN';
                const isSysAdmin = currentUser.role === 'SYSTEMADMIN';
                if (isAdmin) {
                    const adminUser = USERS[currentUser.mode];
                    if (adminUser && adminUser.adminPermissions) {
                        effectiveAdminPerms = adminUser.adminPermissions;
                    }
                }

                const canEditUserRoles = isSysAdmin ||
                    (isAdmin && effectiveAdminPerms.canEditUserRoles);

                const userRolesContainer = document.createElement('div');
                userRolesContainer.className = 'pl-2 border-l-4 border-gray-200';
                userRolesContainer.innerHTML = `
        <div id="userRolesToggle" class="card bg-white p-4 rounded-xl shadow cursor-pointer hover:shadow-md transition duration-200">
            <div class="flex justify-between items-center">
                <span class="text-xl font-bold text-gray-800">Benutzer-Rollen verwalten</span>
                <svg id="userRolesToggleIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6 transform transition-transform ${roleManagementSectionsState.userRolesOpen ? 'rotate-180' : ''}">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                </svg>
            </div>
        </div>
        <div id="userRolesArea" class="bg-gray-50 rounded-b-xl mt-0 p-4 flex flex-col gap-4 ${roleManagementSectionsState.userRolesOpen ? '' : 'hidden'}">
            <button id="showAddRoleFormBtn" class="w-full p-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition shadow-sm ${!canEditUserRoles ? 'hidden' : ''}">+ Benutzerrolle anlegen</button>
            <div id="addRoleFormContainer" class="p-4 border rounded-xl bg-green-50 hidden">
                <h4 class="font-bold text-lg text-green-800 mb-3">Neue Benutzer-Rolle anlegen</h4>
                <div class="space-y-3" id="newRolePermissions">
                    <input type="text" id="newRoleName" class="w-full p-2 border rounded-lg" placeholder="Rollenname">
                </div>
                <button id="saveNewRoleButton" class="w-full mt-3 p-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Benutzer-Rolle erstellen</button>
            </div>
            <div id="userRolesList" class="space-y-3 pt-4"></div>
        </div>`;
                roleManagementArea.appendChild(userRolesContainer);

                const allRolePermissions = {
                    'ENTRANCE': { label: 'Haupteingang öffnen', indent: false },
                    'PUSHOVER': { label: 'Push-Nachricht senden', indent: false },
                    'CHECKLIST': { label: 'Aktuelle Checkliste', indent: false },
                    'CHECKLIST_SWITCH': { label: '-> Listen umschalten', indent: true },
                    'CHECKLIST_SETTINGS': { label: '-> Checkliste-Einstellungen', indent: true },
                    'ESSENSBERECHNUNG': { label: 'Essensberechnung', indent: false } // <-- DIESEN EINTRAG HINZUFÜGEN
                };
                const newRolePermsContainer = document.getElementById('newRolePermissions');
                const isNewChecklistEnabled = false;
                Object.keys(allRolePermissions).forEach(permKey => {
                    const perm = allRolePermissions[permKey];
                    const marginLeft = perm.indent ? 'pl-6' : '';
                    const isSubPermission = permKey === 'CHECKLIST_SWITCH' || permKey === 'CHECKLIST_SETTINGS';
                    const isDisabled = isSubPermission && !isNewChecklistEnabled ? 'disabled' : '';
                    newRolePermsContainer.innerHTML += `
            <label class="flex items-center gap-2 cursor-pointer ${marginLeft}">
                <input type="checkbox" id="newRolePerm-${permKey}" data-perm="${permKey}" class="h-4 w-4 new-role-perm-cb" ${isDisabled}> <span>${perm.label}</span>
            </label>`;
                });

                const userRolesList = document.getElementById('userRolesList');
                Object.values(ROLES).forEach(role => {
                    const isProtectedRole = ['SYSTEMADMIN', 'ADMIN', 'NO_RIGHTS'].includes(role.id);
                    const canEditThisRole = canEditUserRoles && (!isProtectedRole || isSysAdmin);
                    const isChecklistEnabled = role.permissions?.includes('CHECKLIST');
                    let permissionsCheckboxesHTML = Object.keys(allRolePermissions).map(permKey => {
                        const perm = allRolePermissions[permKey];
                        const isChecked = role.permissions?.includes(permKey) ? 'checked' : '';
                        const isSubPermission = permKey === 'CHECKLIST_SWITCH' || permKey === 'CHECKLIST_SETTINGS';
                        const isDisabled = !canEditThisRole || (isSubPermission && !isChecklistEnabled) ? 'disabled' : '';
                        const marginLeft = perm.indent ? 'pl-6' : '';
                        return `
                <label class="flex items-center gap-2 ${canEditThisRole ? 'cursor-pointer' : ''} ${marginLeft}">
                    <input type="checkbox" class="role-perm-toggle" data-roleid="${role.id}" data-perm="${permKey}" ${isChecked} ${isDisabled}> 
                    <span>${perm.label}</span>
                </label>`;
                    }).join('');

                    const roleCard = document.createElement('div');
                    roleCard.className = `p-3 border rounded-lg bg-white shadow-sm ${!canEditThisRole && isProtectedRole ? 'opacity-60 bg-gray-50' : ''}`;
                    roleCard.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <p class="font-bold text-gray-800">${role.name}</p>
                ${canEditThisRole && role.deletable !== false ?
                            `<button class="delete-role-button p-1 bg-red-100 text-red-600 rounded hover:bg-red-200" data-roleid="${role.id}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5Z" clip-rule="evenodd" /></svg></button>` : ''}
            </div>
            <div class="space-y-2 text-sm">${permissionsCheckboxesHTML}</div>`;
                    userRolesList.appendChild(roleCard);
                });

                const setupCheckboxDependencies = (container) => {
                    const checklistCheckbox = container.querySelector('[data-perm="CHECKLIST"]');
                    const switchCheckbox = container.querySelector('[data-perm="CHECKLIST_SWITCH"]');
                    const settingsCheckbox = container.querySelector('[data-perm="CHECKLIST_SETTINGS"]');

                    if (!checklistCheckbox || !switchCheckbox || !settingsCheckbox) return;
                    const toggleSubPermissions = () => {
                        if (!checklistCheckbox.disabled) {
                            const isEnabled = checklistCheckbox.checked;
                            switchCheckbox.disabled = !isEnabled;
                            settingsCheckbox.disabled = !isEnabled;

                            if (!isEnabled) {
                                if (switchCheckbox.checked) {
                                    switchCheckbox.checked = false;
                                    switchCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
                                }
                                if (settingsCheckbox.checked) {
                                    settingsCheckbox.checked = false;
                                    settingsCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
                                }
                            }
                        }
                    };
                    checklistCheckbox.addEventListener('change', toggleSubPermissions);
                    toggleSubPermissions();
                };

                userRolesList.querySelectorAll('.p-3.border').forEach(card => setupCheckboxDependencies(card));
                setupCheckboxDependencies(document.getElementById('addRoleFormContainer'));

                document.getElementById('showAddRoleFormBtn').addEventListener('click', (e) => {
                    e.target.style.display = 'none';
                    document.getElementById('addRoleFormContainer').classList.remove('hidden');
                });
                document.getElementById('saveNewRoleButton').addEventListener('click', async () => {
                    roleManagementSectionsState.userRolesOpen = true;
                    const roleName = document.getElementById('newRoleName').value.trim();
                    const roleId = roleName.toUpperCase().replace(/\s/g, '');
                    if (!roleName || ROLES[roleId]) return alertUser("Bitte einen gültigen, eindeutigen Rollennamen eingeben.", "error");

                    const permissions = [];
                    document.querySelectorAll('.new-role-perm-cb:checked').forEach(cb => {
                        permissions.push(cb.dataset.perm);
                    });

                    await setDoc(doc(rolesCollectionRef, roleId), { name: roleName, permissions, deletable: true });
                    await logAdminAction('role_created', `Rolle '${roleName}' (${roleId}) erstellt.`);
                });
                userRolesList.querySelectorAll('.role-perm-toggle').forEach(toggle => {
                    toggle.addEventListener('change', async (e) => {
                        const { roleid, perm } = e.target.dataset;
                        const role = ROLES[roleid];
                        let permissions = role.permissions || [];
                        if (e.target.checked) {
                            if (!permissions.includes(perm)) permissions.push(perm);
                        } else {
                            permissions = permissions.filter(p => p !== perm);
                        }
                        await updateDoc(doc(rolesCollectionRef, roleid), { permissions });
                        await logAdminAction('role_permissions_changed', `Berechtigungen für Rolle '${role.name}' geändert.`);
                    });
                });
                const deleteAdminRoleHandler = async (e) => {
                    roleManagementSectionsState.adminRolesOpen = true;
                    const roleId = e.currentTarget.dataset.roleid;
                    const roleName = ADMIN_ROLES[roleId]?.name;
                    if (!roleName) return;
                    if (confirm(`Möchten Sie die Admin-Rolle '${roleName}' wirklich löschen? Alle Admins, die diese Rolle verwenden, verlieren dadurch ihre Rollen-Berechtigungen.`)) {
                        const batch = writeBatch(db);
                        const q = query(usersCollectionRef, where('assignedAdminRoleId', '==', roleId));
                        const usersToUpdateSnapshot = await getDocs(q);
                        usersToUpdateSnapshot.forEach(userDoc => {
                            batch.update(userDoc.ref, { assignedAdminRoleId: null });
                        });
                        batch.delete(doc(adminRolesCollectionRef, roleId));
                        await batch.commit();

                        await logAdminAction('admin_role_deleted', `Admin-Rolle '${roleName}' (${roleId}) gelöscht.`);
                    }
                };
                userRolesList.querySelectorAll('.delete-role-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        roleManagementSectionsState.userRolesOpen = true;
                        const roleId = e.currentTarget.dataset.roleid;
                        if (confirm(`Möchten Sie die Rolle '${ROLES[roleId].name}' wirklich löschen?`)) {
                            await deleteDoc(doc(rolesCollectionRef, roleId));
                            await logAdminAction('role_deleted', `Rolle '${ROLES[roleId].name}' (${roleId}) gelöscht.`);
                        }
                    });
                });
                document.getElementById('userRolesToggle').addEventListener('click', () => {
                    roleManagementSectionsState.userRolesOpen = !roleManagementSectionsState.userRolesOpen;
                    document.getElementById('userRolesArea').classList.toggle('hidden');
                    document.getElementById('userRolesToggleIcon').classList.toggle('rotate-180');
                });
                if (currentUser.role === 'SYSTEMADMIN') {
                    const adminRolesContainer = document.createElement('div');
                    adminRolesContainer.className = "mt-6 pl-2 border-l-4 border-gray-200";
                    adminRolesContainer.innerHTML = `
            <div id="adminRolesToggle" class="card bg-white p-4 rounded-xl shadow cursor-pointer hover:shadow-md transition duration-200">
                <div class="flex justify-between items-center">
                    <span class="text-xl font-bold text-purple-800">Admin-Rollen verwalten</span>
                    <svg id="adminRolesToggleIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6 transform transition-transform ${roleManagementSectionsState.adminRolesOpen ? 'rotate-180' : ''}">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                    </svg>
                </div>
            </div>
            <div id="adminRolesArea" class="bg-gray-50 rounded-b-xl mt-0 p-4 flex flex-col gap-4 ${roleManagementSectionsState.adminRolesOpen ? '' : 'hidden'}">
                <button id="showAddAdminRoleFormBtn" class="w-full p-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition shadow-sm">+ Admin-Rolle anlegen</button>
                <div id="addAdminRoleFormContainer" class="p-4 border rounded-xl bg-purple-50 hidden">
                    <h4 id="adminRoleFormTitle" class="font-bold text-lg text-purple-800 mb-3">Neue Admin-Rolle anlegen</h4>
                    <input type="hidden" id="editingAdminRoleId">
                    <div class="space-y-3">
                        <input type="text" id="newAdminRoleName" class="w-full p-2 border rounded-lg" placeholder="Admin-Rollenname">
                        <div class="space-y-3 mt-3">
                            <div class="p-3 border rounded-lg bg-white bg-opacity-50">
                                <h5 class="font-semibold text-sm mb-2 text-gray-600">Sichtbarkeit von Admin-Menüpunkten</h5>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canSeePasswords"> <span>Passwörter</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canSeeApprovals"> <span>Genehmigungen</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canSeeRoleManagement"> <span>Rollenverwaltung</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canViewLogs"> <span>Protokolle</span></label>
                                    <label class="flex items-center col-span-2 gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canSeeUsers"> <span>Benutzersteuerung</span></label>
                                    
                                    <div class="col-span-2 mt-2 pt-2 border-t">
                                        <label class="flex items-center gap-2 font-semibold"><input type="checkbox" class="new-admin-perm-cb" data-perm="canSeeMainFunctions"> <span>Adminfunktionen Hauptseite</span></label>
                                        <div class="pl-6 mt-1 space-y-1">
                                            <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canUseMainPush"> <span>-> Push</span></label>
                                            <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canUseMainEntrance"> <span>-> Eingang</span></label>
                                            <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canUseMainChecklist"> <span>-> Checkliste</span></label>
                                        </div>
                                    </div>
                                    </div>
                                <div class="pl-6 mt-3 pt-3 border-t border-gray-200 space-y-3">
                                    <h5 class="font-semibold text-sm mb-2 text-gray-500">Aktionen in "Benutzersteuerung"</h5>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canCreateUser"> <span>Benutzer anlegen</span></label>
                                        <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canDeleteUser"> <span>Benutzer löschen</span></label>
                                        <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canRenameUser"> <span>Benutzer umbenennen</span></label>
                                        <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canToggleUserActive"> <span>Benutzer ent-/sperren</span></label>
                                        <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canChangeUserPermissionType"> <span>Berechtigungs-Typ ändern</span></label>
                                    </div>
                                    <h5 class="font-semibold text-sm mb-2 mt-3 text-gray-500">Rechte in "Rollenverwaltung"</h5>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canEditUserRoles"> <span>Darf Benutzer-Rollen bearbeiten</span></label>
                                    </div>
                                    <h5 class="font-semibold text-sm mb-2 mt-3 text-gray-500">Rechte in "Protokoll History"</h5>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <label class="flex items-center gap-2"><input type="checkbox" class="new-admin-perm-cb" data-perm="canSeeSysadminLogs"> <span>Darf Sysadmin-Einträge sehen</span></label>
                                    </div>
                                </div>
                            </div>
                            <div class="p-3 border rounded-lg bg-white bg-opacity-50">
                                <h5 class="font-semibold text-sm mb-2 text-gray-600">Genehmigungsprozess</h5>
                                <p class="text-xs text-gray-500 mb-3">Wenn hier ein Haken gesetzt ist, muss die jeweilige Aktion von einem Systemadmin genehmigt werden.</p>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="setAdminStatus"> <span>Admin-Status setzen</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="createUser"> <span>Benutzer anlegen</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="deleteUser"> <span>Benutzer löschen</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="renameUser"> <span>Benutzer umbenennen</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="toggleUserActive"> <span>Benutzer ent-/sperren</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="changeUserPermissionType"> <span>Berechtigungs-Typ ändern</span></label>
                                </div>
                            </div>
                        </div>
                        <button id="saveNewAdminRoleButton" class="w-full p-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition mt-3">Admin-Rolle speichern</button>
                    </div>
                </div>
                <div id="adminRolesList" class="space-y-3 pt-4"></div>
            </div>`;
                    roleManagementArea.appendChild(adminRolesContainer);

                    const adminRolesList = document.getElementById('adminRolesList');
                    Object.values(ADMIN_ROLES).filter(role => role.id !== 'LEERE_ROLLE').forEach(adminRole => {
                        const isDeletable = adminRole.deletable !== false;
                        const roleCard = document.createElement('div');
                        roleCard.className = 'p-3 border rounded-lg bg-white shadow-sm';
                        roleCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="font-bold text-gray-800">${adminRole.name}</p>
                    <div class="flex items-center gap-2">
                        ${isDeletable ? `<button class="edit-admin-role-btn p-1 text-gray-500 hover:text-indigo-600" data-roleid="${adminRole.id}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L6.75 6.775a.75.75 0 0 0-.22.53l-.5 2.5a.75.75 0 0 0 .913.913l2.5-.5a.75.75 0 0 0 .53-.22l4.263-4.262a1.75 1.75 0 0 0 0-2.475Z" /><path d="M4.75 3.5c-.69 0-1.25.56-1.25 1.25v9.5c0 .69.56 1.25 1.25 1.25h9.5c.69 0 1.25-.56 1.25-1.25V9.5a.75.75 0 0 1 1.5 0v5.25A2.75 2.75 0 0 1 14.25 18h-9.5A2.75 2.75 0 0 1 2 15.25v-9.5A2.75 2.75 0 0 1 4.75 3.5h5.25a.75.75 0 0 1 0 1.5H4.75Z" /></svg></button>` : ''}
                        ${isDeletable ?
                                `<button class="delete-admin-role-button p-1 bg-red-100 text-red-600 rounded hover:bg-red-200" data-roleid="${adminRole.id}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5Z" clip-rule="evenodd" /></svg></button>` : ''}
                    </div>
                </div>`;
                        adminRolesList.appendChild(roleCard);
                    });

                    const adminRoleForm = document.getElementById('addAdminRoleFormContainer');
                    const showAdminRoleFormBtn = document.getElementById('showAddAdminRoleFormBtn');

                    const openAdminRoleEditor = (roleId = null) => {
                        const formTitle = adminRoleForm.querySelector('#adminRoleFormTitle');
                        const nameInput = adminRoleForm.querySelector('#newAdminRoleName');
                        const idInput = adminRoleForm.querySelector('#editingAdminRoleId');
                        const permCheckboxes = adminRoleForm.querySelectorAll('.new-admin-perm-cb');
                        const approvalCheckboxes = adminRoleForm.querySelectorAll('.approval-cb');
                        if (roleId) {
                            const role = ADMIN_ROLES[roleId];
                            formTitle.textContent = 'Admin-Rolle bearbeiten';
                            idInput.value = roleId;
                            nameInput.value = role.name;
                            nameInput.disabled = true;
                            permCheckboxes.forEach(cb => {
                                cb.checked = role.permissions[cb.dataset.perm] || false;
                            });
                            approvalCheckboxes.forEach(cb => {
                                cb.checked = role.permissions.approvalRequired?.[cb.dataset.perm] || false;
                            });
                        } else {
                            formTitle.textContent = 'Neue Admin-Rolle anlegen';
                            idInput.value = '';
                            nameInput.value = '';
                            nameInput.disabled = false;
                            permCheckboxes.forEach(cb => cb.checked = false);
                            approvalCheckboxes.forEach(cb => cb.checked = false);
                        }
                        showAdminRoleFormBtn.style.display = 'none';
                        adminRoleForm.classList.remove('hidden');

                        // Stellt sicher, dass die Abhängigkeitslogik auch im Editor funktioniert
                        setupPermissionDependencies(adminRoleForm);
                    };

                    showAdminRoleFormBtn.addEventListener('click', () => openAdminRoleEditor());

                    adminRolesList.querySelectorAll('.edit-admin-role-btn').forEach(button => {
                        button.addEventListener('click', (e) => openAdminRoleEditor(e.currentTarget.dataset.roleid));
                    });
                    adminRolesList.querySelectorAll('.delete-admin-role-button').forEach(button => {
                        button.addEventListener('click', deleteAdminRoleHandler);
                    });
                    document.getElementById('saveNewAdminRoleButton').addEventListener('click', async () => {
                        roleManagementSectionsState.adminRolesOpen = true;
                        const roleName = document.getElementById('newAdminRoleName').value.trim();
                        const editingId = document.getElementById('editingAdminRoleId').value;
                        const roleId = editingId || roleName.toUpperCase().replace(/\s/g, '');

                        if (!roleName || (!editingId && ADMIN_ROLES[roleId])) return alertUser("Bitte gültigen, eindeutigen Namen eingeben.", "error");

                        const permissions = {};
                        document.querySelectorAll('#addAdminRoleFormContainer .new-admin-perm-cb').forEach(cb => {
                            permissions[cb.dataset.perm] = cb.checked;
                        });

                        const approvalRequired = {};
                        document.querySelectorAll('#addAdminRoleFormContainer .approval-cb').forEach(cb => {
                            approvalRequired[cb.dataset.perm] = cb.checked;
                        });
                        permissions.approvalRequired = approvalRequired;

                        const docData = { name: roleName, permissions, deletable: true };
                        if (editingId) {
                            await updateDoc(doc(adminRolesCollectionRef, editingId), { permissions });
                            await logAdminAction('admin_role_edited', `Admin-Rolle '${roleName}' bearbeitet.`);
                        } else {
                            await setDoc(doc(adminRolesCollectionRef, roleId), docData);
                            await logAdminAction('admin_role_created', `Admin-Rolle '${roleName}' erstellt.`);
                        }
                        adminRoleForm.classList.add('hidden');
                        showAdminRoleFormBtn.style.display = 'block';
                    });

                    document.getElementById('adminRolesToggle').addEventListener('click', () => {
                        roleManagementSectionsState.adminRolesOpen = !roleManagementSectionsState.adminRolesOpen;
                        document.getElementById('adminRolesArea').classList.toggle('hidden');
                        document.getElementById('adminRolesToggleIcon').classList.toggle('rotate-180');
                    });
                }
            } adminRightsArea.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">Admin-Benutzer verwalten</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-lg text-center mb-2 pb-2 border-b">Rolle</h4>
                        <div id="admin-role-users" class="space-y-2"></div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg text-center mb-2 pb-2 border-b">Individuell</h4>
                        <div id="admin-individual-users" class="space-y-2"></div>
                    </div>
                </div>
                <div id="admin-user-details-area" class="mt-6"></div>
            `;

            const adminUsers = Object.values(USERS).filter(user => user.role === 'ADMIN');
            const roleUsersContainer = adminRightsArea.querySelector('#admin-role-users');
            const individualUsersContainer = adminRightsArea.querySelector('#admin-individual-users');

            if (adminUsers.length === 0) {
                adminRightsArea.querySelector('#admin-role-users').innerHTML = '<p class="text-center text-sm text-gray-500">Keine Admins gefunden.</p>';
            }

            adminUsers.forEach(adminUser => {
                const userCard = document.createElement('div');
                userCard.className = 'p-2 border rounded-lg bg-white shadow-sm flex justify-between items-center';

                const permissionType = adminUser.permissionType || 'individual';

                let userInfoHTML;
                if (permissionType === 'role') {
                    // NEU: Prüft, ob die zugewiesene Rolle existiert
                    const assignedRole = adminUser.assignedAdminRoleId ? ADMIN_ROLES[adminUser.assignedAdminRoleId] : null;
                    const roleName = assignedRole ? assignedRole.name : 'Keine Rolle zugewiesen';
                    userInfoHTML = `<div><p class="font-bold text-gray-800">${adminUser.name}</p><p class="text-xs text-indigo-600 font-medium">${roleName}</p></div>`;
                    roleUsersContainer.appendChild(userCard);
                } else {
                    userInfoHTML = `<div><p class="font-bold text-gray-800">${adminUser.name}</p></div>`;
                    individualUsersContainer.appendChild(userCard);
                }

                userCard.innerHTML = `
                    ${userInfoHTML}
                    <button class="edit-admin-user-btn p-1 text-gray-500 hover:text-indigo-600" data-userid="${adminUser.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                    </button>
                `;
            });

            adminRightsArea.querySelectorAll('.edit-admin-user-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.userid;
                    renderAdminUserDetails(userId);
                });
            });

            function renderAdminUserDetails(userId) {
                const detailsArea = document.getElementById('admin-user-details-area');
                const adminUser = USERS[userId];

                if (detailsArea.dataset.editingUser === userId) {
                    detailsArea.innerHTML = '';
                    delete detailsArea.dataset.editingUser;
                    return;
                }

                document.querySelectorAll('.edit-admin-user-btn').forEach(b => b.closest('.p-2').classList.remove('bg-indigo-100'));
                adminRightsArea.querySelector(`.edit-admin-user-btn[data-userid="${userId}"]`).closest('.p-2').classList.add('bg-indigo-100');


                detailsArea.dataset.editingUser = userId;

                const perms = adminUser.adminPermissions || {};
                const approvalPerms = perms.approvalRequired || {};
                const type = adminUser.permissionType || 'individual';

                let roleOptions = Object.values(ADMIN_ROLES)
                    .filter(r => r.id !== 'LEERE_ROLLE')
                    .map(r => `<option value="${r.id}" ${adminUser.assignedAdminRoleId === r.id ? 'selected' : ''}>${r.name}</option>`)
                    .join('');
                detailsArea.innerHTML = `
        <div class="p-4 border-t-4 border-indigo-500 rounded-xl bg-gray-50 mt-4 relative shadow-lg">
            <button id="close-details-btn" class="absolute top-2 right-3 text-2xl font-bold text-gray-400 hover:text-red-600">&times;</button>
            <p class="font-bold text-lg text-indigo-800">${adminUser.name} bearbeiten</p>
            
            <div class="mt-4 pt-3 border-t">
                <label class="block text-sm font-medium text-gray-700 mb-2">Berechtigungs-Typ</label>
                <div class="flex items-center gap-4">
                    <label class="flex items-center"><input type="radio" name="perm-type-${userId}" value="individual" class="perm-type-toggle" data-userid="${userId}" ${type === 'individual' ? 'checked' : ''}> <span class="ml-2">Individuell</span></label>
                    <label class="flex items-center"><input type="radio" name="perm-type-${userId}" value="role" class="perm-type-toggle" data-userid="${userId}" ${type === 'role' ? 'checked' : ''}> <span class="ml-2">Rolle</span></label>
                </div>
            </div>

            <div class="role-selection-area mt-2 ${type === 'role' ? '' : 'hidden'}">
                <select id="assigned-admin-role-select" class="w-full p-2 border rounded-lg bg-white text-sm" data-userid="${userId}">${roleOptions}</select>
            </div>

            <div class="individual-perms-area mt-3 space-y-3 ${type === 'individual' ? '' : 'hidden'}">
                <div class="p-3 border rounded-lg bg-white">
                    <h5 class="font-semibold text-sm mb-2 text-gray-600">Sichtbarkeit von Admin-Menüpunkten</h5>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canSeePasswords" ${perms.canSeePasswords ? 'checked' : ''}> <span>Passwörter</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canSeeApprovals" ${perms.canSeeApprovals ? 'checked' : ''}> <span>Genehmigungen</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canSeeRoleManagement" ${perms.canSeeRoleManagement ? 'checked' : ''}> <span>Rollenverwaltung</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canViewLogs" ${perms.canViewLogs ? 'checked' : ''}> <span>Protokolle</span></label>
                        <label class="flex items-center col-span-2 gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canSeeUsers" ${perms.canSeeUsers ? 'checked' : ''}> <span>Benutzersteuerung</span></label>

                        <div class="col-span-2 mt-2 pt-2 border-t">
                            <label class="flex items-center gap-2 font-semibold"><input type="checkbox" class="admin-perm-cb" data-perm="canSeeMainFunctions" ${perms.canSeeMainFunctions ? 'checked' : ''}> <span>Adminfunktionen Hauptseite</span></label>
                            <div class="pl-6 mt-1 space-y-1">
                                <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canUseMainPush" ${perms.canUseMainPush ? 'checked' : ''}> <span>-> Push</span></label>
                                <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canUseMainEntrance" ${perms.canUseMainEntrance ? 'checked' : ''}> <span>-> Eingang</span></label>
                                <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canUseMainChecklist" ${perms.canUseMainChecklist ? 'checked' : ''}> <span>-> Checkliste</span></label>
                            </div>
                        </div>
                    </div>
                    <div class="pl-6 mt-3 pt-3 border-t border-gray-200 space-y-3">
                        <h5 class="font-semibold text-sm mb-2 text-gray-500">Aktionen in "Benutzersteuerung"</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canCreateUser" ${perms.canCreateUser ? 'checked' : ''}> <span>Benutzer anlegen</span></label>
                            <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canDeleteUser" ${perms.canDeleteUser ? 'checked' : ''}> <span>Benutzer löschen</span></label>
                            <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canRenameUser" ${perms.canRenameUser ? 'checked' : ''}> <span>Benutzer umbenennen</span></label>
                            <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canToggleUserActive" ${perms.canToggleUserActive ? 'checked' : ''}> <span>Benutzer ent-/sperren</span></label>
                            <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canChangeUserPermissionType" ${perms.canChangeUserPermissionType ? 'checked' : ''}> <span>Berechtigungs-Typ ändern</span></label>
                        </div>
                        <h5 class="font-semibold text-sm mb-2 mt-3 text-gray-500">Rechte in "Rollenverwaltung"</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canEditUserRoles" ${perms.canEditUserRoles ? 'checked' : ''}> <span>Darf Benutzer-Rollen bearbeiten</span></label>
                        </div>
                            <h5 class="font-semibold text-sm mb-2 mt-3 text-gray-500">Rechte in "Protokoll History"</h5>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <label class="flex items-center gap-2"><input type="checkbox" class="admin-perm-cb" data-perm="canSeeSysadminLogs" ${perms.canSeeSysadminLogs ? 'checked' : ''}> <span>Darf Sysadmin-Einträge sehen</span></label>
                        </div>
                    </div>
                </div>
                <div class="p-3 border rounded-lg bg-white">
                    <h5 class="font-semibold text-sm mb-2 text-gray-600">Genehmigungsprozess</h5>
                    <p class="text-xs text-gray-500 mb-3">Wenn hier ein Haken gesetzt ist, muss die jeweilige Aktion von einem Systemadmin genehmigt werden.</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="setAdminStatus" ${approvalPerms.setAdminStatus ? 'checked' : ''}> <span>Admin-Status setzen</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="createUser" ${approvalPerms.createUser ? 'checked' : ''}> <span>Benutzer anlegen</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="deleteUser" ${approvalPerms.deleteUser ? 'checked' : ''}> <span>Benutzer löschen</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="renameUser" ${approvalPerms.renameUser ? 'checked' : ''}> <span>Benutzer umbenennen</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="toggleUserActive" ${approvalPerms.toggleUserActive ? 'checked' : ''}> <span>Benutzer ent-/sperren</span></label>
                        <label class="flex items-center gap-2"><input type="checkbox" class="approval-cb" data-perm="changeUserPermissionType" ${approvalPerms.changeUserPermissionType ? 'checked' : ''}> <span>Berechtigungs-Typ ändern</span></label>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t flex justify-end">
                <button id="save-admin-details-btn" data-userid="${userId}" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Änderungen speichern</button>
            </div>
        </div>
    `;
                detailsArea.querySelector('#close-details-btn').addEventListener('click', () => {
                    detailsArea.innerHTML = '';
                    delete detailsArea.dataset.editingUser;
                    document.querySelectorAll('.edit-admin-user-btn').forEach(b => b.closest('.p-2').classList.remove('bg-indigo-100'));
                });
                detailsArea.querySelectorAll('.perm-type-toggle').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const type = e.target.value;
                        const card = e.target.closest('.p-4');
                        card.querySelector('.role-selection-area').classList.toggle('hidden', type !== 'role');
                        card.querySelector('.individual-perms-area').classList.toggle('hidden', type !== 'individual');
                    });
                });
                detailsArea.querySelector('#save-admin-details-btn').addEventListener('click', async (e) => {
                    const userId = e.currentTarget.dataset.userid;
                    const container = e.currentTarget.closest('.p-4');

                    const selectedType = container.querySelector('input[name^="perm-type-"]:checked').value;
                    const updateData = {
                        permissionType: selectedType
                    };

                    if (selectedType === 'role') {
                        updateData.assignedAdminRoleId = container.querySelector('#assigned-admin-role-select').value;
                        updateData.adminPermissions = {};
                    } else {
                        const permissions = {};
                        container.querySelectorAll('.admin-perm-cb').forEach(cb => {
                            permissions[cb.dataset.perm] = cb.checked;
                        });

                        const approvalRequired = {};
                        container.querySelectorAll('.approval-cb').forEach(cb => {
                            approvalRequired[cb.dataset.perm] = cb.checked;
                        });
                        permissions.approvalRequired = approvalRequired;

                        updateData.adminPermissions = permissions;
                        updateData.assignedAdminRoleId = null;
                    }

                    await updateDoc(doc(usersCollectionRef, userId), updateData);
                    alertUser("Änderungen gespeichert!", "success");

                    setTimeout(async () => {
                        await renderAdminRightsManagement();
                        if (document.getElementById('admin-user-details-area')) {
                            renderAdminUserDetails(userId);
                        }
                    }, 200);
                });

                // Stellt sicher, dass die Abhängigkeitslogik für die Checkboxen aktiv ist
                setupPermissionDependencies(detailsArea);
            }
            function setupPermissionDependencies(container) {
                const mainToggle = container.querySelector('[data-perm="canSeeMainFunctions"]');
                const subToggles = [
                    container.querySelector('[data-perm="canUseMainPush"]'),
                    container.querySelector('[data-perm="canUseMainEntrance"]'),
                    container.querySelector('[data-perm="canUseMainChecklist"]')
                ];

                if (!mainToggle) return;

                const updateSubToggles = () => {
                    const isEnabled = mainToggle.checked;
                    subToggles.forEach(toggle => {
                        if (toggle) {
                            toggle.disabled = !isEnabled;
                            if (!isEnabled) {
                                toggle.checked = false;
                            }
                        }
                    });
                };

                mainToggle.addEventListener('change', updateSubToggles);
                updateSubToggles(); // Einmal beim Laden ausführen, um den initialen Status zu setzen
            }


            const sysAdminListContainer = document.createElement('div');
            sysAdminListContainer.className = 'mt-8 pt-4 border-t';

            const systemAdmins = Object.values(USERS).filter(user => user.role === 'SYSTEMADMIN');

            let sysAdminListHTML = '<h4 class="text-lg font-semibold text-gray-700 mb-2">Übersicht Systemadministratoren</h4>';
            if (systemAdmins.length > 0) {
                sysAdminListHTML += '<div class="space-y-1">';
                systemAdmins.forEach(sysAdmin => {
                    const isSelf = sysAdmin.id === currentUser.mode;
                    const currentUserLabel = isSelf ? '<span class="bg-indigo-100 text-indigo-800 font-bold text-xs px-2 py-1 rounded-full ml-2">AKTUELL</span>' : '';
                    sysAdminListHTML += `<p class="p-2 bg-gray-100 rounded-md text-sm">${sysAdmin.name} ${currentUserLabel}</p>`;
                });
                sysAdminListHTML += '</div>';
            } else {
                sysAdminListHTML += '<p class="text-sm text-gray-500">Keine Systemadministratoren gefunden.</p>';
            }

            sysAdminListContainer.innerHTML = sysAdminListHTML;
            adminRightsArea.appendChild(sysAdminListContainer);

            async function renderAdminRightsManagement() {
                adminRightsArea.innerHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-4">Admin-Benutzer verwalten</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-lg text-center mb-2 pb-2 border-b">Rolle</h4>
                        <div id="admin-role-users" class="space-y-2"></div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg text-center mb-2 pb-2 border-b">Individuell</h4>
                        <div id="admin-individual-users" class="space-y-2"></div>
                    </div>
                </div>
                <div id="admin-user-details-area" class="mt-6"></div>
            `;

                // KORRIGIERTER FILTER: Findet alle Benutzer, die entweder die Rolle ADMIN oder SYSTEMADMIN haben.
                const adminUsers = Object.values(USERS).filter(user => user.role === 'ADMIN' || user.role === 'SYSTEMADMIN');

                const roleUsersContainer = adminRightsArea.querySelector('#admin-role-users');
                const individualUsersContainer = adminRightsArea.querySelector('#admin-individual-users');

                if (adminUsers.length === 0) {
                    adminRightsArea.querySelector('#admin-role-users').innerHTML = '<p class="text-center text-sm text-gray-500">Keine Admins gefunden.</p>';
                }

                adminUsers.forEach(adminUser => {
                    // Ein Systemadmin wird hier immer als "Rolle" behandelt.
                    const permissionType = adminUser.role === 'SYSTEMADMIN' ? 'role' : (adminUser.permissionType || 'role');

                    // Ein Systemadmin kann nicht bearbeitet werden (Selbstschutz).
                    const canBeEdited = adminUser.role !== 'SYSTEMADMIN';

                    const userCard = document.createElement('div');
                    userCard.className = 'p-2 border rounded-lg bg-white shadow-sm flex justify-between items-center';

                    let userInfoHTML;
                    // Admins und Systemadmins werden jetzt beide in der "Rolle"-Spalte angezeigt.
                    if (permissionType === 'role') {
                        const roleName = ROLES[adminUser.role]?.name || 'Unbekannt';
                        userInfoHTML = `<div><p class="font-bold text-gray-800">${adminUser.name}</p><p class="text-xs text-indigo-600 font-medium">${roleName}</p></div>`;
                        roleUsersContainer.appendChild(userCard);
                    } else { // Gilt nur noch für individuell konfigurierte Admins
                        userInfoHTML = `<div><p class="font-bold text-gray-800">${adminUser.name}</p></div>`;
                        individualUsersContainer.appendChild(userCard);
                    }

                    userCard.innerHTML = `
                    ${userInfoHTML}
                    ${canBeEdited ? `
                    <button class="edit-admin-user-btn p-1 text-gray-500 hover:text-indigo-600" data-userid="${adminUser.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" /></svg>
                    </button>` : ''}
                `;
                });

                adminRightsArea.querySelectorAll('.edit-admin-user-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.userid;
                        renderAdminUserDetails(userId);
                    });
                });

            }

            async function renderApprovalProcess(snapshot = null) {
                approvalProcessArea.innerHTML = '';

                if (!snapshot) {
                    snapshot = await getDocs(query(roleChangeRequestsCollectionRef, orderBy('timestamp', 'desc')));
                }

                if (snapshot.empty) {
                    approvalProcessArea.innerHTML += '<p class="text-gray-500">Keine Anfragen vorhanden.</p>';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const request = docSnap.data();
                    const requestId = docSnap.id;

                    const requestCard = document.createElement('div');
                    requestCard.className = 'p-3 border rounded-lg';
                    let cardBG, statusText, descriptionHTML;
                    let statusActor = request.actionTakenByName ? ` (von ${request.actionTakenByName})` : '';
                    const time = request.timestamp?.toDate().toLocaleString('de-DE') || '';

                    switch (request.status) {
                        case 'pending': cardBG = 'bg-yellow-50'; statusText = 'Offen'; break;
                        case 'approved': cardBG = 'bg-green-50'; statusText = 'Genehmigt' + statusActor; break;
                        case 'denied': cardBG = 'bg-red-50'; statusText = 'Abgelehnt' + statusActor; break;
                        case 'withdrawn': cardBG = 'bg-gray-100'; statusText = 'Zurückgezogen' + statusActor; break;
                    }
                    requestCard.classList.add(cardBG);

                    switch (request.type) {
                        case 'CREATE_USER':
                            descriptionHTML = `<p>Aktion: <span class="font-medium">Benutzer anlegen</span></p><p class="text-sm text-gray-600">Neuer Name: ${request.details.userData.name}</p>`;
                            break;
                        case 'DELETE_USER':
                            descriptionHTML = `<p>Aktion: <span class="font-medium text-red-600">Benutzer löschen</span> für <span class="font-medium">${request.userName}</span></p>`;
                            break;
                        case 'RENAME_USER':
                            descriptionHTML = `<p>Aktion: <span class="font-medium">Benutzer umbenennen</span></p><p class="text-sm text-gray-600">'${request.userName}' ➜ '${request.details.newName}'</p>`;
                            break;
                        // NEU: Angepasste Anzeige für Sperren/Entsperren
                        case 'TOGGLE_USER_ACTIVE':
                            const actionText = request.details.isActive === false ? 'Sperren' : 'Entsperren';
                            const actionColor = request.details.isActive === false ? 'text-red-600' : 'text-green-600';
                            descriptionHTML = `<p>Aktion: <span class="font-medium ${actionColor}">${actionText}</span> für Benutzer <span class="font-medium">${request.userName}</span></p>`;
                            break;
                        case 'SET_ADMIN_STATUS':
                            descriptionHTML = `<p>Aktion: <span class="font-medium text-purple-600">Zum Admin befördern</span> für <span class="font-medium">${request.userName}</span></p>`;
                            break;
                        case 'CHANGE_USER_ROLE':
                            descriptionHTML = `<p>Aktion: <span class="font-medium">Rolle ändern</span> für <span class="font-medium">${request.userName}</span></p><p class="text-sm text-gray-600">Neue Rolle: ${request.details.newRoleName}</p>`;
                            break;
                        case 'CHANGE_PERMISSION_TYPE':
                            let typeDetails = request.details.type === 'role'
                                ? `auf "Rolle" (${ROLES[request.details.newRole]?.name || 'Standard'})`
                                : `auf "Individuell"`;
                            descriptionHTML = `<p>Aktion: <span class="font-medium">Berechtigungstyp ändern</span> für <span class="font-medium">${request.userName}</span></p><p class="text-sm text-gray-600">Neuer Typ: ${typeDetails}</p>`;
                            break;
                        case 'CHANGE_CUSTOM_PERMISSIONS':
                            descriptionHTML = `<p>Aktion: <span class="font-medium">Individuelle Rechte ändern</span> für <span class="font-medium">${request.userName}</span></p>`;
                            break;
                        default:
                            descriptionHTML = `<p>Unbekannte Aktion: ${request.type}</p>`;
                    }


                    let buttonsHTML = '';
                    if (request.status === 'pending') {
                        if (currentUser.role === 'SYSTEMADMIN') {
                            buttonsHTML = `
                        <button class="deny-request-btn py-1 px-3 text-sm font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700" data-request-id="${requestId}">Ablehnen</button>
                        <button class="approve-request-btn py-1 px-3 text-sm font-semibold bg-green-600 text-white rounded-lg hover:bg-green-700" data-request-id="${requestId}">Annehmen</button>`;
                        } else if (currentUser.mode === request.requestedById) {
                            buttonsHTML = `<button class="withdraw-request-btn py-1 px-3 text-sm font-semibold bg-gray-500 text-white rounded-lg hover:bg-gray-600" data-request-id="${requestId}">Zurückziehen</button>`;
                        }
                    }

                    requestCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-gray-800">Antrag von: ${request.requestedByName}</p>
                            <p class="text-xs text-gray-500">${time}</p>
                        </div>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${cardBG}">${statusText}</span>
                    </div>
                    <div class="mt-2 pt-2 border-t">${descriptionHTML}</div>
                    <div class="flex justify-end space-x-2 mt-3">${buttonsHTML}</div>`;
                    approvalProcessArea.appendChild(requestCard);
                });

                approvalProcessArea.querySelectorAll('.approve-request-btn').forEach(button => button.addEventListener('click', async (e) => {
                    const requestId = e.currentTarget.dataset.requestId;
                    const requestDoc = await getDoc(doc(roleChangeRequestsCollectionRef, requestId));
                    if (!requestDoc.exists()) return;

                    const request = requestDoc.data();
                    const { type, userId, details } = request;
                    let batch = writeBatch(db);

                    try {
                        switch (type) {
                            case 'CREATE_USER':
                                const { name, key, role, isActive, newUserId } = details.userData;
                                batch.set(doc(usersCollectionRef, newUserId), { name, key, role, isActive });
                                break;
                            case 'DELETE_USER':
                                batch.delete(doc(usersCollectionRef, userId));
                                break;
                            case 'RENAME_USER':
                                batch.update(doc(usersCollectionRef, userId), { name: details.newName });
                                break;
                            case 'TOGGLE_USER_ACTIVE':
                                batch.update(doc(usersCollectionRef, userId), { isActive: details.isActive });
                                break;
                            case 'SET_ADMIN_STATUS':
                                batch.update(doc(usersCollectionRef, userId), { role: 'ADMIN', permissionType: 'role', assignedAdminRoleId: null });
                                break;
                            case 'CHANGE_USER_ROLE':
                                batch.update(doc(usersCollectionRef, userId), { role: details.newRole });
                                break;
                            case 'CHANGE_PERMISSION_TYPE':
                                if (details.type === 'role') {
                                    batch.update(doc(usersCollectionRef, userId), { role: details.newRole, customPermissions: [] });
                                } else {
                                    batch.update(doc(usersCollectionRef, userId), { role: null, customPermissions: details.customPermissions });
                                }
                                break;
                            case 'CHANGE_CUSTOM_PERMISSIONS':
                                batch.update(doc(usersCollectionRef, userId), { customPermissions: details.permissions });
                                break;
                        }
                        batch.update(doc(roleChangeRequestsCollectionRef, requestId), { status: 'approved', actionTakenByName: currentUser.displayName });
                        await batch.commit();
                        alertUser('Antrag genehmigt!', 'success');
                    } catch (error) {
                        console.error("Error approving request:", error);
                        alertUser('Fehler bei der Genehmigung.', 'error');
                    }
                }));

                approvalProcessArea.querySelectorAll('.deny-request-btn').forEach(button => button.addEventListener('click', async (e) => {
                    const { requestId } = e.currentTarget.dataset;
                    await updateDoc(doc(roleChangeRequestsCollectionRef, requestId), { status: 'denied', actionTakenByName: currentUser.displayName });
                }));

                approvalProcessArea.querySelectorAll('.withdraw-request-btn').forEach(button => button.addEventListener('click', async (e) => {
                    const { requestId } = e.currentTarget.dataset;
                    await updateDoc(doc(roleChangeRequestsCollectionRef, requestId), { status: 'withdrawn', actionTakenByName: currentUser.displayName });
                }));
            }

            async function renderProtocolHistory() {
                protocolHistoryArea.innerHTML = '';
                let logQuery;

                // NEU: Berechtigungen des Admins prüfen
                if (currentUser.role === 'ADMIN') {
                    let effectiveAdminPerms = {};
                    const adminUser = USERS[currentUser.mode];
                    if (adminUser) {
                        if (adminUser.permissionType === 'role' && adminUser.assignedAdminRoleId && ADMIN_ROLES[adminUser.assignedAdminRoleId]) {
                            effectiveAdminPerms = ADMIN_ROLES[adminUser.assignedAdminRoleId].permissions || {};
                        } else {
                            effectiveAdminPerms = adminUser.adminPermissions || {};
                        }
                    }
                    // Wenn der Admin nicht die Berechtigung hat, Sysadmin-Logs zu sehen, filtern
                    if (!effectiveAdminPerms.canSeeSysadminLogs) {
                        logQuery = query(auditLogCollectionRef, where('performedByRole', '!=', 'SYSTEMADMIN'), orderBy('performedByRole'), orderBy('timestamp', 'desc'));
                    }
                }

                // Wenn keine spezielle Abfrage für Admins erstellt wurde, zeige alles (für Systemadmins)
                if (!logQuery) {
                    logQuery = query(auditLogCollectionRef, orderBy('timestamp', 'desc'), limit(100));
                }

                try {
                    const snapshot = await getDocs(logQuery);
                    if (snapshot.empty) {
                        protocolHistoryArea.innerHTML += '<p class="text-gray-500">Keine Protokolleinträge vorhanden.</p>';
                        return;
                    }

                    const logList = document.createElement('ul');
                    logList.className = 'space-y-2';
                    snapshot.forEach(docSnap => {
                        const log = docSnap.data();
                        const logId = docSnap.id;
                        const logDate = log.timestamp?.toDate().toLocaleString('de-DE') || '...';
                        const listItem = document.createElement('li');
                        listItem.className = 'text-sm p-2 bg-gray-50 rounded-md flex justify-between items-center';

                        let deleteButton = '';
                        if (currentUser.role === 'SYSTEMADMIN') {
                            deleteButton = `<button class="delete-log-btn text-red-500 hover:text-red-700 transition" data-log-id="${logId}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
                        </button>`;
                        }

                        listItem.innerHTML = `<div><span class="font-mono text-xs text-gray-500">${logDate}</span><br><strong>${log.performedByName}</strong>: ${log.details}</div> ${deleteButton}`;
                        logList.appendChild(listItem);
                    });
                    protocolHistoryArea.appendChild(logList);

                    protocolHistoryArea.querySelectorAll('.delete-log-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const logId = e.currentTarget.dataset.logId;
                            if (confirm('Möchten Sie diesen Protokolleintrag wirklich löschen?')) {
                                await deleteDoc(doc(auditLogCollectionRef, logId));
                                await logAdminAction('log_deleted', `Protokolleintrag (ID: ${logId}) gelöscht.`);
                            }
                        });
                    });

                } catch (error) {
                    console.error("Error fetching protocol history:", error);
                    protocolHistoryArea.innerHTML += `<p class="text-red-500">Fehler beim Laden des Protokolls. Möglicherweise muss ein Datenbank-Index erstellt werden. Bitte prüfen Sie die Browser-Konsole auf einen Link zur Erstellung.</p>`;
                }
            }

            // NEUE FUNKTIONEN FÜR DIE CHECKLISTEN

            function listenForChecklists() {
                onSnapshot(query(checklistsCollectionRef, orderBy('name')), (snapshot) => {
                    const oldChecklists = { ...CHECKLISTS };
                    CHECKLISTS = {};
                    ARCHIVED_CHECKLISTS = {};
                    DELETED_CHECKLISTS = {};

                    snapshot.forEach((doc) => {
                        const list = { id: doc.id, ...doc.data() };
                        if (list.isDeleted) {
                            DELETED_CHECKLISTS[doc.id] = list;
                        } else if (list.isArchived) {
                            ARCHIVED_CHECKLISTS[doc.id] = list;
                        } else {
                            CHECKLISTS[doc.id] = list;
                        }
                    });

                    const deletedListIds = Object.keys(oldChecklists).filter(id => !CHECKLISTS[id] && !ARCHIVED_CHECKLISTS[id]);
                    if (deletedListIds.length > 0) {
                        const currentUserData = USERS[currentUser.mode] || {};
                        if (deletedListIds.includes(currentUserData.defaultChecklistId)) {
                            updateDoc(doc(usersCollectionRef, currentUser.mode), { defaultChecklistId: null });
                        }
                    }

                    const settingsView = document.getElementById('checklistSettingsView');
                    if (settingsView.classList.contains('active')) {
                        const activeTab = settingsView.querySelector('#settings-tabs .settings-tab-btn.bg-white');
                        const activeTabId = activeTab ? activeTab.dataset.targetCard : null;

                        // === START: KORRIGIERTE LOGIK ===
                        // Diese neue Logik behebt das Problem der "Geister-Einträge".

                        const currentlyEditingId = settingsView.dataset.editingListId;
                        let nextListToEditId = null;

                        // 1. Prüfen, ob die Liste, die gerade bearbeitet wurde, noch existiert.
                        if (currentlyEditingId && CHECKLISTS[currentlyEditingId]) {
                            // Wenn ja, bleiben wir bei dieser Liste.
                            nextListToEditId = currentlyEditingId;
                        } else {
                            // 2. Wenn sie archiviert/gelöscht wurde, wählen wir die erste verfügbare, aktive Liste als neuen Standard.
                            nextListToEditId = Object.keys(CHECKLISTS).length > 0 ? Object.keys(CHECKLISTS)[0] : null;
                        }

                        // 3. Wir rufen die Render-Funktion explizit mit der korrekten neuen Listen-ID auf.
                        renderChecklistSettingsView(nextListToEditId);

                        // === ENDE: KORRIGIERTE LOGIK ===

                        if (activeTabId) {
                            const tabToReactivate = settingsView.querySelector(`button[data-target-card="${activeTabId}"]`);
                            if (tabToReactivate) tabToReactivate.click();
                        }
                    }

                    if (document.getElementById('checklistView').classList.contains('active')) {
                        const listId = document.getElementById('checklistView').dataset.currentListId;
                        // Prüfen, ob die angezeigte Liste noch aktiv ist, sonst zur ersten verfügbaren wechseln
                        if (CHECKLISTS[listId]) {
                            renderChecklistView(listId);
                        } else {
                            const fallbackListId = Object.keys(CHECKLISTS).length > 0 ? Object.keys(CHECKLISTS)[0] : null;
                            renderChecklistView(fallbackListId);
                        }
                    }
                    if (document.getElementById('deletedListsModal').style.display === 'flex') {
                        renderDeletedListsModal();
                    }
                    if (document.getElementById('archivedListsModal').style.display === 'flex') {
                        renderArchivedListsModal();
                    }

                    updateUIForMode();
                });
            } function listenForChecklistGroups() {
                onSnapshot(query(checklistGroupsCollectionRef, orderBy('name')), (snapshot) => {
                    CHECKLIST_GROUPS = {};
                    snapshot.forEach((doc) => {
                        CHECKLIST_GROUPS[doc.id] = { id: doc.id, ...doc.data() };
                    });

                    // NEU: Merkt sich den aktiven Tab und stellt ihn wieder her
                    const settingsView = document.getElementById('checklistSettingsView');
                    if (settingsView.classList.contains('active')) {
                        const activeTab = settingsView.querySelector('#settings-tabs .settings-tab-btn.bg-white');
                        const activeTabId = activeTab ? activeTab.dataset.targetCard : null;
                        renderChecklistSettingsView();
                        if (activeTabId) {
                            const tabToReactivate = settingsView.querySelector(`button[data-target-card="${activeTabId}"]`);
                            if (tabToReactivate) tabToReactivate.click();
                        }
                    }
                });
            }


            function listenForChecklistCategories() {
                onSnapshot(query(checklistCategoriesCollectionRef, orderBy('name')), (snapshot) => {
                    CHECKLIST_CATEGORIES = {};
                    snapshot.forEach((doc) => {
                        const category = { id: doc.id, ...doc.data() };
                        if (!category.groupId) return;
                        if (!CHECKLIST_CATEGORIES[category.groupId]) {
                            CHECKLIST_CATEGORIES[category.groupId] = [];
                        }
                        CHECKLIST_CATEGORIES[category.groupId].push(category);
                    });

                    // Prüft, ob die Einstellungs-Ansicht überhaupt geöffnet ist
                    const settingsView = document.getElementById('checklistSettingsView');
                    if (settingsView.classList.contains('active')) {

                        // 1. Aktualisiert die Kategorie-Verwaltungsansicht selbst (wie bisher)
                        const categoriesCard = settingsView.querySelector('#card-categories');
                        if (categoriesCard && !categoriesCard.classList.contains('hidden')) {
                            const groupId = settingsView.querySelector('#category-group-selector')?.value;
                            renderCategoryEditor(groupId);
                        }

                        // 2. NEU: Ruft unsere Hilfsfunktion auf, um alle anderen Dropdowns zu aktualisieren
                        updateCategoryDropdowns();
                    }
                });
            }



            function listenForChecklistItems() {
                onSnapshot(query(checklistItemsCollectionRef, orderBy('addedAt')), (snapshot) => {
                    // NEU: Lädt immer alle Einträge. Die Filterung geschieht erst bei der Anzeige.
                    CHECKLIST_ITEMS = {};
                    snapshot.forEach((doc) => {
                        const item = { id: doc.id, ...doc.data() };
                        if (!CHECKLIST_ITEMS[item.listId]) {
                            CHECKLIST_ITEMS[item.listId] = [];
                        }
                        CHECKLIST_ITEMS[item.listId].push(item);
                    });

                    // Aktualisiert die Ansichten, die von der Eintrags-Änderung betroffen sind
                    if (document.getElementById('checklistView').classList.contains('active')) {
                        const listId = document.getElementById('checklistView').dataset.currentListId;
                        if (listId) renderChecklistItems(listId);
                    }
                    if (document.getElementById('checklistSettingsView').classList.contains('active')) {
                        const listId = document.getElementById('checklistSettingsView').dataset.editingListId;
                        if (listId) renderChecklistSettingsItems(listId);
                    }
                });
            }

            function getItemBadges(item) {
                let badgesHTML = '';
                // Die Kategorie wird jetzt als Überschrift angezeigt, daher hier entfernt.
                if (item.assignedToName) {
                    badgesHTML += `<span class="text-xs font-semibold py-0.5 px-2 rounded-full whitespace-nowrap bg-gray-200 text-gray-700">${item.assignedToName}</span>`;
                }
                // Reduziertes Margin für ein kompakteres Layout
                return `<div class="flex items-center gap-2 flex-wrap mt-1">${badgesHTML}</div>`;
            };

            function populatePersonDropdown() {
                const userOptions = Object.values(USERS)
                    .filter(u => u.name && u.isActive)
                    .map(user => `<option value="${user.id}">${user.name}</option>`)
                    .join('');
                document.getElementById('person-select').innerHTML = `<option value="">Person zuweisen...</option>${userOptions}`;
            }

            function renderChecklistItems(listId) {
                const view = document.getElementById('checklistView');
                const items = CHECKLIST_ITEMS[listId] || [];

                const filterText = (view.querySelector('#checklist-filter-text')?.value || '').toLowerCase();
                const filterStatus = view.querySelector('#checklist-filter-status')?.value || 'all';
                const itemsWithOriginalIndex = items.map((item, index) => ({ ...item, originalIndex: index }));

                let filteredItems = itemsWithOriginalIndex.filter(item => {
                    const itemID = (item.originalIndex + 1).toString();
                    const matchesText = filterText === '' || item.text.toLowerCase().includes(filterText) || itemID.includes(filterText);
                    const matchesStatus = filterStatus === 'all' ||
                        (filterStatus === 'open' && item.status !== 'done') ||
                        (filterStatus === 'done' && item.status === 'done');
                    return matchesText && matchesStatus;
                });

                const doneItems = filteredItems.filter(item => item.status === 'done');
                const openItems = filteredItems.filter(item => item.status !== 'done');
                const total = filteredItems.length;
                const doneCount = doneItems.length;
                const openCount = openItems.length;
                const percentage = total > 0 ? Math.round((doneCount / total) * 100) : 0;

                view.querySelector('#checklist-stats').innerHTML = `${doneCount} von ${total} erledigt - Noch ${openCount} offen (${percentage}%)`;

                const getStatusInfo = (item) => {
                    if (item.lastActionBy && item.lastActionAt) {
                        const date = item.lastActionAt.toDate().toLocaleString('de-DE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) || '';
                        const actionText = item.status === 'done' ? 'Erledigt' : 'Wieder geöffnet';
                        return `<p class="text-xs text-gray-400">${actionText} von ${item.lastActionBy} (${date})</p>`;
                    }
                    return '';
                };

                const getItemBadges = (item) => {
                    let badgesHTML = '';
                    if (item.assignedToName) {
                        badgesHTML += `<span class="text-xs font-semibold py-0.5 px-2 rounded-full whitespace-nowrap bg-gray-200 text-gray-700">${item.assignedToName}</span>`;
                    }
                    return badgesHTML ? `<div class="flex items-center gap-2 flex-wrap mt-1">${badgesHTML}</div>` : '';
                };

                const groupedItems = openItems.reduce((acc, item) => {
                    const categoryId = item.categoryId || 'no-category';
                    if (!acc[categoryId]) {
                        acc[categoryId] = { name: item.categoryName, items: [] };
                    }
                    acc[categoryId].items.push(item);
                    return acc;
                }, {});

                const openItemsContainer = view.querySelector('#checklist-items-container');
                openItemsContainer.innerHTML = '';

                const renderItems = (items) => {
                    items.sort((a, b) => (b.important || 0) - (a.important || 0)); // "Wichtige" nach oben sortieren
                    items.forEach(item => {
                        const importantClass = item.important ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'bg-white';
                        openItemsContainer.innerHTML += `
            <div class="${importantClass} p-2 rounded-lg shadow-sm flex flex-col gap-1">
                <div class="flex items-start gap-2.5">
                    <span class="text-xs font-bold text-gray-400 pt-1">${item.originalIndex + 1}.</span>
                    <input type="checkbox" data-item-id="${item.id}" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mt-0.5 flex-shrink-0">
                    <div class="flex-grow">
                        <label class="text-sm">${item.text}</label>
                        ${getStatusInfo(item)}
                    </div>
                </div>
                ${getItemBadges(item)}
            </div>`;
                    });
                };

                if (groupedItems['no-category'] && groupedItems['no-category'].items.length > 0) {
                    renderItems(groupedItems['no-category'].items);
                }

                Object.keys(groupedItems).forEach(categoryId => {
                    if (categoryId === 'no-category') return;
                    const group = groupedItems[categoryId];
                    let categoryColorKey = 'gray';
                    for (const catGroup of Object.values(CHECKLIST_CATEGORIES)) {
                        const foundCat = catGroup.find(cat => cat.id === categoryId);
                        if (foundCat) {
                            categoryColorKey = foundCat.color || 'gray';
                            break;
                        }
                    }
                    const color = COLOR_PALETTE[categoryColorKey] || COLOR_PALETTE.gray;
                    openItemsContainer.innerHTML += `<h3 class="font-bold text-base p-2 rounded-lg mt-4 ${color.bg} ${color.text}">${group.name}</h3>`;
                    renderItems(group.items);
                });

                const doneItemsSection = view.querySelector('#checklist-done-section');
                if (doneItems.length > 0) {
                    doneItemsSection.classList.remove('hidden');
                    doneItemsSection.querySelector('#checklist-done-items-container').innerHTML = doneItems.map(item => `
            <div class="bg-gray-100 p-2 rounded-lg flex flex-col gap-1 opacity-60">
                <div class="flex items-start gap-2.5">
                    <span class="text-xs font-bold text-gray-400 pt-1">${item.originalIndex + 1}.</span>
                    <input type="checkbox" data-item-id="${item.id}" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mt-0.5 flex-shrink-0" checked>
                    <div class="flex-grow">
                        <label class="line-through text-sm">${item.text}</label>
                        ${getStatusInfo(item)}
                    </div>
                </div>
                ${getItemBadges(item)}
            </div>
        `).join('');
                } else {
                    doneItemsSection.classList.add('hidden');
                }

                view.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', async (e) => {
                        const itemId = e.target.dataset.itemId;
                        const isChecked = e.target.checked;
                        const updateData = {
                            status: isChecked ? 'done' : 'open',
                            lastActionBy: currentUser.displayName,
                            lastActionAt: serverTimestamp()
                        };
                        await updateDoc(doc(checklistItemsCollectionRef, itemId), updateData);
                    });
                });
            }

            function renderChecklistView(listId) {
                const view = document.getElementById('checklistView');

                view.innerHTML = `
        <div class="back-link-container w-full mb-2">
            <button class="back-link flex items-center text-gray-600 hover:text-indigo-600 transition" data-target="home">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-1"><path d="m15 18-6-6 6-6" /></svg>
                <span class="text-sm font-semibold">zurück</span>
            </button>
            <div class="border-t border-gray-300 mt-2"></div>
        </div>
        <div id="checklist-content-wrapper"></div>
    `;
                const contentWrapper = view.querySelector('#checklist-content-wrapper');

                if (!listId || !CHECKLISTS[listId]) {
                    const message = Object.keys(CHECKLISTS).length === 0
                        ? "Keine Checkliste vorhanden. Bitte erstellen Sie zuerst eine in den Einstellungen."
                        : "Keine Standard-Checkliste ausgewählt. Bitte wählen Sie eine in den Einstellungen.";
                    contentWrapper.innerHTML = `<p class="text-center text-gray-500 mt-8">${message}</p>`;
                    return;
                }

                view.dataset.currentListId = listId;

                let groupedListOptions = Object.values(CHECKLIST_GROUPS).map(group => {
                    const listsInGroup = Object.values(CHECKLISTS).filter(list => list.groupId === group.id);
                    if (listsInGroup.length === 0) return '';
                    return `
            <optgroup label="${group.name}">
                ${listsInGroup.map(list => `<option value="${list.id}" ${list.id === listId ? 'selected' : ''}>${list.name}</option>`).join('')}
            </optgroup>
        `;
                }).join('');

                // HIER IST DIE ÄNDERUNG: Das Dropdown wird basierend auf der Berechtigung gesperrt
                const canSwitchLists = currentUser.permissions.includes('CHECKLIST_SWITCH');
                const disabledAttribute = canSwitchLists ? '' : 'disabled';

                contentWrapper.innerHTML = `
        <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm mb-4">
            <h2 class="text-2xl font-bold text-gray-800">${CHECKLISTS[listId].name}</h2>
            <select id="checklist-switcher" class="p-2 border rounded-lg bg-gray-50 text-sm" ${disabledAttribute}>${groupedListOptions}</select>
        </div>

        <div class="bg-white p-3 rounded-lg shadow-sm mb-4 grid grid-cols-1 md:grid-cols-2 gap-3">
            <input type="text" id="checklist-filter-text" class="p-2 border rounded-lg text-sm" placeholder="Nach Text oder ID suchen...">
            <select id="checklist-filter-status" class="p-2 border rounded-lg bg-white text-sm">
                <option value="all">Alle anzeigen</option>
                <option value="open">Nur Offene</option>
                <option value="done">Nur Erledigte</option>
            </select>
        </div>

        <div id="checklist-stats" class="bg-indigo-50 p-3 rounded-lg text-center mb-4 text-sm font-semibold text-indigo-800"></div>
        <div id="checklist-items-container" class="space-y-2"></div>
        <div id="checklist-done-section" class="mt-6 hidden">
            <h3 class="font-bold text-lg text-gray-500 mb-2">Erledigt</h3>
            <div id="checklist-done-items-container" class="space-y-2"></div>
        </div>
    `;

                const switcher = contentWrapper.querySelector('#checklist-switcher');
                if (switcher && canSwitchLists) {
                    switcher.addEventListener('change', (e) => renderChecklistView(e.target.value));
                }
                contentWrapper.querySelector('#checklist-filter-text').addEventListener('input', () => renderChecklistItems(listId));
                contentWrapper.querySelector('#checklist-filter-status').addEventListener('change', () => renderChecklistItems(listId));

                renderChecklistItems(listId);
            }


            function renderChecklistSettingsItems(listId) {
                const container = document.getElementById('checklist-items-editor-container');
                if (!container) return;

                const itemsForEditList = [...(CHECKLIST_ITEMS[listId] || [])]; // Kopie erstellen, um Original nicht zu ändern
                itemsForEditList.sort((a, b) => (b.important || 0) - (a.important || 0)); // "Wichtige" nach oben sortieren

                container.innerHTML = itemsForEditList.map(item => {
                    const addedAtDate = item.addedAt?.toDate().toLocaleString('de-DE') || '';
                    const editedAtDate = item.lastEditedAt?.toDate().toLocaleString('de-DE') || '';
                    const colorKey = item.categoryColor || 'gray';
                    const color = COLOR_PALETTE[colorKey] || COLOR_PALETTE.gray;

                    return `
        <div class="p-2 border rounded-lg flex items-center gap-2 ${item.important ? 'bg-yellow-100' : ''}" data-item-id="${item.id}">
            <div class="item-display-content flex-grow">
                <p class="font-semibold">${item.text}</p>
                <div class="text-xs text-gray-500 mt-1 space-y-1">
                    ${item.assignedToName ? `<p class="font-semibold text-blue-600">Zugewiesen an: ${item.assignedToName}</p>` : ''}
                    ${item.categoryName ? `<p class="font-semibold ${color.text}">Kategorie: ${item.categoryName}</p>` : ''}
                    <p>Hinzugefügt von: ${item.addedBy} <span class="text-gray-400">(${addedAtDate})</span></p>
                    ${item.lastEditedBy ? `<p>Bearbeitet von: ${item.lastEditedBy} <span class="text-gray-400">(${editedAtDate})</span></p>` : ''}
                </div>
            </div>
            <div class="item-edit-content hidden flex-grow">
                <input type="text" class="w-full p-2 border rounded-lg" value="${item.text}">
            </div>
            <div class="flex items-center">
                <button class="edit-checklist-item-btn p-2 text-blue-500 hover:bg-blue-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L6.75 6.775a.75.75 0 0 0-.22.53l-.5 2.5a.75.75 0 0 0 .913.913l2.5-.5a.75.75 0 0 0 .53-.22l4.263-4.262a1.75 1.75 0 0 0 0-2.475Z" /><path d="M4.75 3.5c-.69 0-1.25.56-1.25 1.25v9.5c0 .69.56 1.25 1.25 1.25h9.5c.69 0 1.25-.56 1.25-1.25V9.5a.75.75 0 0 1 1.5 0v5.25A2.75 2.75 0 0 1 14.25 18h-9.5A2.75 2.75 0 0 1 2 15.25v-9.5A2.75 2.75 0 0 1 4.75 3.5h5.25a.75.75 0 0 1 0 1.5H4.75Z" /></svg></button>
                <button class="save-checklist-item-btn p-2 text-green-500 hover:bg-green-100 rounded-full hidden"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" /></svg></button>
                <button class="delete-checklist-item-btn p-2 text-red-500 hover:bg-red-100 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1H2V3Zm2 2h8v8a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5Z" /></svg></button>
            </div>
        </div>
        `;
                }).join('');
            }


            function renderDeletedListsModal() {
                const container = document.getElementById('deletedListsContainer');
                container.innerHTML = ''; // Leeren

                const deletedLists = Object.values(DELETED_CHECKLISTS).sort((a, b) => b.deletedAt - a.deletedAt);

                if (deletedLists.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Keine gelöschten Listen vorhanden.</p>';
                    return;
                }

                deletedLists.forEach(list => {
                    const date = list.deletedAt?.toDate().toLocaleString('de-DE') || 'Unbekannt';
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-3 bg-gray-50 rounded-lg flex justify-between items-center border';
                    itemDiv.innerHTML = `
                    <div>
                        <p class="font-semibold">${list.name}</p>
                        <p class="text-xs text-gray-500">Gelöscht von ${list.deletedBy} am ${date}</p>
                    </div>
                    <button data-list-id="${list.id}" class="restore-checklist-btn py-1 px-3 bg-green-100 text-green-800 text-xs font-semibold rounded-lg hover:bg-green-200">Wiederherstellen</button>
                `;
                    container.appendChild(itemDiv);
                });
            }


            function renderArchivedListsModal() {
                const container = document.getElementById('archivedListsContainer');
                container.innerHTML = '';

                const archivedLists = Object.values(ARCHIVED_CHECKLISTS).sort((a, b) => (b.archivedAt?.seconds || 0) - (a.archivedAt?.seconds || 0));

                if (archivedLists.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Keine archivierten Listen vorhanden.</p>';
                    return;
                }

                archivedLists.forEach(list => {
                    const date = list.archivedAt?.toDate().toLocaleString('de-DE') || 'Unbekannt';
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-3 bg-gray-50 rounded-lg border';
                    itemDiv.innerHTML = `
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-semibold">${list.name}</p>
                    <p class="text-xs text-gray-500">Archiviert von ${list.archivedBy || 'Unbekannt'} am ${date}</p>
                </div>
                <div class="flex gap-2">
                    <button data-list-id="${list.id}" class="restore-archived-btn py-1 px-3 bg-green-100 text-green-800 text-xs font-semibold rounded-lg hover:bg-green-200">Wiederherstellen</button>
                    <button data-list-id="${list.id}" class="delete-archived-btn py-1 px-3 bg-red-100 text-red-800 text-xs font-semibold rounded-lg hover:bg-red-200">Löschen</button>
                </div>
            </div>
        `;
                    container.appendChild(itemDiv);
                });
            }
            function renderCategoryEditor(groupId) {
                const categoryContent = document.getElementById('category-content');
                if (!categoryContent) return;

                if (!groupId) {
                    categoryContent.innerHTML = '<p class="text-sm text-center text-gray-500">Bitte wählen Sie eine Gruppe, um deren Kategorien zu verwalten.</p>';
                    return;
                }

                const categories = CHECKLIST_CATEGORIES[groupId] || [];

                categoryContent.innerHTML = `
        <div id="category-list-container" class="space-y-2 mb-4">
            ${categories.map(cat => {
                    const colorKey = cat.color || 'gray';
                    const color = COLOR_PALETTE[colorKey] || COLOR_PALETTE.gray;
                    return `
                <div class="flex justify-between items-center p-2 bg-white rounded-md border" data-category-id="${cat.id}">
                    <div class="cat-display-content flex items-center gap-2">
                        <div class="h-4 w-4 rounded-full ${color.bg.replace('100', '400')} border border-gray-400"></div>
                        <span>${cat.name}</span>
                    </div>
                    <div class="cat-edit-content hidden flex-grow mr-2">
                        <input type="text" class="w-full p-1 border rounded-md" value="${cat.name}">
                    </div>
                    <div class="flex items-center">
                        <button class="edit-category-btn p-1 text-blue-500 hover:bg-blue-100 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L6.75 6.775a.75.75 0 0 0-.22.53l-.5 2.5a.75.75 0 0 0 .913.913l2.5-.5a.75.75 0 0 0 .53-.22l4.263-4.262a1.75 1.75 0 0 0 0-2.475Z" /><path d="M4.75 3.5c-.69 0-1.25.56-1.25 1.25v9.5c0 .69.56 1.25 1.25 1.25h9.5c.69 0 1.25-.56 1.25-1.25V9.5a.75.75 0 0 1 1.5 0v5.25A2.75 2.75 0 0 1 14.25 18h-9.5A2.75 2.75 0 0 1 2 15.25v-9.5A2.75 2.75 0 0 1 4.75 3.5h5.25a.75.75 0 0 1 0 1.5H4.75Z" /></svg>
                        </button>
                        <button class="save-category-btn p-1 text-green-500 hover:bg-green-100 rounded-full hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="delete-category-btn p-1 text-red-500 hover:bg-red-100 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5Z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <div class="color-palette-editor hidden p-2 bg-gray-50 rounded-b-md border-x border-b -mt-2">
                    <div class="flex flex-wrap gap-2 justify-center">
                    ${Object.keys(COLOR_PALETTE).map(colorKey => `
                        <div data-color="${colorKey}" data-category-id="${cat.id}" class="color-dot h-5 w-5 rounded-full cursor-pointer ${COLOR_PALETTE[colorKey].bg.replace('100', '400')}" title="${COLOR_PALETTE[colorKey].name}"></div>
                    `).join('')}
                    </div>
                </div>`
                }).join('') || '<p class="text-xs text-center text-gray-500">Für diese Gruppe existieren keine Kategorien.</p>'}
        </div>
        <div class="flex flex-col gap-2 pt-2 border-t">
            <input type="text" id="new-category-name" class="w-full p-2 border rounded-lg" placeholder="Name für neue Kategorie...">
            <div id="new-category-color-palette" class="flex flex-wrap gap-2 p-2 bg-gray-50 rounded-lg">
                ${Object.keys(COLOR_PALETTE).map(colorKey => `
                    <div data-color="${colorKey}" class="new-color-dot h-6 w-6 rounded-full cursor-pointer ${COLOR_PALETTE[colorKey].bg.replace('100', '300')} hover:ring-2 ring-blue-500" title="${COLOR_PALETTE[colorKey].name}"></div>
                `).join('')}
                <input type="hidden" id="new-category-selected-color" value="gray">
            </div>
            <button id="create-category-btn" class="py-2 px-3 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition">Erstellen</button>
        </div>
    `;
            }
            function updateCategoryDropdowns() {
                // Baut die HTML-Optionen für die Kategorien neu auf, basierend auf den aktuellen Daten
                const categoryOptions = `<option value="">Keine Kategorie</option>` + Object.values(CHECKLIST_GROUPS).map(group => {
                    const categoriesInGroup = CHECKLIST_CATEGORIES[group.id] || [];
                    if (categoriesInGroup.length === 0) return '';
                    return `<optgroup label="${group.name}">${categoriesInGroup.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}</optgroup>`;
                }).join('');

                // Findet das Dropdown-Feld im "Vorlagen"-Tab
                const templateCategorySelect = document.getElementById('new-template-item-category');
                if (templateCategorySelect) {
                    const selectedValue = templateCategorySelect.value; // Merkt sich die aktuelle Auswahl
                    templateCategorySelect.innerHTML = categoryOptions; // Füllt das Dropdown mit den neuen Daten
                    templateCategorySelect.value = selectedValue; // Versucht, die alte Auswahl wiederherzustellen
                }

                // Falls du zukünftig weitere Kategorie-Dropdowns hinzufügst, können sie hier ebenfalls aktualisiert werden.
            }


            function setupListAndItemManagementListeners(view) {
                const defaultGroupSwitcher = view.querySelector('#checklist-settings-default-group-switcher');
                const defaultListSwitcher = view.querySelector('#checklist-settings-default-list-switcher');

                if (defaultGroupSwitcher) {
                    const updateDefaultListOptions = (isUserChange = false) => {
                        const defaultListId = adminSettings.defaultChecklistId;
                        const groupId = defaultGroupSwitcher.value;
                        defaultListSwitcher.innerHTML = '<option value="">Liste wählen...</option>';
                        if (!groupId || groupId === 'none') {
                            defaultListSwitcher.disabled = true;
                            if (groupId === 'none' && isUserChange) {
                                updateDoc(settingsDocRef, { defaultChecklistId: null });
                                adminSettings.defaultChecklistId = null;
                                alertUser("Standard-Liste wurde entfernt.", "success");
                            }
                            return;
                        }
                        const listsInGroup = Object.values(CHECKLISTS).filter(list => list.groupId === groupId);
                        defaultListSwitcher.innerHTML += listsInGroup.map(list => `<option value="${list.id}" ${list.id === defaultListId ? 'selected' : ''}>${list.name}</option>`).join('');
                        defaultListSwitcher.disabled = false;
                    };
                    defaultGroupSwitcher.addEventListener('change', () => updateDefaultListOptions(true));
                    updateDefaultListOptions(false);
                }

                if (defaultListSwitcher) {
                    defaultListSwitcher.addEventListener('change', async () => {
                        const newDefaultListId = defaultListSwitcher.value || null;
                        await updateDoc(settingsDocRef, { defaultChecklistId: newDefaultListId });
                        adminSettings.defaultChecklistId = newDefaultListId;
                        alertUser("Globale Standard-Liste wurde gespeichert.", "success");
                    });
                }

                const editorCard = view.querySelector('#card-list-item-editor');
                if (editorCard) {
                    editorCard.addEventListener('click', (e) => {
                        if (e.target.id === 'edit-group-assignment-btn') {
                            view.querySelector('#group-display-container').classList.add('hidden');
                            view.querySelector('#group-edit-container').classList.remove('hidden');
                        }
                    });
                }

                const createListBtn = view.querySelector('#checklist-settings-create-list-btn');
                if (createListBtn) {
                    createListBtn.addEventListener('click', async () => {
                        const newListName = view.querySelector('#checklist-settings-new-name').value.trim();
                        const groupId = view.querySelector('#checklist-settings-new-group-selector').value;
                        if (!newListName || !groupId) {
                            alertUser("Bitte geben Sie einen Listennamen und eine Gruppe an.", "error");
                            return;
                        }
                        const allActiveListNames = Object.values(CHECKLISTS).map(l => l.name.toLowerCase());
                        const allDeletedListNames = Object.values(DELETED_CHECKLISTS).map(l => l.name.toLowerCase());
                        const allListNames = [...allActiveListNames, ...allDeletedListNames];
                        if (allListNames.includes(newListName.toLowerCase())) {
                            alertUser(`Eine Liste mit dem Namen "${newListName}" existiert bereits.`, "error");
                            return;
                        }
                        const groupName = CHECKLIST_GROUPS[groupId].name;
                        const newListDoc = await addDoc(checklistsCollectionRef, { name: newListName, isDeleted: false, isArchived: false, groupId, groupName });
                        view.querySelector('#checklist-settings-new-name').value = '';
                        view.querySelector('#checklist-settings-new-group-selector').value = '';
                        alertUser(`Liste "${newListName}" wurde erstellt.`, "success");
                        renderChecklistSettingsView(newListDoc.id);
                    });
                }

                const saveGroupAssignmentBtn = view.querySelector('#checklist-save-group-assignment');
                if (saveGroupAssignmentBtn) {
                    saveGroupAssignmentBtn.addEventListener('click', async () => {
                        const listId = view.querySelector('#checklist-settings-editor-switcher').value;
                        const newGroupId = view.querySelector('#checklist-group-assign-switcher').value;
                        if (listId && newGroupId) {
                            const newGroupName = CHECKLIST_GROUPS[newGroupId].name;
                            await updateDoc(doc(checklistsCollectionRef, listId), { groupId: newGroupId, groupName: newGroupName });
                            alertUser("Gruppenzugehörigkeit gespeichert.", "success");
                            renderChecklistSettingsView(listId);
                        }
                    });
                }

                const archiveListBtn = view.querySelector('#checklist-archive-list-btn');
                if (archiveListBtn) {
                    archiveListBtn.addEventListener('click', async () => {
                        const listIdToArchive = view.querySelector('#checklist-settings-editor-switcher').value;
                        if (!listIdToArchive) return;
                        const listName = CHECKLISTS[listIdToArchive]?.name;
                        if (confirm(`Möchten Sie die Liste "${listName}" wirklich archivieren?`)) {
                            await updateDoc(doc(checklistsCollectionRef, listIdToArchive), { isArchived: true, archivedAt: serverTimestamp(), archivedBy: currentUser.displayName });
                            alertUser(`Liste "${listName}" wurde archiviert.`, "success");
                            // Die manuelle Neulade-Zeile wurde hier entfernt.
                        }
                    });
                }

                const showArchivedBtn = view.querySelector('#show-archived-lists-btn');
                if (showArchivedBtn) {
                    showArchivedBtn.addEventListener('click', () => {
                        renderArchivedListsModal();
                        document.getElementById('archivedListsModal').style.display = 'flex';
                    });
                }

                const showDeletedBtn = view.querySelector('#show-deleted-lists-btn');
                if (showDeletedBtn) {
                    showDeletedBtn.addEventListener('click', () => {
                        renderDeletedListsModal();
                        document.getElementById('deletedListsModal').style.display = 'flex';
                    });
                }

                const editorSwitcher = view.querySelector('#checklist-settings-editor-switcher');
                if (editorSwitcher) {
                    editorSwitcher.addEventListener('change', (e) => {
                        renderChecklistSettingsView(e.target.value);
                    });
                }

                const itemsEditorContainer = view.querySelector('#checklist-items-editor-container');
                if (itemsEditorContainer) {
                    itemsEditorContainer.addEventListener('click', async (e) => {
                        const editBtn = e.target.closest('.edit-checklist-item-btn');
                        const saveBtn = e.target.closest('.save-checklist-item-btn');
                        const deleteBtn = e.target.closest('.delete-checklist-item-btn');
                        if (editBtn) {
                            const itemDiv = editBtn.closest('[data-item-id]');
                            itemDiv.querySelector('.item-display-content').classList.add('hidden');
                            itemDiv.querySelector('.edit-checklist-item-btn').classList.add('hidden');
                            itemDiv.querySelector('.item-edit-content').classList.remove('hidden');
                            itemDiv.querySelector('.save-checklist-item-btn').classList.remove('hidden');
                            itemDiv.querySelector('input').focus();
                        }
                        if (saveBtn) {
                            const itemDiv = saveBtn.closest('[data-item-id]');
                            const itemId = itemDiv.dataset.itemId;
                            const newText = itemDiv.querySelector('input').value.trim();
                            if (newText) {
                                await updateDoc(doc(checklistItemsCollectionRef, itemId), { text: newText, lastEditedBy: currentUser.displayName, lastEditedAt: serverTimestamp() });
                                await logAdminAction('checklist_item_edited', `Checklisten-Eintrag (ID: ${itemId}) umbenannt.`);
                            }
                        }
                        if (deleteBtn) {
                            const itemDiv = deleteBtn.closest('[data-item-id]');
                            if (confirm("Möchten Sie diesen Eintrag wirklich löschen?")) {
                                const itemId = itemDiv.dataset.itemId;
                                await deleteDoc(doc(checklistItemsCollectionRef, itemId));
                                await logAdminAction('checklist_item_deleted', `Checklisten-Eintrag (ID: ${itemId}) gelöscht.`);
                            }
                        }
                    });
                }

                const addItemHandler = async () => {
                    const textInput = view.querySelector('#checklist-settings-add-text');
                    const suggestionsContainer = view.querySelector('#item-suggestions-container');
                    const text = textInput.value.trim();
                    const important = view.querySelector('#checklist-settings-add-important').checked;
                    const assigneeSelect = view.querySelector('#checklist-settings-add-assignee');
                    const assignedTo = assigneeSelect.value;
                    const assignedToName = assignedTo ? assigneeSelect.options[assigneeSelect.selectedIndex].text : null;
                    const categorySelect = view.querySelector('#checklist-settings-add-category');
                    const categoryId = categorySelect.value;

                    let categoryName = null;
                    let categoryColor = null;

                    if (categoryId) {
                        for (const group of Object.values(CHECKLIST_CATEGORIES)) {
                            const foundCat = group.find(cat => cat.id === categoryId);
                            if (foundCat) {
                                categoryName = foundCat.name;
                                categoryColor = foundCat.color || 'gray';
                                break;
                            }
                        }
                    }

                    const currentListId = view.querySelector('#checklist-settings-editor-switcher').value;
                    if (!currentListId) {
                        alertUser("Kann keinen Eintrag hinzufügen: Bitte erstellen Sie zuerst eine Liste.", "error");
                        return;
                    }
                    if (text) {
                        await addDoc(checklistItemsCollectionRef, {
                            listId: currentListId, text, status: 'open', important,
                            addedBy: currentUser.displayName, addedAt: serverTimestamp(),
                            assignedTo: assignedTo || null, assignedToName,
                            categoryId: categoryId || null, categoryName, categoryColor: categoryColor || null
                        });
                        await logAdminAction('checklist_item_added', `Checklisten-Eintrag "${text}" hinzugefügt.`);
                        textInput.value = '';
                        suggestionsContainer.innerHTML = '';
                        suggestionsContainer.classList.add('hidden');
                        view.querySelector('#checklist-settings-add-important').checked = false;
                        assigneeSelect.value = '';
                        categorySelect.value = '';
                        textInput.focus();
                    }
                };
                const addItemBtn = view.querySelector('#checklist-settings-add-item-btn');
                if (addItemBtn) addItemBtn.addEventListener('click', addItemHandler);

                const addTextInput = view.querySelector('#checklist-settings-add-text');
                const suggestionsContainer = view.querySelector('#item-suggestions-container');
                if (addTextInput && suggestionsContainer) {
                    addTextInput.addEventListener('input', (e) => {
                        const query = e.target.value.trim().toLowerCase();
                        if (query.length < 2) {
                            suggestionsContainer.innerHTML = '';
                            suggestionsContainer.classList.add('hidden');
                            return;
                        }

                        const allChecklistItems = Object.values(CHECKLIST_ITEMS).flat();
                        const allTemplateItems = Object.values(TEMPLATE_ITEMS).flat().map(item => ({ ...item, isTemplate: true }));
                        const combinedItems = [...allChecklistItems, ...allTemplateItems];

                        const uniqueItemsByText = new Map();
                        combinedItems.forEach(item => {
                            if (!uniqueItemsByText.has(item.text) || !item.isTemplate) {
                                uniqueItemsByText.set(item.text, item);
                            }
                        });
                        const matchingSuggestions = [...uniqueItemsByText.values()]
                            .filter(item => item.text.toLowerCase().includes(query))
                            .slice(0, 7);
                        if (matchingSuggestions.length > 0) {
                            suggestionsContainer.innerHTML = matchingSuggestions.map(item => {
                                const isImportant = item.important === true;
                                const importantClass = isImportant ? 'bg-yellow-50' :
                                    'hover:bg-gray-100';
                                const categoryButton = item.categoryId ?
                                    `<button class="apply-category-btn text-xs bg-purple-100 text-purple-700 font-bold py-1 px-2 rounded-md hover:bg-purple-200 flex-shrink-0" data-category-id="${item.categoryId}">+KAT</button>` :
                                    '';

                                let path = '';
                                if (item.isTemplate) {
                                    for (const templateId in TEMPLATE_ITEMS) {
                                        if (TEMPLATE_ITEMS[templateId].some(tItem => tItem.text === item.text)) {
                                            const parentContainer = TEMPLATES[templateId];
                                            const stackName = parentContainer.stackName || 'Kein Stack zugewiesen';
                                            path = `<span class="text-xs text-teal-700 font-medium">Pfad: ${stackName}/${parentContainer.name}</span>`;
                                            break;
                                        }
                                    }
                                } else {
                                    const parentList = CHECKLISTS[item.listId] ||
                                        ARCHIVED_CHECKLISTS[item.listId] || DELETED_CHECKLISTS[item.listId];
                                    if (parentList) {
                                        let prefix = 'Pfad: ';
                                        if (parentList.isArchived) prefix = 'Pfad: Archiv/';
                                        if (parentList.isDeleted) prefix = 'Pfad: Gelöscht/';
                                        const groupName = parentList.groupName ||
                                            'Gruppe gelöscht';
                                        path = `<span class="text-xs text-gray-500">${prefix}${groupName}/${parentList.name}</span>`;
                                    }
                                }

                                return `
                        <div class="suggestion-item p-2 flex justify-between items-center ${importantClass} cursor-pointer" data-important="${isImportant}">
                            <div class="flex flex-col items-start">
                                <span class="suggestion-text">${item.text}</span>
                                ${path}
                            </div>
                            ${categoryButton}
                        </div>
                    `;
                            }).join('');
                            suggestionsContainer.classList.remove('hidden');
                        } else {
                            suggestionsContainer.innerHTML = '';
                            suggestionsContainer.classList.add('hidden');
                        }
                    });
                    addTextInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addItemHandler();
                        }
                    });
                    suggestionsContainer.addEventListener('click', (e) => {
                        const suggestionItem = e.target.closest('.suggestion-item');
                        if (!suggestionItem) return;

                        const applyCategoryBtn = e.target.closest('.apply-category-btn');
                        const textSpan = suggestionItem.querySelector('.suggestion-text');
                        const isImportant = suggestionItem.dataset.important === 'true';
                        const importantCheckbox = view.querySelector('#checklist-settings-add-important');

                        if (applyCategoryBtn) {
                            addTextInput.value = textSpan.textContent;
                            const categoryId = applyCategoryBtn.dataset.categoryId;
                            view.querySelector('#checklist-settings-add-category').value = categoryId;
                        } else {
                            addTextInput.value = textSpan.textContent;
                        }

                        importantCheckbox.checked = isImportant;
                        suggestionsContainer.innerHTML = '';
                        suggestionsContainer.classList.add('hidden');
                        addTextInput.focus();
                    });

                    document.addEventListener('click', (e) => {
                        if (!addTextInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                            suggestionsContainer.classList.add('hidden');
                        }
                    });
                }
            }

            function setupGroupManagementListeners(view, currentUserData) {
                const createGroupForm = view.querySelector('#create-group-form');
                const showCreateGroupBtn = view.querySelector('#show-create-group-form-btn');
                if (showCreateGroupBtn) {
                    showCreateGroupBtn.addEventListener('click', () => {
                        createGroupForm.classList.remove('hidden');
                        createGroupForm.classList.add('flex');
                        showCreateGroupBtn.classList.add('hidden');
                    });
                }

                const createGroupBtn = view.querySelector('#checklist-settings-create-group-btn');
                if (createGroupBtn) {
                    createGroupBtn.addEventListener('click', async () => {
                        const nameInput = view.querySelector('#checklist-settings-new-group-name');
                        const newName = nameInput.value.trim();
                        if (!newName) return;
                        const allGroupNames = Object.values(CHECKLIST_GROUPS).map(g => g.name.toLowerCase());
                        if (allGroupNames.includes(newName.toLowerCase())) {
                            alertUser(`Eine Gruppe mit dem Namen "${newName}" existiert bereits.`, 'error');
                            return;
                        }
                        await addDoc(checklistGroupsCollectionRef, { name: newName });
                        nameInput.value = '';
                        alertUser(`Gruppe "${newName}" wurde erstellt.`, 'success');
                    });
                }

                const editGroupBtn = view.querySelector('#edit-selected-group-btn');
                if (editGroupBtn) {
                    editGroupBtn.addEventListener('click', async () => {
                        const groupId = view.querySelector('#manage-groups-dropdown').value;
                        if (!groupId) {
                            alertUser("Bitte wählen Sie eine Gruppe zum Bearbeiten aus.", "error");
                            return;
                        }
                        const groupName = CHECKLIST_GROUPS[groupId]?.name;
                        const newName = prompt(`Neuen Namen für die Gruppe "${groupName}" eingeben:`, groupName);
                        if (newName && newName.trim() !== groupName) {
                            const trimmedNewName = newName.trim();
                            const allGroupNames = Object.values(CHECKLIST_GROUPS).map(g => g.name.toLowerCase());
                            if (allGroupNames.includes(trimmedNewName.toLowerCase())) {
                                alertUser(`Eine Gruppe mit dem Namen "${trimmedNewName}" existiert bereits.`, "error");
                                return;
                            }
                            const batch = writeBatch(db);
                            batch.update(doc(checklistGroupsCollectionRef, groupId), { name: trimmedNewName });
                            const listsToUpdate = Object.values(CHECKLISTS).filter(list => list.groupId === groupId);
                            listsToUpdate.forEach(list => {
                                batch.update(doc(checklistsCollectionRef, list.id), { groupName: trimmedNewName });
                            });
                            await batch.commit();
                            alertUser("Gruppe wurde umbenannt.", "success");
                        }
                    });
                }

                const deleteGroupBtn = view.querySelector('#delete-selected-group-btn');
                if (deleteGroupBtn) {
                    deleteGroupBtn.addEventListener('click', async (e) => {
                        const groupId = view.querySelector('#manage-groups-dropdown').value;
                        if (!groupId) {
                            alertUser("Bitte wählen Sie eine Gruppe zum Löschen aus.", "error");
                            return;
                        }
                        const groupName = CHECKLIST_GROUPS[groupId]?.name;
                        const currentDefaultListId = USERS[currentUser.mode]?.defaultChecklistId;
                        const defaultList = CHECKLISTS[currentDefaultListId];
                        if (defaultList && defaultList.groupId === groupId) {
                            alertUser(`Die Gruppe "${groupName}" kann nicht gelöscht werden, da eine Liste daraus ("${defaultList.name}") als Ihre aktuelle Checkliste festgelegt ist.`, "error");
                            return;
                        }
                        if (!confirm(`WARNUNG: Alle Listen in der Gruppe "${groupName}" werden in den Papierkorb verschoben. Fortfahren?`)) return;
                        const finalConfirmation = prompt(`Um die Gruppe "${groupName}" und alle ihre Listen in den Papierkorb zu verschieben, geben Sie bitte "GRUPPE LÖSCHEN" ein:`);
                        if (finalConfirmation === 'GRUPPE LÖSCHEN') {
                            const batch = writeBatch(db);
                            const listsToDelete = Object.values(CHECKLISTS).filter(list => list.groupId === groupId);
                            listsToDelete.forEach(list => {
                                batch.update(doc(checklistsCollectionRef, list.id), { isDeleted: true, deletedAt: serverTimestamp(), deletedBy: currentUser.displayName });
                            });
                            batch.delete(doc(checklistGroupsCollectionRef, groupId));
                            await batch.commit();
                            alertUser(`Gruppe "${groupName}" und zugehörige Listen wurden in den Papierkorb verschoben.`, "success");
                            // Die manuelle Neulade-Zeile wurde hier entfernt.
                        } else if (finalConfirmation !== null) {
                            alertUser("Löschvorgang abgebrochen.", "error");
                        }
                    });
                }
            }

            function setupStackAndContainerManagementListeners(view) {
                const templatesCard = view.querySelector('#card-templates');
                if (!templatesCard || templatesCard.dataset.listenerAttached === 'true') {
                    return; // Verhindert, dass der Listener mehrfach hinzugefügt wird
                }

                templatesCard.addEventListener('click', async (e) => {
                    // --- Logik zum Auswählen und Abwählen eines Containers ---
                    const containerItem = e.target.closest('.template-selection-item');
                    if (containerItem && !e.target.closest('button') && !e.target.closest('select')) {
                        const clickedTemplateId = containerItem.dataset.templateId;
                        const editor = document.getElementById('template-item-editor');

                        if (selectedTemplateId === clickedTemplateId) {
                            // FALL 1: Bereits ausgewählter Container wird erneut geklickt -> Abwählen
                            selectedTemplateId = null;
                            editor.classList.add('hidden');
                            if (unsubscribeTemplateItems) unsubscribeTemplateItems();
                        } else {
                            // FALL 2: Ein neuer Container wird ausgewählt
                            selectedTemplateId = clickedTemplateId;
                            const editorTitle = document.getElementById('template-editor-title');
                            editorTitle.textContent = `Einträge für Container "${TEMPLATES[selectedTemplateId].name}"`;
                            editor.classList.remove('hidden');

                            if (unsubscribeTemplateItems) unsubscribeTemplateItems();

                            const itemsSubCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-templates', selectedTemplateId, 'template-items');
                            unsubscribeTemplateItems = onSnapshot(query(itemsSubCollectionRef, orderBy('text')), (snapshot) => {
                                TEMPLATE_ITEMS[selectedTemplateId] = [];
                                snapshot.forEach(doc => TEMPLATE_ITEMS[selectedTemplateId].push({ id: doc.id, ...doc.data() }));
                                renderTemplateItemsEditor();
                            });
                        }
                        renderContainerList(); // Zeichnet die Liste neu, um die Markierung zu aktualisieren
                        return;
                    }

                    // --- Logik für "ändern" und "speichern" der Stack-Zuweisung ---
                    const changeStackBtn = e.target.closest('.change-stack-btn');
                    if (changeStackBtn) {
                        const containerId = changeStackBtn.dataset.containerId;
                        document.getElementById(`stack-display-container-${containerId}`).classList.add('hidden');
                        document.getElementById(`stack-edit-container-${containerId}`).classList.remove('hidden');
                        return;
                    }

                    const saveStackBtn = e.target.closest('.save-stack-assignment-btn');
                    if (saveStackBtn) {
                        const containerId = saveStackBtn.dataset.containerId;
                        const editContainer = document.getElementById(`stack-edit-container-${containerId}`);
                        const newStackId = editContainer.querySelector('.stack-assign-switcher').value;

                        const newStackName = newStackId ? CHECKLIST_STACKS[newStackId]?.name : null;
                        const templateRef = doc(db, 'artifacts', appId, 'public', 'data', 'checklist-templates', containerId);
                        await updateDoc(templateRef, { stackId: newStackId || null, stackName: newStackName });
                        alertUser("Stack-Zuweisung gespeichert.", "success");

                        return;
                    }

                    // --- Hinzufügen eines Eintrags zum ausgewählten Container ---
                    if (e.target.closest('#add-template-item-btn') && selectedTemplateId) {
                        const textInput = document.getElementById('new-template-item-text');
                        const text = textInput.value.trim();
                        if (!text) return alertUser("Bitte Text für den Eintrag eingeben.", "error");

                        const assigneeSelect = document.getElementById('new-template-item-assignee');
                        const categorySelect = document.getElementById('new-template-item-category');
                        const importantCheckbox = document.getElementById('new-template-item-important');
                        const assignedTo = assigneeSelect.value;
                        const assignedToName = assignedTo ? assigneeSelect.options[assigneeSelect.selectedIndex].text : null;
                        const categoryId = categorySelect.value;
                        const categoryName = categoryId ? categorySelect.options[categorySelect.selectedIndex].text : null;
                        let categoryColor = null;
                        if (categoryId) {
                            for (const group of Object.values(CHECKLIST_CATEGORIES)) {
                                const foundCat = group.find(cat => cat.id === categoryId);
                                if (foundCat) { categoryColor = foundCat.color || 'gray'; break; }
                            }
                        }

                        const newItemData = { text, important: importantCheckbox.checked, assignedTo, assignedToName, categoryId, categoryName, categoryColor };
                        const itemsSubCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-templates', selectedTemplateId, 'template-items');
                        await addDoc(itemsSubCollectionRef, newItemData);

                        textInput.value = '';
                        assigneeSelect.value = '';
                        categorySelect.value = '';
                        importantCheckbox.checked = false;
                        textInput.focus();
                        return;
                    }

                    // --- Löschen eines einzelnen Eintrags aus einem Container ---
                    const deleteTemplateItemBtn = e.target.closest('.delete-template-item-btn');
                    if (deleteTemplateItemBtn && selectedTemplateId) {
                        const itemId = deleteTemplateItemBtn.dataset.itemId;
                        if (confirm("Möchten Sie diesen Eintrag wirklich aus dem Container löschen?")) {
                            const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'checklist-templates', selectedTemplateId, 'template-items', itemId);
                            await deleteDoc(itemRef);
                        }
                        return;
                    }

                    // --- Löschen des gesamten Containers ---
                    const deleteTemplateBtn = e.target.closest('#delete-template-btn');
                    if (deleteTemplateBtn && selectedTemplateId) {
                        if (confirm(`Möchten Sie den Container "${TEMPLATES[selectedTemplateId].name}" wirklich unwiderruflich löschen?`)) {
                            const templateRef = doc(db, 'artifacts', appId, 'public', 'data', 'checklist-templates', selectedTemplateId);
                            await deleteDoc(templateRef);
                            selectedTemplateId = null;
                            document.getElementById('template-item-editor').classList.add('hidden');
                            renderContainerList();
                        }
                        return;
                    }

                    // --- Logik für Stacks (Erstellen, Umbenennen, Löschen) ---
                    const createStackForm = view.querySelector('#create-stack-form');
                    const showCreateStackBtn = view.querySelector('#show-create-stack-form-btn');
                    if (e.target.closest('#show-create-stack-form-btn')) {
                        createStackForm.classList.remove('hidden');
                        createStackForm.classList.add('flex');
                        showCreateStackBtn.classList.add('hidden');
                        return;
                    }

                    if (e.target.closest('#checklist-settings-create-stack-btn')) {
                        const nameInput = view.querySelector('#checklist-settings-new-stack-name');
                        const newName = nameInput.value.trim();
                        if (!newName) return;
                        const allStackNames = Object.values(CHECKLIST_STACKS).map(s => s.name.toLowerCase());
                        if (allStackNames.includes(newName.toLowerCase())) {
                            alertUser(`Ein Stack mit dem Namen "${newName}" existiert bereits.`, 'error');
                            return;
                        }
                        const checklistStacksCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-stacks');
                        await addDoc(checklistStacksCollectionRef, { name: newName });
                        nameInput.value = '';
                        alertUser(`Stack "${newName}" wurde erstellt.`, 'success');
                        return;
                    }

                    if (e.target.closest('#checklist-settings-create-container-btn')) {
                        const newName = view.querySelector('#checklist-settings-new-container-name').value.trim();
                        const stackId = view.querySelector('#checklist-settings-new-stack-selector').value;
                        if (!stackId) return alertUser("Bitte wählen Sie einen Stack für den neuen Container aus.", "error");
                        if (!newName) return alertUser("Bitte geben Sie einen Namen für den Container an.", "error");

                        const templatesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-templates');
                        await addDoc(templatesCollectionRef, { name: newName, stackId, stackName: CHECKLIST_STACKS[stackId].name, createdAt: serverTimestamp() });
                        view.querySelector('#checklist-settings-new-container-name').value = '';
                        view.querySelector('#checklist-settings-new-stack-selector').value = '';
                        alertUser(`Container "${newName}" wurde erstellt.`, 'success');
                        return;
                    }

                    const editStackBtn = e.target.closest('#edit-selected-stack-btn');
                    if (editStackBtn) {
                        const stackId = view.querySelector('#manage-stacks-dropdown').value;
                        if (!stackId) return alertUser("Bitte wählen Sie einen Stack zum Bearbeiten aus.", "error");

                        const stackName = CHECKLIST_STACKS[stackId]?.name;
                        const newName = prompt(`Neuen Namen für den Stack "${stackName}" eingeben:`, stackName);
                        if (newName && newName.trim() !== stackName) {
                            const trimmedNewName = newName.trim();
                            const allStackNames = Object.values(CHECKLIST_STACKS).map(g => g.name.toLowerCase());
                            if (allStackNames.includes(trimmedNewName.toLowerCase())) {
                                alertUser(`Ein Stack mit dem Namen "${trimmedNewName}" existiert bereits.`, "error");
                                return;
                            }
                            const checklistStacksCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-stacks');
                            await updateDoc(doc(checklistStacksCollectionRef, stackId), { name: trimmedNewName });
                            alertUser("Stack wurde umbenannt.", "success");
                        }
                        return;
                    }

                    const deleteStackBtn = e.target.closest('#delete-selected-stack-btn');
                    if (deleteStackBtn) {
                        const stackId = view.querySelector('#manage-stacks-dropdown').value;
                        if (!stackId) return alertUser("Bitte wählen Sie einen Stack zum Löschen aus.", "error");

                        const stackName = CHECKLIST_STACKS[stackId]?.name;
                        if (!confirm(`WARNUNG: Alle Container im Stack "${stackName}" verlieren ihre Zuordnung. Der Stack wird endgültig gelöscht. Fortfahren?`)) return;

                        try {
                            const templatesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-templates');
                            const q = query(templatesCollectionRef, where("stackId", "==", stackId));
                            const containersToUpdateSnapshot = await getDocs(q);

                            const batch = writeBatch(db);

                            containersToUpdateSnapshot.forEach(containerDoc => {
                                batch.update(containerDoc.ref, {
                                    stackId: null,
                                    stackName: null
                                });
                            });

                            const checklistStacksCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-stacks');
                            batch.delete(doc(checklistStacksCollectionRef, stackId));

                            await batch.commit();
                            alertUser(`Stack "${stackName}" wurde gelöscht.`, "success");

                        } catch (error) {
                            console.error("Error deleting stack and updating containers:", error);
                            alertUser("Fehler beim Löschen des Stacks.", "error");
                        }
                        return;
                    }
                });

                templatesCard.dataset.listenerAttached = 'true';
            }



            // ########## ENDE DES NEUEN CODES ##########



            // ERSETZE DEINE AKTUELLE FUNKTION HIERMIT:
            function renderChecklistSettingsView(editListId = null) {
                const view = document.getElementById('checklistSettingsView');
                const currentUserData = USERS[currentUser.mode] || {};

                // WICHTIG: Diese beiden Zeilen müssen VOR der Berechnung von 'listToEditId' stehen.
                const hasLists = Object.keys(CHECKLISTS).length > 0;
                const defaultListId = adminSettings.defaultChecklistId;
                // Liest die globale Einstellung

                // KORREKTUR: Die Berechnung von 'listToEditId' kommt jetzt NACH der Definition von 'hasLists'.
                const listToEditId = editListId || view.dataset.editingListId || (hasLists ? Object.keys(CHECKLISTS)[0] : null);
                view.dataset.editingListId = listToEditId;

                const defaultGroupId = defaultListId ?
                    CHECKLISTS[defaultListId]?.groupId : null;
                let defaultGroupOptions = `<option value="none" ${!defaultListId ? 'selected' : ''}>(Keine Liste)</option>` + Object.values(CHECKLIST_GROUPS).map(group => `<option value="${group.id}" ${group.id === defaultGroupId ? 'selected' : ''}>${group.name}</option>`).join('');

                const listToEdit = CHECKLISTS[listToEditId];
                const groupOptions = Object.values(CHECKLIST_GROUPS).map(group => `<option value="${group.id}" ${listToEdit && listToEdit.groupId === group.id ? 'selected' : ''}>${group.name}</option>`).join('');
                const stackOptions = Object.values(CHECKLIST_STACKS).map(stack => `<option value="${stack.id}">${stack.name}</option>`).join('');

                const userOptions = `<option value="">Keine Zuweisung</option>` + Object.values(USERS).filter(u => u.name).map(user => `<option value="${user.id}">${user.name}</option>`).join('');
                const categoryOptions = `<option value="">Keine Kategorie</option>` + Object.values(CHECKLIST_GROUPS).map(group => {
                    const categoriesInGroup = CHECKLIST_CATEGORIES[group.id] || [];
                    if (categoriesInGroup.length === 0) return '';
                    return `<optgroup label="${group.name}">${categoriesInGroup.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}</optgroup>`;
                }).join('');

                view.innerHTML = `
        <div class="back-link-container w-full mb-2"></div>
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Checklisten-Einstellungen</h2>
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-gray-500 mb-1 px-1">Verwalten</h3>
            <div id="settings-tabs" class="grid grid-cols-2 sm:grid-cols-4 gap-1 border rounded-lg bg-gray-100 p-1">
                <button data-target-card="card-default-list" class="settings-tab-btn p-2 text-sm font-semibold rounded-md text-gray-600">Standard</button>
                <button data-target-card="card-manage-lists" class="settings-tab-btn p-2 text-sm font-semibold rounded-md text-gray-600">Gruppen & Listen</button>
                <button data-target-card="card-categories" class="settings-tab-btn p-2 text-sm font-semibold rounded-md text-gray-600">Kategorien</button>
                <button data-target-card="card-templates" class="settings-tab-btn p-2 text-sm font-semibold rounded-md text-gray-600">Stack & Container</button>
            </div>
        </div>
        <div id="card-default-list" class="settings-card space-y-6 hidden"></div>
        <div id="card-manage-lists" class="settings-card space-y-6 hidden"></div>
        <div id="card-categories" class="settings-card hidden"></div>
        <div id="card-templates" class="settings-card hidden space-y-6"></div>
        <div id="card-list-item-editor" class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-green-500 mt-6"></div>
    `;
                view.querySelector('.back-link-container').innerHTML = `<button class="back-link flex items-center text-gray-600 hover:text-indigo-600 transition" data-target="home"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-1"><path d="m15 18-6-6 6-6" /></svg><span class="text-sm font-semibold">zurück</span></button><div class="border-t border-gray-300 mt-2"></div>`;
                view.querySelector('#card-default-list').innerHTML = `<div class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-indigo-500"><h3 class="font-bold text-gray-800 mb-2">Globale Standard-Checkliste festlegen</h3><p class="text-sm text-gray-600 mb-3">Diese Einstellung gilt für alle Benutzer.</p><div class="flex gap-2"><select id="checklist-settings-default-group-switcher" class="w-1/2 p-2 border rounded-lg bg-white">${defaultGroupOptions}</select><select id="checklist-settings-default-list-switcher" class="w-1/2 p-2 border rounded-lg bg-white" ${!defaultGroupId ? 'disabled' : ''}><option>...</option></select></div></div>`;
                view.querySelector('#card-manage-lists').innerHTML = `<div class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-gray-500"><h3 class="font-bold text-gray-800 mb-2">Gruppen & Listen verwalten</h3><div class="p-3 bg-gray-50 rounded-lg space-y-3 mb-4 border-b pb-4"><h4 class="font-semibold text-sm text-gray-700">Gruppen verwalten</h4><div class="flex items-center gap-2"><select id="manage-groups-dropdown" class="flex-grow p-2 border rounded-lg bg-white">${groupOptions}</select><button id="edit-selected-group-btn" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition" title="Gruppe umbenennen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L6.75 6.775a.75.75 0 0 0-.22.53l-.5 2.5a.75.75 0 0 0 .913.913l2.5-.5a.75.75 0 0 0 .53-.22l4.263-4.262a1.75 1.75 0 0 0 0-2.475Z" /><path d="M4.75 3.5c-.69 0-1.25.56-1.25 1.25v9.5c0 .69.56 1.25 1.25 1.25h9.5c.69 0 1.25-.56 1.25-1.25V9.5a.75.75 0 0 1 1.5 0v5.25A2.75 2.75 0 0 1 14.25 18h-9.5A2.75 2.75 0 0 1 2 15.25v-9.5A2.75 2.75 0 0 1 4.75 3.5h5.25a.75.75 0 0 1 0 1.5H4.75Z" /></svg></button><button id="delete-selected-group-btn" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Gruppe löschen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5Z" clip-rule="evenodd" /></svg></button></div><div id="create-group-form" class="hidden flex gap-2 pt-2 border-t"><input type="text" id="checklist-settings-new-group-name" class="flex-grow p-2 border rounded-lg" placeholder="Name für neue Gruppe..."><button id="checklist-settings-create-group-btn" class="py-2 px-3 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition">Erstellen</button></div><button id="show-create-group-form-btn" class="w-full text-left text-sm text-blue-600 font-semibold hover:underline">+ Neue Gruppe erstellen</button></div><div class="p-3 bg-gray-50 rounded-lg space-y-3"><h4 class="font-semibold text-sm text-gray-700">Neue Liste erstellen</h4><input type="text" id="checklist-settings-new-name" class="w-full p-2 border rounded-lg" placeholder="Name der neuen Liste..."><select id="checklist-settings-new-group-selector" class="w-full p-2 border rounded-lg bg-white"><option value="">Gruppe für neue Liste wählen...</option>${groupOptions}</select><button id="checklist-settings-create-list-btn" class="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Liste erstellen</button></div><div class="mt-4 border-t pt-4 grid grid-cols-2 gap-2"><button id="show-archived-lists-btn" class="w-full py-2 text-sm text-gray-700 font-semibold bg-gray-100 rounded-lg hover:bg-gray-200">Archiv</button><button id="show-deleted-lists-btn" class="w-full py-2 text-sm text-gray-700 font-semibold bg-gray-100 rounded-lg hover:bg-gray-200">Papierkorb</button></div></div>`;
                view.querySelector('#card-categories').innerHTML = `<div class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-cyan-500"><h3 class="font-bold text-gray-800 mb-2">Kategorien verwalten</h3><p class="text-sm text-gray-600 mb-3">Wählen Sie eine Gruppe, um deren spezifische Kategorien zu bearbeiten.</p><select id="category-group-selector" class="w-full p-2 border rounded-lg bg-white mb-4"><option value="">Gruppe wählen...</option>${groupOptions}</select><div id="category-content"><p class="text-sm text-center text-gray-500">Bitte wählen Sie eine Gruppe, um deren Kategorien zu verwalten.</p></div></div>`;
                view.querySelector('#card-templates').innerHTML = `<div class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-teal-500"><h3 class="font-bold text-gray-800 mb-2">Stack & Container verwalten</h3><div class="p-3 bg-gray-50 rounded-lg space-y-3 mb-4 border-b pb-4"><h4 class="font-semibold text-sm text-gray-700">Stacks verwalten</h4><div class="flex items-center gap-2"><select id="manage-stacks-dropdown" class="flex-grow p-2 border rounded-lg bg-white">${stackOptions}</select><button id="edit-selected-stack-btn" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition" title="Stack umbenennen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L6.75 6.775a.75.75 0 0 0-.22.53l-.5 2.5a.75.75 0 0 0 .913.913l2.5-.5a.75.75 0 0 0 .53-.22l4.263-4.262a1.75 1.75 0 0 0 0-2.475Z" /><path d="M4.75 3.5c-.69 0-1.25.56-1.25 1.25v9.5c0 .69.56 1.25 1.25 1.25h9.5c.69 0 1.25-.56 1.25-1.25V9.5a.75.75 0 0 1 1.5 0v5.25A2.75 2.75 0 0 1 14.25 18h-9.5A2.75 2.75 0 0 1 2 15.25v-9.5A2.75 2.75 0 0 1 4.75 3.5h5.25a.75.75 0 0 1 0 1.5H4.75Z" /></svg></button><button id="delete-selected-stack-btn" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Stack löschen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5Z" clip-rule="evenodd" /></svg></button></div><div id="create-stack-form" class="hidden flex gap-2 pt-2 border-t"><input type="text" id="checklist-settings-new-stack-name" class="flex-grow p-2 border rounded-lg" placeholder="Name für neuen Stack..."><button id="checklist-settings-create-stack-btn" class="py-2 px-3 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition">Erstellen</button></div><button id="show-create-stack-form-btn" class="w-full text-left text-sm text-blue-600 font-semibold hover:underline">+ Neuen Stack erstellen</button></div><div class="p-3 bg-gray-50 rounded-lg space-y-3"><h4 class="font-semibold text-sm text-gray-700">Neuen Container erstellen</h4><input type="text" id="checklist-settings-new-container-name" class="w-full p-2 border rounded-lg" placeholder="Name des neuen Containers..."><select id="checklist-settings-new-stack-selector" class="w-full p-2 border rounded-lg bg-white"><option value="">Stack für neuen Container wählen...</option>${stackOptions}</select><button id="checklist-settings-create-container-btn" class="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Container erstellen</button></div><div class="card bg-white p-4 rounded-xl shadow-lg border-t-4 border-gray-500 mt-6"><div id="container-list-editor"></div><div id="template-item-editor" class="hidden"><div class="border-t pt-4"><div class="flex justify-between items-center mb-2"><h4 id="template-editor-title" class="font-semibold text-gray-700"></h4><button id="delete-template-btn" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Diesen Container löschen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193v-.443A2.75 2.75 0 0011.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5Zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5Z" clip-rule="evenodd" /></svg></button></div><div class="p-3 bg-gray-50 rounded-lg space-y-3 mb-4"><input type="text" id="new-template-item-text" class="w-full p-2 border rounded-lg" placeholder="Neuer Eintrag für den Container..."><div class="grid grid-cols-2 gap-2"><select id="new-template-item-assignee" class="p-2 border rounded-lg bg-white text-sm">${userOptions}</select><select id="new-template-item-category" class="p-2 border rounded-lg bg-white text-sm">${categoryOptions}</select></div><div class="flex items-center"><input type="checkbox" id="new-template-item-important" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="new-template-item-important" class="ml-2 text-sm text-gray-700">Als wichtig markieren</label></div><button id="add-template-item-btn" class="w-full py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Eintrag zum Container hinzufügen</button></div><div id="template-items-list" class="space-y-2"></div></div></div></div>`;

                const currentGroupName = CHECKLISTS[listToEditId]?.groupName || 'Keine';
                const editorCardContent = `
        <div class="flex gap-2 items-center mb-2">
            <select id="checklist-settings-editor-switcher" class="flex-grow p-2 border rounded-lg bg-white" ${!hasLists ? 'disabled' : ''}>
                ${Object.values(CHECKLIST_GROUPS).map(group => { const listsInGroup = Object.values(CHECKLISTS).filter(list => list.groupId === group.id); if (listsInGroup.length === 0) return ''; return `<optgroup label="${group.name}">${listsInGroup.map(list => `<option value="${list.id}" ${list.id === listToEditId ? 'selected' : ''}>${list.name}</option>`).join('')}</optgroup>`; }).join('')}
            </select>
            <button id="show-template-modal-btn" title="Container anwenden" class="p-2 bg-teal-100 text-teal-800 text-sm font-bold rounded-lg hover:bg-teal-200 transition" ${!hasLists ? 'disabled' : ''}>+C</button>
            <button id="checklist-archive-list-btn" title="Liste archivieren" class="p-2 bg-yellow-100 text-yellow-800 rounded-lg hover:bg-yellow-200 transition" ${!hasLists ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M2 3.5A1.5 1.5 0 0 1 3.5 2h13A1.5 1.5 0 0 1 18 3.5v10A1.5 1.5 0 0 1 16.5 15h-13A1.5 1.5 0 0 1 2 13.5v-10Zm14.5.5a.5.5 0 0 0-.5-.5h-13a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-10ZM8 7a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-2.5A.75.75 0 0 1 8 7Z" /></svg></button>
        </div>
        <div class="mb-4 p-2 bg-gray-100 rounded-lg">
            <div id="group-display-container" class="flex justify-between items-center">
                <p class="text-sm">Aktuelle Gruppe: <span class="font-bold">${currentGroupName}</span></p>
                <button id="edit-group-assignment-btn" class="text-sm font-semibold text-blue-600 hover:underline">ändern</button>
            </div>
            <div id="group-edit-container" class="hidden flex gap-2 items-center">
                <select id="checklist-group-assign-switcher" class="flex-grow p-2 border rounded-lg bg-white text-sm" ${!hasLists ? 'disabled' : ''}>${groupOptions}</select>
                <button id="checklist-save-group-assignment" class="py-2 px-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition text-sm" ${!hasLists ? 'disabled' : ''}>Speichern</button>
            </div>
        </div>
        <div class="p-3 bg-gray-50 rounded-lg space-y-3 mb-4 border-t pt-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <div class="relative sm:col-span-2">
                    <input type="text" id="checklist-settings-add-text" class="w-full p-2 border rounded-lg" placeholder="Neuer Eintrag..." ${!hasLists ? 'disabled' : ''} autocomplete="off">
                    <div id="item-suggestions-container" class="absolute z-10 w-full bg-white border rounded-lg mt-1 hidden max-h-48 overflow-y-auto shadow-lg"></div>
                </div>
                <select id="checklist-settings-add-assignee" class="p-2 border rounded-lg bg-white w-full" ${!hasLists ? 'disabled' : ''}>${userOptions}</select>
                <select id="checklist-settings-add-category" class="p-2 border rounded-lg bg-white w-full" ${!hasLists ? 'disabled' : ''}>${categoryOptions}</select>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="checklist-settings-add-important" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${!hasLists ? 'disabled' : ''}>
                <label for="checklist-settings-add-important" class="ml-2 text-sm text-gray-700">Als wichtig markieren</label>
            </div>
            <button id="checklist-settings-add-item-btn" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition ${!hasLists ? 'opacity-50 cursor-not-allowed' : ''}" ${!hasLists ? 'disabled' : ''}>Eintrag hinzufügen</button>
        </div>
        <div id="checklist-items-editor-container" class="space-y-2 mb-4">${!hasLists ? '<p class="text-center text-sm text-gray-500">Keine Listen vorhanden. Bitte erstellen Sie zuerst eine.</p>' : ''}</div>
        
        `;
                view.querySelector('#card-list-item-editor').innerHTML = editorCardContent;

                const tabs = view.querySelector('#settings-tabs');
                if (tabs && !tabs.dataset.listenerAttached) {
                    tabs.addEventListener('click', (e) => {
                        const clickedTab = e.target.closest('.settings-tab-btn');
                        if (!clickedTab) return;
                        const targetCardId = clickedTab.dataset.targetCard;
                        const editorCard = view.querySelector('#card-list-item-editor');
                        const isAlreadyActive = clickedTab.classList.contains('bg-white');
                        view.querySelectorAll('.settings-tab-btn').forEach(tab => {
                            tab.classList.remove('bg-white', 'shadow', 'text-indigo-600');
                            tab.classList.add('text-gray-600');
                        });
                        view.querySelectorAll('.settings-card').forEach(card => card.classList.add('hidden'));
                        if (isAlreadyActive) {
                            editorCard.classList.remove('hidden');
                        } else {
                            editorCard.classList.add('hidden');
                            clickedTab.classList.add('bg-white', 'shadow', 'text-indigo-600');
                            clickedTab.classList.remove('text-gray-600');
                            const targetCard = view.querySelector(`#${targetCardId}`);
                            if (targetCard) {
                                targetCard.classList.remove('hidden');
                            }
                            if (targetCardId === 'card-templates') {
                                renderContainerList();
                                setupStackAndContainerManagementListeners(view);
                            }
                        }
                    });
                    tabs.dataset.listenerAttached = 'true';
                }

                if (hasLists) {
                    const selectedGroupForList = CHECKLISTS[listToEditId]?.groupId;
                    if (selectedGroupForList) {
                        const assignSwitcher = view.querySelector('#checklist-group-assign-switcher');
                        if (assignSwitcher) {
                            assignSwitcher.value = selectedGroupForList;
                        }
                    }
                    renderChecklistSettingsItems(listToEditId);
                }

                setupGroupManagementListeners(view, currentUserData);
                setupListAndItemManagementListeners(view);
                setupCategoryManagementListeners(view);
            }
            function setupCategoryManagementListeners(view) {
                const groupSelector = view.querySelector('#category-group-selector');
                const categoryContent = view.querySelector('#category-content');

                if (groupSelector) {
                    groupSelector.addEventListener('change', () => renderCategoryEditor(groupSelector.value));
                }

                if (categoryContent) {
                    categoryContent.addEventListener('click', async (e) => {
                        const editBtn = e.target.closest('.edit-category-btn');
                        const saveBtn = e.target.closest('.save-category-btn');
                        const deleteBtn = e.target.closest('.delete-category-btn');
                        const createBtn = e.target.closest('#create-category-btn');
                        const newColorDot = e.target.closest('.new-color-dot');
                        const existingColorDot = e.target.closest('.color-dot');
                        const groupId = groupSelector.value;

                        if (editBtn) {
                            const catDiv = editBtn.closest('[data-category-id]');
                            catDiv.querySelector('.cat-display-content').classList.add('hidden');
                            editBtn.classList.add('hidden');
                            catDiv.querySelector('.cat-edit-content').classList.remove('hidden');
                            catDiv.querySelector('.save-category-btn').classList.remove('hidden');
                            // Zeige die Farbpalette für diesen Eintrag
                            const paletteEditor = catDiv.nextElementSibling;
                            if (paletteEditor && paletteEditor.classList.contains('color-palette-editor')) {
                                paletteEditor.classList.remove('hidden');
                            }
                        }
                        if (saveBtn) {
                            const catDiv = saveBtn.closest('[data-category-id]');
                            const catId = catDiv.dataset.categoryId;
                            const newName = catDiv.querySelector('input').value.trim();
                            if (newName) await updateDoc(doc(checklistCategoriesCollectionRef, catId), { name: newName });
                            // Verstecke die Bearbeitungsansicht wieder (wird durch Live-Update erledigt)
                        }
                        if (deleteBtn) {
                            const catDiv = deleteBtn.closest('[data-category-id]');
                            const catId = catDiv.dataset.categoryId;
                            const catName = catDiv.querySelector('.cat-display-content span').textContent;
                            if (confirm(`Möchten Sie die Kategorie "${catName}" wirklich löschen?`)) {
                                await deleteDoc(doc(checklistCategoriesCollectionRef, catId));
                            }
                        }
                        if (createBtn) {
                            const nameInput = categoryContent.querySelector('#new-category-name');
                            const colorInput = categoryContent.querySelector('#new-category-selected-color');
                            const newName = nameInput.value.trim();
                            const newColor = colorInput.value;
                            if (!newName || !groupId) return;
                            await addDoc(checklistCategoriesCollectionRef, { name: newName, groupId: groupId, color: newColor });
                            nameInput.value = '';
                        }
                        if (newColorDot) {
                            // Hebe die Auswahl visuell hervor
                            categoryContent.querySelectorAll('.new-color-dot').forEach(dot => dot.classList.remove('ring-2', 'ring-blue-500'));
                            newColorDot.classList.add('ring-2', 'ring-blue-500');
                            // Speichere die Farbauswahl
                            categoryContent.querySelector('#new-category-selected-color').value = newColorDot.dataset.color;
                        }
                        if (existingColorDot) {
                            // Speichere die geänderte Farbe für eine existierende Kategorie
                            const catId = existingColorDot.dataset.categoryId;
                            const newColor = existingColorDot.dataset.color;
                            await updateDoc(doc(checklistCategoriesCollectionRef, catId), { color: newColor });
                        }
                    });
                }

                if (groupSelector) {
                    renderCategoryEditor(groupSelector.value);
                }
            }

            function renderPermanentDeleteModal() {
                const container = document.getElementById('permanentDeleteListsContainer');
                container.innerHTML = ''; // Vorherigen Inhalt leeren

                const deletedLists = Object.values(DELETED_CHECKLISTS);

                if (deletedLists.length === 0) {
                    container.innerHTML = '<p class="text-sm text-center text-gray-500">Keine Listen im Papierkorb.</p>';
                    return;
                }

                deletedLists.forEach(list => {
                    const date = list.deletedAt?.toDate().toLocaleDateString('de-DE') || 'Unbekannt';
                    container.innerHTML += `
                <label class="flex items-start gap-3 p-2 cursor-pointer hover:bg-gray-100 rounded-md">
                    <input type="checkbox" data-list-id="${list.id}" class="h-5 w-5 rounded border-gray-400 text-indigo-600 focus:ring-indigo-500 mt-1 permanent-delete-cb">
                    <div>
                        <span class="font-semibold text-gray-800">${list.name}</span>
                        <p class="text-xs text-gray-500">Gelöscht von ${list.deletedBy} am ${date}</p>
                    </div>
                </label>
            `;
                });
            }

            function setupPermanentDeleteModalListeners() {
                const modal = document.getElementById('permanentDeleteModal');
                if (!modal || modal.dataset.listenerAttached === 'true') return;

                modal.addEventListener('click', async (e) => {
                    const selectAllCheckbox = document.getElementById('permanent-delete-select-all');

                    // Logik für "Alle auswählen"
                    if (e.target.id === 'permanent-delete-select-all') {
                        const isChecked = e.target.checked;
                        modal.querySelectorAll('.permanent-delete-cb').forEach(cb => cb.checked = isChecked);
                        return;
                    }

                    // Logik für "Abbrechen"-Button
                    if (e.target.id === 'cancelPermanentDeleteBtn') {
                        modal.style.display = 'none';
                        return;
                    }

                    // Logik für "Auswahl endgültig löschen"-Button
                    if (e.target.id === 'confirmPermanentDeleteBtn') {
                        const selectedCheckboxes = modal.querySelectorAll('.permanent-delete-cb:checked');
                        if (selectedCheckboxes.length === 0) {
                            alertUser("Bitte wählen Sie mindestens eine Liste zum Löschen aus.", "error");
                            return;
                        }

                        if (!confirm(`Möchten Sie die ausgewählten ${selectedCheckboxes.length} Liste(n) wirklich unwiderruflich löschen?`)) {
                            return;
                        }

                        try {
                            const batch = writeBatch(db);
                            selectedCheckboxes.forEach(cb => {
                                const listId = cb.dataset.listId;
                                batch.delete(doc(checklistsCollectionRef, listId));
                            });

                            await batch.commit();
                            await logAdminAction('cleared_trash_selection', `${selectedCheckboxes.length} Checklisten endgültig gelöscht.`);
                            alertUser(`${selectedCheckboxes.length} Liste(n) wurden endgültig gelöscht.`, "success");
                            modal.style.display = 'none';

                        } catch (error) {
                            console.error("Fehler beim Löschen der Auswahl:", error);
                            alertUser("Ein Fehler ist aufgetreten.", "error");
                        }
                    }
                });
                modal.dataset.listenerAttached = 'true';
            }

            function renderMainFunctionsAdminArea() {
                const tabsContainer = document.getElementById('main-functions-tabs');
                if (!tabsContainer) return;

                // --- START DER ÄNDERUNG ---
                const isAdmin = currentUser.role === 'ADMIN';
                const isSysAdmin = currentUser.role === 'SYSTEMADMIN';
                let effectiveAdminPerms = {};
                if (isAdmin) {
                    const adminUser = USERS[currentUser.mode];
                    if (adminUser) {
                        if (adminUser.permissionType === 'role' && adminUser.assignedAdminRoleId && ADMIN_ROLES[adminUser.assignedAdminRoleId]) {
                            effectiveAdminPerms = ADMIN_ROLES[adminUser.assignedAdminRoleId].permissions || {};
                        } else {
                            effectiveAdminPerms = adminUser.adminPermissions || {};
                        }
                    }
                }

                // Tabs basierend auf Rechten ein- oder ausblenden
                const pushTab = tabsContainer.querySelector('[data-target-card="card-main-push"]');
                const entranceTab = tabsContainer.querySelector('[data-target-card="card-main-entrance"]');
                const checklistTab = tabsContainer.querySelector('[data-target-card="card-main-checklist"]');

                if (pushTab) pushTab.style.display = isSysAdmin || effectiveAdminPerms.canUseMainPush ? 'block' : 'none';
                if (entranceTab) entranceTab.style.display = isSysAdmin || effectiveAdminPerms.canUseMainEntrance ? 'block' : 'none';
                if (checklistTab) checklistTab.style.display = isSysAdmin || effectiveAdminPerms.canUseMainChecklist ? 'block' : 'none';
                // --- ENDE DER ÄNDERUNG ---

                const deletePermanentlyBtn = document.getElementById('permanently-delete-items-btn');
                if (deletePermanentlyBtn && !deletePermanentlyBtn.dataset.listenerAttached) {
                    deletePermanentlyBtn.addEventListener('click', () => {
                        const deletedCount = Object.keys(DELETED_CHECKLISTS).length;
                        if (deletedCount === 0) {
                            alertUser("Der Papierkorb ist bereits leer.", "success");
                            return;
                        }
                        renderPermanentDeleteModal();
                        document.getElementById('permanentDeleteModal').style.display = 'flex';
                    });
                    deletePermanentlyBtn.dataset.listenerAttached = 'true';
                }

                if (tabsContainer.dataset.listenerAttached === 'true') return;

                tabsContainer.addEventListener('click', (e) => {
                    const clickedTab = e.target.closest('.settings-tab-btn');
                    if (!clickedTab) return;

                    const targetCardId = clickedTab.dataset.targetCard;
                    const prompt = document.getElementById('main-functions-prompt');
                    const isAlreadyActive = clickedTab.classList.contains('bg-white');

                    tabsContainer.querySelectorAll('.settings-tab-btn').forEach(tab => {
                        tab.classList.remove('bg-white', 'shadow', 'text-indigo-600');
                        tab.classList.add('text-gray-600');
                    });
                    document.querySelectorAll('.main-functions-card').forEach(card => card.classList.add('hidden'));

                    if (isAlreadyActive) {
                        prompt.classList.remove('hidden');
                    } else {
                        clickedTab.classList.add('bg-white', 'shadow', 'text-indigo-600');
                        clickedTab.classList.remove('text-gray-600');
                        const targetCard = document.getElementById(targetCardId);
                        if (targetCard) {
                            targetCard.classList.remove('hidden');
                            prompt.classList.add('hidden');
                        }
                    }
                });
                tabsContainer.dataset.listenerAttached = 'true';
            }


            function toggleAdminSection(section) {
                Object.keys(adminSectionsState).forEach(key => {
                    adminSectionsState[key] = key === section ? !adminSectionsState[key] : false;
                });

                adminRightsArea.style.display = adminSectionsState.adminRights ? 'flex' : 'none';
                passwordManagementArea.style.display = adminSectionsState.password ? 'flex' : 'none';
                userManagementArea.style.display = adminSectionsState.user ? 'flex' : 'none';
                roleManagementArea.style.display = adminSectionsState.role ? 'flex' : 'none';
                approvalProcessArea.style.display = adminSectionsState.approval ? 'flex' : 'none';
                protocolHistoryArea.style.display = adminSectionsState.protocol ? 'flex' : 'none';
                mainFunctionsArea.style.display = adminSectionsState.mainFunctions ? 'flex' : 'none';

                adminRightsToggleIcon.classList.toggle('rotate-180', adminSectionsState.adminRights);
                passwordToggleIcon.classList.toggle('rotate-180', adminSectionsState.password);
                userManagementToggleIcon.classList.toggle('rotate-180', adminSectionsState.user);
                roleToggleIcon.classList.toggle('rotate-180', adminSectionsState.role);
                approvalToggleIcon.classList.toggle('rotate-180', adminSectionsState.approval);
                protocolHistoryToggleIcon.classList.toggle('rotate-180', adminSectionsState.protocol);
                mainFunctionsToggleIcon.classList.toggle('rotate-180', adminSectionsState.mainFunctions);

                if (adminSectionsState.adminRights) renderAdminRightsManagement();
                if (adminSectionsState.password) renderUserKeyList();
                if (adminSectionsState.user) renderUserManagement();
                if (adminSectionsState.role) renderRoleManagement();
                if (adminSectionsState.approval) renderApprovalProcess();
                if (adminSectionsState.protocol) renderProtocolHistory();
                if (adminSectionsState.mainFunctions) renderMainFunctionsAdminArea();
            }

            function setupEventListeners() {
                appHeader.addEventListener('click', () => navigate('home'));

                // Central click handler for the main content area
                document.querySelector('.main-content').addEventListener('click', function (e) {

                    // --- Buttons on the home page ---
                    if (e.target.closest('#mainSettingsButton')) {
                        navigate('userSettings');
                        return;
                    }
                    if (e.target.closest('#mainAdminButton')) {
                        navigate('admin');
                        return;
                    }

                    const pushoverBtn = e.target.closest('#pushoverButton');
                    if (pushoverBtn) {
                        navigate('pushover');
                        return;
                    }
                    const notrufBtn = e.target.closest('#notrufSettingsButton');
                    if (notrufBtn) {
                        navigate('notrufSettings');
                        return;
                    }

                    // --- "Back" buttons ---
                    const backLink = e.target.closest('.back-link');
                    if (backLink && backLink.dataset.target) {
                        navigate(backLink.dataset.target);
                        return;
                    }

                    // --- Container button in settings ---
                    const templateBtn = e.target.closest('#show-template-modal-btn');
                    if (templateBtn) {
                        const listId = document.getElementById('checklist-settings-editor-switcher').value;
                        if (listId) {
                            openTemplateModal(listId);
                        } else {
                            alertUser("Bitte wählen Sie zuerst eine Liste aus, die Sie bearbeiten möchten.", "error");
                        }
                        return;
                    }
                });

                document.getElementById('entranceCard').addEventListener('click', () => navigate('entrance'));
                document.getElementById('cancelSelectionButton').addEventListener('click', () => userSelectionModal.style.display = 'none');
                document.getElementById('backToSelectionButton').addEventListener('click', () => { pinModal.style.display = 'none'; userSelectionModal.style.display = 'flex'; });

                document.getElementById('modalUserButtons').addEventListener('click', (e) => {
                    const button = e.target.closest('.select-user-button');
                    if (!button) return;
                    const user = USERS[button.dataset.user];
                    const pinRegularContent = pinModal.querySelector('#pinRegularContent');
                    const pinLockedContent = pinModal.querySelector('#pinLockedContent');
                    if (user && user.isActive) {
                        selectedUserForLogin = button.dataset.user;
                        userSelectionModal.style.display = 'none';
                        pinRegularContent.style.display = 'block';
                        pinLockedContent.style.display = 'none';
                        pinModalTitle.textContent = `Schlüssel für ${user.name}`;
                        adminPinInput.value = '';
                        pinError.style.display = 'none';
                        pinModal.style.display = 'flex';
                        setTimeout(() => adminPinInput.focus(), 100);
                    } else if (user && !user.isActive) {
                        userSelectionModal.style.display = 'none';
                        pinRegularContent.style.display = 'none';
                        pinLockedContent.style.display = 'block';
                        pinModal.style.display = 'flex';
                    }
                });

                document.getElementById('essensberechnungCard').addEventListener('click', () => {
                    // Hier könnten wir später eine Funktion zum Rendern der Daten aufrufen
                    // renderEssensberechnungView(); 
                    navigate('essensberechnung');
                });

                document.getElementById('essensberechnungCard').addEventListener('click', () => navigate('essensberechnung'));

                document.getElementById('closeLockedModalButton').addEventListener('click', () => {
                    pinModal.style.display = 'none';
                    userSelectionModal.style.display = 'flex';
                });

                const handleLogin = () => {
                    if (USERS[selectedUserForLogin]?.key === adminPinInput.value) {
                        pinModal.style.display = 'none';
                        adminPinInput.value = '';
                        localStorage.setItem(ADMIN_STORAGE_KEY, selectedUserForLogin);
                        checkCurrentUserValidity();
                        alertUser(`Erfolgreich als ${USERS[selectedUserForLogin].name} angemeldet!`, "success");
                    } else {
                        pinError.style.display = 'block';
                        adminPinInput.value = '';
                    }
                };

                document.getElementById('submitAdminKeyButton').addEventListener('click', handleLogin);
                adminPinInput.addEventListener('keydown', (e) => e.key === 'Enter' && handleLogin());

                adminRightsToggle.addEventListener('click', () => toggleAdminSection('adminRights'));
                roleSettingsToggle.addEventListener('click', () => toggleAdminSection('role'));
                passwordSettingsToggle.addEventListener('click', () => toggleAdminSection('password'));
                userManagementToggle.addEventListener('click', () => toggleAdminSection('user'));
                approvalProcessToggle.addEventListener('click', () => toggleAdminSection('approval'));
                protocolHistoryToggle.addEventListener('click', () => toggleAdminSection('protocol'));
                mainFunctionsToggle.addEventListener('click', () => toggleAdminSection('mainFunctions'));

                document.querySelectorAll('#entranceView .action-button').forEach(button => {
                    button.addEventListener('click', e => {
                        const buttonEl = e.currentTarget;
                        const delay = parseInt(buttonEl.dataset.delay, 10);
                        const buttonTextEl = buttonEl.querySelector('.button-text');
                        const originalText = buttonTextEl.textContent;
                        const sendRequest = async () => {
                            setButtonLoading(buttonEl, true);
                            buttonTextEl.style.display = 'none';
                            try {
                                await fetch(IFTTT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ value1: delay }) });
                                alertUser(`Befehl "Öffnen" gesendet!`, 'success');
                            } catch (error) {
                                alertUser('Fehler beim Senden des Befehls.', 'error');
                                console.error("IFTTT Error:", error);
                            } finally {
                                setButtonLoading(buttonEl, false);
                                buttonTextEl.textContent = originalText;
                                buttonTextEl.style.display = 'inline-block';
                            }
                        };
                        if (delay === 0) {
                            sendRequest();
                        } else {
                            buttonEl.disabled = true;
                            let countdown = delay;
                            buttonTextEl.textContent = countdown;
                            const interval = setInterval(() => {
                                countdown--;
                                if (countdown > 0) {
                                    buttonTextEl.textContent = countdown;
                                } else {
                                    clearInterval(interval);
                                    sendRequest();
                                }
                            }, 1000);
                        }
                    });
                });

                document.getElementById('sendDynamicPostButton').addEventListener('click', async (e) => {
                    const buttonEl = e.currentTarget;
                    const message = document.getElementById('pushoverMessage').value;
                    if (!message) return alertUser('Bitte Nachricht eingeben.', 'error');
                    setButtonLoading(buttonEl, true);
                    const formData = new FormData();
                    formData.append('token', PUSHOVER_TOKEN);
                    formData.append('user', RECIPIENT_KEYS[document.getElementById('pushoverRecipient').value]);
                    formData.append('title', document.getElementById('pushoverTitle').value);
                    formData.append('message', message);
                    try {
                        const response = await fetch('https://api.pushover.net/1/messages.json', { method: 'POST', body: formData });
                        const data = await response.json();
                        if (data.status !== 1) throw new Error(data.errors.join(', '));
                        alertUser('Nachricht gesendet!', 'success');
                        document.getElementById('pushoverMessage').value = '';
                    } catch (error) {
                        alertUser(`Fehler: ${error.message}`, 'error');
                    } finally {
                        setButtonLoading(buttonEl, false);
                    }
                });

                document.getElementById('userSettingsSaveKeyButton').addEventListener('click', async () => {
                    const newKeyInput = document.getElementById('userSettingsNewKeyInput');
                    const newKey = newKeyInput.value;
                    if (newKey.length < 4) return alertUser("Der Schlüssel muss mindestens 4 Zeichen lang sein.", "error");
                    await updateDoc(doc(usersCollectionRef, currentUser.mode), { key: newKey });
                    await logAdminAction('self_password_changed', `Eigenes Passwort geändert.`);
                    alertUser(`Ihr Schlüssel wurde erfolgreich aktualisiert!`, "success");
                    USERS[currentUser.mode].key = newKey;
                    document.getElementById('currentUserKeyDisplay').innerHTML = `<p class="text-lg">Dein aktuelles Passwort lautet: <strong class="font-bold">${newKey}</strong></p>`;
                    newKeyInput.value = '';
                });

                document.getElementById('currentChecklistCard').addEventListener('click', () => {
                    const defaultListId = adminSettings.defaultChecklistId;
                    renderChecklistView(defaultListId);
                    navigate('checklist');
                });

                document.getElementById('checklistSettingsCard').addEventListener('click', () => {
                    renderChecklistSettingsView();
                    navigate('checklistSettings');
                });

                const closeArchivedModalBtn = document.getElementById('closeArchivedListsModal');
                if (closeArchivedModalBtn) {
                    closeArchivedModalBtn.addEventListener('click', () => {
                        document.getElementById('archivedListsModal').style.display = 'none';
                    });
                }

                const archivedListsContainer = document.getElementById('archivedListsContainer');
                if (archivedListsContainer) {
                    archivedListsContainer.addEventListener('click', async (e) => {
                        const restoreBtn = e.target.closest('.restore-archived-btn');
                        const deleteBtn = e.target.closest('.delete-archived-btn');

                        if (restoreBtn) {
                            const listId = restoreBtn.dataset.listId;
                            await updateDoc(doc(checklistsCollectionRef, listId), { isArchived: false, archivedAt: null, archivedBy: null });
                            alertUser("Liste wurde aus dem Archiv wiederhergestellt.", "success");
                        }

                        if (deleteBtn) {
                            const listId = deleteBtn.dataset.listId;
                            const listName = ARCHIVED_CHECKLISTS[listId]?.name;
                            const confirmation = prompt(`Um die Liste "${listName}" endgültig in den Papierkorb zu verschieben, geben Sie bitte "LISTE LÖSCHEN" ein:`);
                            if (confirmation === 'LISTE LÖSCHEN') {
                                await updateDoc(doc(checklistsCollectionRef, listId), { isDeleted: true, isArchived: false, deletedAt: serverTimestamp(), deletedBy: currentUser.displayName });
                                alertUser(`Liste "${listName}" wurde in den Papierkorb verschoben.`, "success");
                            } else if (confirmation !== null) {
                                alertUser("Löschvorgang abgebrochen.", "error");
                            }
                        }
                    });
                }

                // START: Füge diesen Code in die setupEventListeners() Funktion ein
                // --- Event Listener für die Notruf-Einstellungsseite (Komplett korrigiert) ---
                const notrufView = document.getElementById('notrufSettingsView');
                if (notrufView && !notrufView.dataset.listenerAttached) {

                    // Listener für das Tab-Menü
                    const tabsContainer = notrufView.querySelector('#notruf-settings-tabs');
                    if (tabsContainer && !tabsContainer.dataset.listenerAttached) {
                        tabsContainer.addEventListener('click', (e) => {
                            const clickedTab = e.target.closest('.settings-tab-btn');
                            if (!clickedTab) return;

                            const targetCardId = clickedTab.dataset.targetCard;
                            const prompt = document.getElementById('notruf-prompt');
                            const isAlreadyActive = clickedTab.classList.contains('bg-white');

                            // 1. Alles zurücksetzen
                            tabsContainer.querySelectorAll('.settings-tab-btn').forEach(tab => {
                                tab.classList.remove('bg-white', 'shadow', 'text-indigo-600');
                                tab.classList.add('text-gray-600');
                            });
                            notrufView.querySelectorAll('.notruf-settings-card').forEach(card => card.classList.add('hidden'));

                            if (isAlreadyActive) {
                                prompt.style.display = 'block';
                            } else {
                                prompt.style.display = 'none';
                                clickedTab.classList.add('bg-white', 'shadow', 'text-indigo-600');
                                clickedTab.classList.remove('text-gray-600');
                                const targetCard = document.getElementById(targetCardId);
                                if (targetCard) {
                                    targetCard.classList.remove('hidden');
                                    if (targetCardId === 'card-flic-notruf') {
                                        document.getElementById('modeEditorArea').classList.add('hidden');
                                        document.querySelector('#card-flic-notruf .card').classList.remove('hidden');
                                        populateModeSelector();
                                        displaySelectedModeInfo();
                                    }
                                }
                            }
                        });
                        tabsContainer.dataset.listenerAttached = 'true';
                    }

                    // Listener für den Flic-Button Tab-Inhalt (Auswahlbereich)
                    // Listener für den Flic-Button Tab-Inhalt (Auswahl, Speichern, Editor öffnen)
                    // === ERSETZE den gesamten 'flicCard' Listener-Block ===
                    // Listener für den Flic-Button Tab-Inhalt (Zuweisungsbereich + Editor-Logik)
                    // === START: Ersetzter flicCard Listener ===
                    const flicCard = document.getElementById('card-flic-notruf');
                    if (flicCard) {

                        // --- Listener für den EINEN Editor-Dropdown ---
                        const editorSelector = document.getElementById('flic-editor-selector');
                        if (editorSelector && !editorSelector.dataset.listenerAttached) {
                            editorSelector.addEventListener('change', (e) => {
                                if (!activeFlicEditorKlickTyp) return; // Nur wenn eine Box aktiv ist

                                // 1. Hole die ID des *neu ausgewählten* Modus
                                const newModeId = e.target.value ? parseInt(e.target.value) : null;
                                const modes = notrufSettings.modes || [];
                                const selectedMode = modes.find(m => m.id === newModeId);

                                // 2. Aktualisiere *nur* die blaue Details-Box
                                const detailsDisplay = document.getElementById('flic-editor-details');
                                if (selectedMode) {
                                    const config = selectedMode.config || {};
                                    const recipients = (config.userKeys || []).map(u => u.name).join(', ') || 'Niemand';
                                    detailsDisplay.innerHTML = `
                    <strong class="block">Empfänger:</strong>
                    <span class="block pl-2 mb-1">${recipients}</span>
                    <strong class="block">Nachricht:</strong>
                    <span class="block pl-2 mb-1">"${config.message || 'Keine'}"</span>
                    <strong class="block">Prio:\u00A0${config.priority || 'N/A'}, Retry:\u00A0${config.retry || 'N/A'}s</strong>
                `;
                                } else {
                                    detailsDisplay.innerHTML = 'Kein Modus zugewiesen.';
                                }

                                // 3. NICHT 'notrufSettings' oder 'updateFlicColumnDisplays()' aufrufen.
                                // Die Hauptanzeige wird erst nach Klick auf "Speichern" aktualisiert.
                            });
                            editorSelector.dataset.listenerAttached = 'true';
                        }


                        // --- Haupt-Click-Listener für die gesamte Karte ---
                        flicCard.addEventListener('click', (e) => {

                            const editorContainer = document.getElementById('flic-details-editor-container');

                            // --- Logik für Klick auf eine der 3 Spalten ---
                            const clickedColumn = e.target.closest('.flic-column-block');
                            if (clickedColumn) {
                                const klickTyp = clickedColumn.dataset.klickTyp;

                                // Alle Spalten-Hervorhebungen entfernen
                                document.querySelectorAll('.flic-column-block').forEach(col => {
                                    col.classList.remove('bg-indigo-100', 'border-indigo-400');
                                    col.classList.add('bg-gray-50', 'border-gray-200');
                                });

                                if (klickTyp === activeFlicEditorKlickTyp) {
                                    // Fall 1: Aktive Spalte erneut geklickt -> Schließen
                                    editorContainer.classList.add('hidden');
                                    activeFlicEditorKlickTyp = null;
                                } else {
                                    // Fall 2: Neue Spalte geklickt -> Öffnen/Wechseln
                                    activeFlicEditorKlickTyp = klickTyp;
                                    // WICHTIG: updateFlicEditorBox() füllt jetzt den Editor mit den
                                    // *aktuell gespeicherten* Daten, nicht mit den zwischengespeicherten.
                                    updateFlicEditorBox(klickTyp);
                                    editorContainer.classList.remove('hidden');
                                    // Geklickte Spalte hervorheben
                                    clickedColumn.classList.add('bg-indigo-100', 'border-indigo-400');
                                    clickedColumn.classList.remove('bg-gray-50', 'border-gray-200');
                                }
                                return; // Klick verarbeitet
                            }

                            // --- Logik für "Zuweisungen Speichern" Button ---
                            const saveBtn = e.target.closest('#saveFlicAssignmentsBtn');
                            if (saveBtn) {
                                setButtonLoading(saveBtn, true);

                                // 1. Holen, WELCHER Klick-Typ gerade bearbeitet wird
                                if (!activeFlicEditorKlickTyp) {
                                    setButtonLoading(saveBtn, false);
                                    return; // Sollte nicht passieren, aber sicher ist sicher
                                }

                                // 2. Holen, WELCHER Modus im Dropdown ausgewählt ist
                                const selector = document.getElementById('flic-editor-selector');
                                const newModeId = selector.value ? parseInt(selector.value) : null;

                                // 3. JETZT das Haupt-Datenobjekt aktualisieren
                                if (!notrufSettings.flicAssignments) notrufSettings.flicAssignments = {};
                                notrufSettings.flicAssignments[activeFlicEditorKlickTyp] = newModeId;

                                setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                    alertUser('Flic-Zuweisungen erfolgreich gespeichert!', 'success');

                                    // 4. JETZT die 3-Spalten-Anzeige aktualisieren
                                    updateFlicColumnDisplays();

                                    // 5. Editor schließen
                                    document.getElementById('flic-details-editor-container').classList.add('hidden');
                                    activeFlicEditorKlickTyp = null;
                                    document.querySelectorAll('.flic-column-block').forEach(col => {
                                        col.classList.remove('bg-indigo-100', 'border-indigo-400');
                                        col.classList.add('bg-gray-50', 'border-gray-200');
                                    });
                                }).catch(err => {
                                    console.error("Fehler beim Speichern der Flic-Zuweisungen:", err);
                                    alertUser('Fehler beim Speichern der Zuweisungen.', 'error');
                                }).finally(() => {
                                    setButtonLoading(saveBtn, false);
                                });
                                return; // Klick verarbeitet
                            }

                            // --- Listener für den "Modi Verwalten" Editor (bleibt gleich) ---
                            const editorArea = document.getElementById('modeEditorArea');
                            // KORREKTUR für Request 3: 'assignmentAreaContainer' ist die Karte, die wir verstecken wollen
                            const assignmentAreaContainer = flicCard.querySelector('.card');

                            // "Modi Verwalten" Button -> Zeigt den Modus-Editor an
                            if (e.target.closest('#notrufOpenModeEditor')) {
                                // HIER IST DIE LOGIK FÜR REQUEST 3:
                                if (assignmentAreaContainer) assignmentAreaContainer.classList.add('hidden'); // Versteckt die 3-Spalten-Karte

                                if (editorArea) editorArea.classList.remove('hidden');

                                // WICHTIG: Verstecke die Zuweisungs-Details-Box, falls sie offen war
                                editorContainer.classList.add('hidden');
                                activeFlicEditorKlickTyp = null;
                                document.querySelectorAll('.flic-column-block').forEach(col => {
                                    col.classList.remove('bg-indigo-100', 'border-indigo-400');
                                    col.classList.add('bg-gray-50', 'border-gray-200');
                                });

                                renderModeEditorList();
                                document.getElementById('modeConfigFormContainer').classList.add('hidden');
                                return;
                            }

                            // Nur reagieren, wenn Klick im Editor war
                            if (editorArea && editorArea.contains(e.target)) {
                                // "Editor schließen" Button (X)
                                if (e.target.closest('#notrufCloseModeEditor')) {
                                    editorArea.classList.add('hidden');
                                    // HIER IST DIE LOGIK FÜR REQUEST 3 (Rückgängig):
                                    if (assignmentAreaContainer) assignmentAreaContainer.classList.remove('hidden'); // Zeigt die 3-Spalten-Karte wieder an
                                    document.getElementById('modeConfigFormContainer').classList.add('hidden');
                                }
                                // "Neuen Modus anlegen" Button (+)
                                if (e.target.closest('#notrufAddNewModeButton')) {
                                    openModeConfigForm();
                                }
                                // "Bearbeiten" Knopf (Stift-Symbol) in der Modusliste
                                const editBtn = e.target.closest('.edit-mode-btn');
                                if (editBtn) {
                                    openModeConfigForm(editBtn.dataset.modeId);
                                }
                                // "Löschen" Knopf (Mülleimer-Symbol) in der Modusliste
                                const deleteBtn = e.target.closest('.delete-mode-btn');
                                if (deleteBtn) {
                                    const modeIdToDelete = parseInt(deleteBtn.dataset.modeId);
                                    const modeToDelete = notrufSettings.modes.find(m => m.id === modeIdToDelete);
                                    if (!modeToDelete) return;
                                    const confirmation = prompt(`Um den Modus "${modeToDelete.title}" unwiderruflich zu löschen, geben Sie bitte "MODI LÖSCHEN" ein:`);
                                    if (confirmation === 'MODI LÖSCHEN') {
                                        notrufSettings.modes = notrufSettings.modes.filter(m => m.id !== modeIdToDelete);

                                        if (notrufSettings.flicAssignments) {
                                            for (const klick in notrufSettings.flicAssignments) {
                                                if (notrufSettings.flicAssignments[klick] === modeIdToDelete) {
                                                    notrufSettings.flicAssignments[klick] = null;
                                                }
                                            }
                                        }
                                        setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                            alertUser('Modus gelöscht!', 'success');
                                            renderModeEditorList();
                                            populateFlicAssignmentSelectors(); // Editor-Dropdown aktualisieren
                                            updateFlicColumnDisplays(); // Spalten-Anzeige aktualisieren
                                            // Falls der gelöschte Modus gerade im Editor-Fenster angezeigt wurde:
                                            if (activeFlicEditorKlickTyp) {
                                                updateFlicEditorBox(activeFlicEditorKlickTyp);
                                            }
                                        }).catch(err => alertUser('Fehler beim Löschen.', 'error'));
                                    } else if (confirmation !== null) {
                                        alertUser('Löschvorgang abgebrochen.', 'info');
                                    }
                                }
                                // "Abbrechen" im Konfigurationsformular
                                if (e.target.closest('#notrufCancelEditModeButton')) {
                                    document.getElementById('modeConfigFormContainer').classList.add('hidden');
                                }
                            } // Ende von if (editorArea && editorArea.contains(e.target))
                        }); // Ende des Haupt-Click-Listeners für flicCard
                    } // Ende von if (flicCard)
                    // === ENDE: Ersetzter flicCard Listener ===

                    // === Bis hier ersetzen ===
                }

                // Listener für den Modus-Editor-Bereich (wo Modi gelistet, bearbeitet, gelöscht werden)

                // Listener für das eigentliche Konfigurationsformular (innerhalb des Editors)
                const configArea = document.getElementById('notrufConfigArea');
                if (configArea) {
                    configArea.addEventListener('click', (e) => {
                        // Standard-Token setzen
                        if (e.target.closest('#notrufSetDefaultToken')) {
                            document.getElementById('notrufApiToken').value = 'aeqwab5g325hvmk33gtq7s3bz8z7x6';
                        }
                        // Kontaktbuch öffnen
                        if (e.target.closest('#notrufOpenContactBook')) {
                            renderContactBook();
                            document.getElementById('contactBookModal').style.display = 'flex';
                        }
                        // Modus speichern (Neuer oder Bearbeiteter)
                        // Modus speichern (Neuer oder Bearbeiteter)
                        // Modus speichern (Neuer oder Bearbeiteter)
                        // Modus speichern (Neuer oder Bearbeiteter)
                        if (e.target.closest('#notrufSaveModeButton')) {
                            const editingId = document.getElementById('editingModeId').value ? parseInt(document.getElementById('editingModeId').value) : null;
                            const title = document.getElementById('notrufModeTitle').value.trim(); // Modus-Titel
                            const description = document.getElementById('notrufModeDescInput').value.trim();
                            const pushoverTitle = document.getElementById('notrufTitle').value.trim(); // Pushover-Titel

                            if (!title || !description) {
                                alertUser('Bitte Titel und Beschreibung für den Modus eingeben.', 'error');
                                return;
                            }
                            if (!tempSelectedApiTokenId) {
                                alertUser('Bitte einen API-Token auswählen.', 'error');
                                return;
                            }

                            // Empfänger (User Keys) sammeln
                            const selectedUserKeys = [];
                            document.querySelectorAll('#notrufUserKeyDisplay .contact-badge').forEach(badge => {
                                const contactId = parseInt(badge.dataset.contactId);
                                const contact = (notrufSettings.contacts || []).find(c => c.id === contactId);
                                if (contact) {
                                    selectedUserKeys.push({ id: contact.id, name: contact.name, key: contact.key });
                                }
                            });

                            // Priorität auslesen
                            const selectedPrioButton = document.querySelector('.priority-btn.bg-indigo-600');
                            const priority = selectedPrioButton ? parseInt(selectedPrioButton.dataset.priority) : 0;

                            // NEU: Retry/Expire auslesen vom Input-Feld
                            const retryDeaktiviert = document.getElementById('retryDeaktiviert').checked;
                            let retryValue = 0;
                            let expireValue = 0; // Standardmäßig 0

                            if (!retryDeaktiviert) {
                                const inputRetry = parseInt(document.getElementById('retrySecondsInput').value);
                                if (isNaN(inputRetry) || inputRetry < 30 || inputRetry > 10800) {
                                    alertUser('Retry-Intervall muss zwischen 30 und 10800 Sekunden liegen.', 'error');
                                    return;
                                }
                                retryValue = inputRetry;
                                // Nur wenn Retry aktiv ist, Expire auf Maximum setzen
                                expireValue = 10800;
                            }
                            // -- Ende NEU --

                            // Validierung für Priority 2
                            if (priority === 2 && retryValue === 0) { // Prüft jetzt retryValue
                                alertUser('Notfall-Priorität (2) erfordert ein aktiviertes Retry/Expire-Intervall (mind. 30 Sekunden).', 'error');
                                return;
                            }

                            // NEU: Sound-Code ermitteln
                            let soundCodeToSend = null; // Standard Pushover Sound
                            if (tempSelectedSoundId !== null) {
                                const sound = (notrufSettings.sounds || []).find(s => s.id === tempSelectedSoundId);
                                if (sound) {
                                    soundCodeToSend = sound.code; // Nimm den Pushover-Code
                                }
                            }
                            // -- Ende NEU --

                            // Config-Objekt zusammenbauen (mit retry, expire, sound)
                            const configData = {
                                selectedApiTokenId: tempSelectedApiTokenId,
                                userKeys: selectedUserKeys,
                                title: pushoverTitle,
                                message: document.getElementById('notrufMessage').value.trim(),
                                selectedSoundId: tempSelectedSoundId, // ID speichern für die Anzeige
                                sound: soundCodeToSend, // Den Code für die API speichern
                                priority: priority,
                                retry: retryValue,    // Korrekter API-Parameter 'retry'
                                expire: expireValue   // Korrekter API-Parameter 'expire'
                            };

                            if (!notrufSettings.modes) notrufSettings.modes = [];

                            if (editingId) {
                                // Bearbeiten
                                const modeIndex = notrufSettings.modes.findIndex(m => m.id === editingId);
                                if (modeIndex > -1) {
                                    notrufSettings.modes[modeIndex].title = title;
                                    notrufSettings.modes[modeIndex].description = description;
                                    notrufSettings.modes[modeIndex].config = configData;
                                }
                            } else {
                                // Neu anlegen
                                notrufSettings.modes.push({
                                    id: Date.now(),
                                    title: title,
                                    description: description,
                                    config: configData
                                });
                            }

                            setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                alertUser('Modus gespeichert!', 'success');
                                document.getElementById('modeConfigFormContainer').classList.add('hidden');
                                renderModeEditorList();
                                populateFlicAssignmentSelectors();
                                updateFlicColumnDisplays();
                                // Globale Temp-Variablen zurücksetzen
                                tempSelectedApiTokenId = null;
                                tempSelectedSoundId = null;
                            }).catch(err => {
                                console.error("Error saving mode:", err);
                                alertUser('Fehler beim Speichern des Modus.', 'error');
                            });
                        }
                    });
                }

                // Listener für das Kontaktbuch-Modal (Bleibt gleich)
                const contactModal = document.getElementById('contactBookModal');
                if (contactModal && !contactModal.dataset.listenerAttached) {
                    contactModal.addEventListener('click', (e) => {
                        // Modal schließen
                        if (e.target.closest('#contactBookCloseButton')) {
                            contactModal.style.display = 'none';
                        }
                        // Kontakt hinzufügen
                        if (e.target.closest('#contactAddButton')) {
                            const type = document.getElementById('contactIsGroup').value;
                            const name = document.getElementById('contactName').value.trim();
                            const key = document.getElementById('contactUserKey').value.trim();
                            if (type && name && key) {
                                if (!notrufSettings.contacts) notrufSettings.contacts = [];
                                notrufSettings.contacts.push({ id: Date.now(), type, name, key });
                                setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                    renderContactBook();
                                    document.getElementById('contactIsGroup').value = 'User';
                                    document.getElementById('contactName').value = '';
                                    document.getElementById('contactUserKey').value = '';
                                }).catch(err => alertUser('Fehler beim Speichern des Kontakts.', 'error'));
                            } else {
                                alertUser('Bitte alle Felder für den Kontakt ausfüllen.', 'error');
                            }
                        }
                        // Kontakt löschen
                        if (e.target.closest('.delete-contact-btn')) {
                            const contactId = parseInt(e.target.closest('.delete-contact-btn').dataset.contactId);
                            if (confirm('Möchten Sie diesen Kontakt wirklich löschen?')) {
                                notrufSettings.contacts = notrufSettings.contacts.filter(c => c.id !== contactId);
                                if (notrufSettings.modes) {
                                    notrufSettings.modes.forEach(mode => {
                                        if (mode.config && mode.config.userKeys) {
                                            mode.config.userKeys = mode.config.userKeys.filter(uk => uk.id !== contactId);
                                        }
                                    });
                                }
                                const badgeToRemove = document.querySelector(`#notrufUserKeyDisplay .contact-badge[data-contact-id="${contactId}"]`);
                                if (badgeToRemove) badgeToRemove.remove();
                                setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                    renderContactBook();
                                }).catch(err => alertUser('Fehler beim Löschen des Kontakts.', 'error'));
                            }
                        }
                        // Auswahl übernehmen
                        if (e.target.closest('#contactBookApplyButton')) {
                            const displayArea = document.getElementById('notrufUserKeyDisplay');
                            displayArea.innerHTML = '';
                            contactModal.querySelectorAll('.contact-checkbox:checked').forEach(cb => {
                                const contact = (notrufSettings.contacts || []).find(c => c.id == cb.value);
                                if (contact) {
                                    displayArea.innerHTML += `<span class="contact-badge inline-flex items-center gap-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full" data-contact-id="${contact.id}">${contact.name}</span>`;
                                }
                            });
                            contactModal.style.display = 'none';
                        }
                    });
                    contactModal.dataset.listenerAttached = 'true';
                }

                notrufView.dataset.listenerAttached = 'true';

                const apiTokenModal = document.getElementById('apiTokenBookModal');
                if (apiTokenModal && !apiTokenModal.dataset.listenerAttached) {
                    apiTokenModal.addEventListener('click', (e) => {
                        // Modal schließen
                        if (e.target.closest('#apiTokenBookCloseButton')) {
                            apiTokenModal.style.display = 'none';
                        }
                        // Token hinzufügen
                        if (e.target.closest('#apiTokenAddButton')) {
                            const name = document.getElementById('apiTokenName').value.trim();
                            const key = document.getElementById('apiTokenKey').value.trim();
                            if (name && key) {
                                if (!notrufSettings.apiTokens) notrufSettings.apiTokens = [];
                                notrufSettings.apiTokens.push({ id: Date.now(), name, key });
                                setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                    renderApiTokenBook();
                                    document.getElementById('apiTokenName').value = '';
                                    document.getElementById('apiTokenKey').value = '';
                                }).catch(err => alertUser('Fehler beim Speichern des Tokens.', 'error'));
                            } else {
                                alertUser('Bitte Bezeichnung und Key für den Token ausfüllen.', 'error');
                            }
                        }
                        // Token löschen
                        if (e.target.closest('.delete-api-token-btn')) {
                            const tokenId = parseInt(e.target.closest('.delete-api-token-btn').dataset.tokenId);
                            if (confirm('Möchten Sie diesen API-Token wirklich löschen?')) {
                                notrufSettings.apiTokens = notrufSettings.apiTokens.filter(t => t.id !== tokenId);
                                // Prüfen, ob der gelöschte Token in Modi verwendet wird und ggf. entfernen
                                if (notrufSettings.modes) {
                                    notrufSettings.modes.forEach(mode => {
                                        if (mode.config && mode.config.selectedApiTokenId === tokenId) {
                                            mode.config.selectedApiTokenId = null;
                                        }
                                    });
                                }
                                // Ggf. im Formular zurücksetzen
                                if (tempSelectedApiTokenId === tokenId) {
                                    tempSelectedApiTokenId = null;
                                    document.getElementById('notrufApiTokenDisplay').innerHTML = '<span class="text-gray-400 italic">Kein Token ausgewählt</span>';
                                }

                                setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                    renderApiTokenBook();
                                }).catch(err => alertUser('Fehler beim Löschen des Tokens.', 'error'));
                            }
                        }
                        // Auswahl übernehmen
                        if (e.target.closest('#apiTokenBookApplyButton')) {
                            const selectedRadio = apiTokenModal.querySelector('.api-token-radio:checked');
                            const displayArea = document.getElementById('notrufApiTokenDisplay');
                            if (selectedRadio) {
                                const tokenId = parseInt(selectedRadio.value);
                                const token = (notrufSettings.apiTokens || []).find(t => t.id === tokenId);
                                if (token) {
                                    tempSelectedApiTokenId = tokenId; // Temporär speichern für das Formular
                                    displayArea.innerHTML = `<span class="api-token-badge inline-flex items-center gap-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full" data-token-id="${token.id}">${token.name}</span>`;
                                }
                            } else {
                                tempSelectedApiTokenId = null;
                                displayArea.innerHTML = '<span class="text-gray-400 italic">Kein Token ausgewählt</span>';
                            }
                            apiTokenModal.style.display = 'none';
                        }
                    });
                    apiTokenModal.dataset.listenerAttached = 'true';
                }

                // --- Event Listener für das Sound Buch Modal ---
                const soundModal = document.getElementById('soundBookModal');
                if (soundModal && !soundModal.dataset.listenerAttached) {
                    // Checkbox für Custom Name
                    const useCustomNameCheckbox = soundModal.querySelector('#soundUseCustomName');
                    const customNameInput = soundModal.querySelector('#soundCustomName');
                    if (useCustomNameCheckbox && customNameInput) {
                        useCustomNameCheckbox.addEventListener('change', (e) => {
                            customNameInput.classList.toggle('hidden', !e.target.checked);
                            if (!e.target.checked) customNameInput.value = ''; // Leeren, wenn versteckt
                        });
                    }

                    soundModal.addEventListener('click', (e) => {
                        // Modal schließen
                        if (e.target.closest('#soundBookCloseButton')) {
                            soundModal.style.display = 'none';
                        }
                        // Sound hinzufügen
                        if (e.target.closest('#soundAddButton')) {
                            const code = document.getElementById('soundCode').value.trim();
                            const useCustom = document.getElementById('soundUseCustomName').checked;
                            const customName = document.getElementById('soundCustomName').value.trim();
                            if (code && (!useCustom || (useCustom && customName))) {
                                if (!notrufSettings.sounds) notrufSettings.sounds = [];
                                notrufSettings.sounds.push({
                                    id: Date.now(),
                                    code: code,
                                    useCustomName: useCustom,
                                    customName: useCustom ? customName : null
                                });
                                setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                    renderSoundBook();
                                    document.getElementById('soundCode').value = '';
                                    document.getElementById('soundUseCustomName').checked = false;
                                    document.getElementById('soundCustomName').value = '';
                                    document.getElementById('soundCustomName').classList.add('hidden');
                                }).catch(err => alertUser('Fehler beim Speichern des Sounds.', 'error'));
                            } else {
                                alertUser('Bitte Soundcode und ggf. eigenen Namen ausfüllen.', 'error');
                            }
                        }
                        // Sound löschen
                        if (e.target.closest('.delete-sound-btn')) {
                            const soundId = parseInt(e.target.closest('.delete-sound-btn').dataset.soundId);
                            if (confirm('Möchten Sie diesen Sound wirklich löschen?')) {
                                notrufSettings.sounds = notrufSettings.sounds.filter(s => s.id !== soundId);
                                // Prüfen, ob der gelöschte Sound in Modi verwendet wird und ggf. entfernen
                                if (notrufSettings.modes) {
                                    notrufSettings.modes.forEach(mode => {
                                        if (mode.config && mode.config.selectedSoundId === soundId) {
                                            mode.config.selectedSoundId = null;
                                        }
                                    });
                                }
                                // Ggf. im Formular zurücksetzen
                                if (tempSelectedSoundId === soundId) {
                                    tempSelectedSoundId = null;
                                    document.getElementById('notrufSoundDisplay').innerHTML = '<span class="text-gray-400 italic">Standard (pushover)</span>';
                                }

                                setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                    renderSoundBook();
                                }).catch(err => alertUser('Fehler beim Löschen des Sounds.', 'error'));
                            }
                        }
                        // Auswahl übernehmen
                        if (e.target.closest('#soundBookApplyButton')) {
                            const selectedRadio = soundModal.querySelector('.sound-radio:checked');
                            const displayArea = document.getElementById('notrufSoundDisplay');

                            if (selectedRadio && selectedRadio.value !== 'default') { // Prüfe, ob NICHT Standard gewählt wurde
                                const soundId = parseInt(selectedRadio.value);
                                const sound = (notrufSettings.sounds || []).find(s => s.id === soundId);
                                if (sound) {
                                    tempSelectedSoundId = soundId; // Temporär speichern
                                    const displayName = sound.useCustomName && sound.customName ? sound.customName : sound.code;
                                    displayArea.innerHTML = `<span class="sound-badge inline-flex items-center gap-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full" data-sound-id="${sound.id}">${displayName}</span>`;
                                }
                            } else {
                                // Standard wurde gewählt (oder nichts)
                                tempSelectedSoundId = null; // Setze auf null für Standard
                                displayArea.innerHTML = '<span class="text-gray-400 italic">Standard (pushover)</span>';
                            }
                            soundModal.style.display = 'none';
                        }
                    });
                    soundModal.dataset.listenerAttached = 'true';
                }

                // --- Listener für die neuen "Buch öffnen"-Buttons im Formular ---
                // --- Listener für die neuen "Buch öffnen"-Buttons im Formular ---
                // const configArea = ... // Diese Zeile sollte schon gelöscht sein!
                if (configArea && !configArea.dataset.extraListenersAttached) { // Verwendet die Variable von weiter oben
                    configArea.addEventListener('click', (e) => {
                        // API Token Buch öffnen
                        if (e.target.closest('#notrufOpenApiTokenBook')) {
                            renderApiTokenBook();
                            document.getElementById('apiTokenBookModal').style.display = 'flex';
                        }
                        // Sound Buch öffnen
                        if (e.target.closest('#notrufOpenSoundBook')) {
                            renderSoundBook();
                            document.getElementById('soundBookModal').style.display = 'flex';
                        }
                        // Priorität Button Klick
                        const prioBtn = e.target.closest('.priority-btn');
                        if (prioBtn) {
                            document.querySelectorAll('.priority-btn').forEach(btn => btn.classList.remove('bg-indigo-600', 'text-white'));
                            prioBtn.classList.add('bg-indigo-600', 'text-white');
                        }
                    });

                    // --- NEU: Listener für Retry Checkbox ---
                    const retryCheckbox = document.getElementById('retryDeaktiviert');
                    const retrySecondsInput = document.getElementById('retrySecondsInput');

                    if (retryCheckbox && retrySecondsInput) {
                        retryCheckbox.addEventListener('change', (e) => {
                            const isDisabled = e.target.checked;
                            retrySecondsInput.disabled = isDisabled;
                            if (isDisabled) {
                                // Optional: Wert zurücksetzen oder auf Minimum setzen
                                // retrySecondsInput.value = 30;
                            } else {
                                // Sicherstellen, dass ein gültiger Wert drin steht, wenn aktiviert wird
                                if (parseInt(retrySecondsInput.value) < 30) {
                                    retrySecondsInput.value = 30;
                                }
                            }
                        });
                    }
                    // --- Ende NEU ---

                    configArea.dataset.extraListenersAttached = 'true';
                }
            }


            // Füge DIESEN BLOCK in den bestehenden 'notrufView'-Listener in setupEventListeners() ein:

            const tabsContainer = notrufView.querySelector('#notruf-settings-tabs');
            if (tabsContainer && !tabsContainer.dataset.listenerAttached) {
                tabsContainer.addEventListener('click', (e) => {
                    const clickedTab = e.target.closest('.settings-tab-btn');
                    if (!clickedTab) return;

                    const targetCardId = clickedTab.dataset.targetCard;
                    const prompt = document.getElementById('notruf-prompt');
                    const isAlreadyActive = clickedTab.classList.contains('bg-white');

                    // 1. Alles zurücksetzen
                    tabsContainer.querySelectorAll('.settings-tab-btn').forEach(tab => {
                        tab.classList.remove('bg-white', 'shadow', 'text-indigo-600');
                        tab.classList.add('text-gray-600');
                    });
                    notrufView.querySelectorAll('.notruf-settings-card').forEach(card => card.classList.add('hidden'));

                    if (isAlreadyActive) {
                        // 2. Wenn aktiver Tab geklickt wurde: Prompt anzeigen
                        prompt.style.display = 'block';
                    } else {
                        // 3. Wenn neuer Tab geklickt wurde: Prompt verbergen, Tab anzeigen
                        prompt.style.display = 'none';
                        clickedTab.classList.add('bg-white', 'shadow', 'text-indigo-600');
                        clickedTab.classList.remove('text-gray-600');
                        const targetCard = document.getElementById(targetCardId);
                        if (targetCard) {
                            targetCard.classList.remove('hidden');
                        }
                    }
                });
                tabsContainer.dataset.listenerAttached = 'true';
            }

            // --- Event Listener für das Kontaktbuch-Modal ---
            const contactModal = document.getElementById('contactBookModal');
            if (contactModal && !contactModal.dataset.listenerAttached) {
                contactModal.addEventListener('click', (e) => {
                    // Modal schließen
                    if (e.target.closest('#contactBookCloseButton')) {
                        contactModal.style.display = 'none';
                    }
                    // Kontakt hinzufügen
                    // NEUER CODE
                    if (e.target.closest('#contactAddButton')) {
                        const type = document.getElementById('contactIsGroup').value; // .trim() ist nicht mehr nötig
                        const name = document.getElementById('contactName').value.trim();
                        const key = document.getElementById('contactUserKey').value.trim();
                        if (type && name && key) {
                            if (!notrufSettings.contacts) notrufSettings.contacts = []; // Initialisieren, falls leer
                            notrufSettings.contacts.push({ id: Date.now(), type, name, key });

                            // Das ganze Objekt in Firebase speichern
                            setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                renderContactBook();
                                // Felder leeren (hier ist die Änderung)
                                document.getElementById('contactIsGroup').value = 'User'; // Setzt auf Standardwert zurück
                                document.getElementById('contactName').value = '';
                                document.getElementById('contactUserKey').value = '';
                            }).catch(err => alertUser('Fehler beim Speichern des Kontakts.', 'error'));
                        } else {
                            alertUser('Bitte alle Felder für den Kontakt ausfüllen.', 'error');
                        }
                    }
                    // Kontakt löschen
                    if (e.target.closest('.delete-contact-btn')) {
                        const contactId = e.target.closest('.delete-contact-btn').dataset.contactId;
                        if (confirm('Möchten Sie diesen Kontakt wirklich löschen?')) {
                            notrufSettings.contacts = notrufSettings.contacts.filter(c => c.id != contactId);

                            // Das ganze Objekt in Firebase speichern
                            setDoc(notrufSettingsDocRef, notrufSettings).then(() => {
                                renderContactBook();
                            }).catch(err => alertUser('Fehler beim Löschen des Kontakts.', 'error'));
                        }
                    }
                    // Auswahl übernehmen und Modal schließen
                    if (e.target.closest('#contactBookApplyButton')) {
                        const displayArea = document.getElementById('notrufUserKeyDisplay');
                        displayArea.innerHTML = '';
                        const selectedContacts = [];
                        contactModal.querySelectorAll('.contact-checkbox:checked').forEach(cb => {
                            const contact = (notrufSettings.contacts || []).find(c => c.id == cb.value);
                            if (contact) {
                                displayArea.innerHTML += `<span class="contact-badge inline-flex items-center gap-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full" data-contact-id="${contact.id}">${contact.name}</span>`;
                            }
                        });
                        contactModal.style.display = 'none';
                    }
                });
                contactModal.dataset.listenerAttached = 'true';
            }


            const closeDeletedModalBtn = document.getElementById('closeDeletedListsModal');
            if (closeDeletedModalBtn) {
                closeDeletedModalBtn.addEventListener('click', () => {
                    document.getElementById('deletedListsModal').style.display = 'none';
                });
            }

            const deletedListsContainer = document.getElementById('deletedListsContainer');
            if (deletedListsContainer) {
                deletedListsContainer.addEventListener('click', async (e) => {
                    const restoreBtn = e.target.closest('.restore-checklist-btn');
                    if (restoreBtn) {
                        const listId = restoreBtn.dataset.listId;
                        await updateDoc(doc(checklistsCollectionRef, listId), { isDeleted: false, deletedAt: null, deletedBy: null });
                        alertUser("Liste wurde aus dem Papierkorb wiederhergestellt.", "success");
                    }
                });
            }
            setupPermanentDeleteModalListeners();

            // GANZ AM ENDE VON setupEventListeners() HINZUFÜGEN
            const notrufConfigToggle = document.getElementById('notrufConfigToggle');
            if (notrufConfigToggle) {
                notrufConfigToggle.addEventListener('click', () => {
                    const area = document.getElementById('notrufConfigArea');
                    const icon = document.getElementById('notrufConfigToggleIcon');
                    area.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                });
            }


            // START: Füge diese neuen Funktionen nach setupEventListeners() ein

            // === ERSETZE diese Funktion ===
            function initializeNotrufSettingsView() {
                activeFlicEditorKlickTyp = null; // Aktiven Klick-Typ zurücksetzen
                document.getElementById('flic-details-editor-container').classList.add('hidden'); // Editor-Box verstecken

                populateFlicAssignmentSelectors(); // Den einen Editor-Dropdown befüllen
                updateFlicColumnDisplays(); // Die 3 Spalten mit den Modus-Namen befüllen

                // Alle Spalten-Hervorhebungen entfernen
                document.querySelectorAll('.flic-column-block').forEach(col => {
                    col.classList.remove('bg-indigo-100', 'border-indigo-400');
                    col.classList.add('bg-gray-50', 'border-gray-200');
                });

                // Editor-Bereiche standardmäßig verstecken
                document.getElementById('modeEditorArea').classList.add('hidden');
                document.getElementById('modeConfigFormContainer').classList.add('hidden');

                // Sicherstellen, dass die Zuweisungskarte (die obere) sichtbar ist
                const assignmentCard = document.querySelector('#card-flic-notruf .card');
                if (assignmentCard) assignmentCard.classList.remove('hidden');
            }            // *** NEUE Funktion: Zeigt Details des AKTIVEN Modus oben an ***

            // === FÜGE DIESE ZWEI NEUEN FUNKTIONEN HINZU ===

            // Füllt alle drei Flic-Zuweisungs-Dropdowns
            function populateFlicAssignmentSelectors() {
                const selector = document.getElementById('flic-editor-selector');
                if (!selector) return;

                const modes = notrufSettings.modes || [];

                // Erstelle die <option> Elemente
                let optionsHTML = '<option value="">Kein Modus zugewiesen</option>';
                modes.forEach(mode => {
                    optionsHTML += `<option value="${mode.id}">${mode.title}</option>`;
                });

                selector.innerHTML = optionsHTML;
            }

            // === NEUE FUNKTION: Aktualisiert die Namen in den 3 Spalten ===
            // === NEUE FUNKTION: Aktualisiert die Namen in den 3 Spalten ===
            function updateFlicColumnDisplays() {
                const modes = notrufSettings.modes || [];
                const assignments = notrufSettings.flicAssignments || { einfach: null, doppel: null, halten: null };

                ['einfach', 'doppel', 'halten'].forEach(klickTyp => {
                    const nameDisplay = document.getElementById(`flicDisplayModeName-${klickTyp}`);
                    const descDisplay = document.getElementById(`flicDisplayModeDesc-${klickTyp}`); // <-- NEU
                    if (!nameDisplay || !descDisplay) return; // <-- Geändert

                    const assignedModeId = assignments[klickTyp];
                    const assignedMode = modes.find(m => m.id === assignedModeId);

                    if (assignedMode) {
                        nameDisplay.textContent = assignedMode.title;
                        nameDisplay.title = assignedMode.title;
                        descDisplay.textContent = assignedMode.description || '(Keine Kurzbeschreibung)'; // <-- NEU
                    } else {
                        nameDisplay.textContent = 'Kein Modus';
                        nameDisplay.title = 'Kein Modus';
                        descDisplay.textContent = ''; // <-- NEU
                    }
                });
            }            // === NEUE FUNKTION: Befüllt die Editor-Box mit Details ===
            function updateFlicEditorBox(klickTyp) {
                const modes = notrufSettings.modes || [];
                const assignments = notrufSettings.flicAssignments || { einfach: null, doppel: null, halten: null };

                const title = document.getElementById('flic-editor-title');
                const selector = document.getElementById('flic-editor-selector');
                const detailsDisplay = document.getElementById('flic-editor-details');

                if (!title || !selector || !detailsDisplay) return;

                const klickTypBezeichnung = klickTyp.toUpperCase();
                title.textContent = `Modus für KLICK: ${klickTypBezeichnung} ändern`;

                const assignedModeId = assignments[klickTyp];
                const selectedMode = modes.find(m => m.id === assignedModeId);

                // Setze den Dropdown auf den aktuell zugewiesenen Wert
                selector.value = assignedModeId ? assignedModeId : "";

                if (selectedMode) {
                    // Modus ist zugewiesen -> Details anzeigen
                    const config = selectedMode.config || {};
                    const recipients = (config.userKeys || []).map(u => u.name).join(', ') || 'Niemand';
                    detailsDisplay.innerHTML = `
            <strong class="block">Empfänger:</strong>
            <span class="block pl-2 mb-1">${recipients}</span>
            <strong class="block">Nachricht:</strong>
            <span class="block pl-2 mb-1">"${config.message || 'Keine'}"</span>
            <strong class="block">Prio:\u00A0${config.priority || 'N/A'}, Retry:\u00A0${config.retry || 'N/A'}s</strong>
        `;
                } else {
                    // Kein Modus zugewiesen
                    detailsDisplay.innerHTML = 'Kein Modus zugewiesen.';
                }
            }

            // Zeigt die Beschreibung für JEDES Zuweisungs-Dropdown an
            // === Bis hier hinzufügen ===
            // === NEUE FUNKTION (ersetzt die alte displayAssignmentDescriptions) ===
            function updateFlicDisplay(klickTyp) {
                const modes = notrufSettings.modes || [];

                // Finde die UI-Elemente für die Spalte
                const selector = document.getElementById(`flicAssign${klickTyp.charAt(0).toUpperCase() + klickTyp.slice(1)}`);
                const nameDisplay = document.getElementById(`flicDisplayModeName-${klickTyp}`);
                const detailsDisplay = document.getElementById(`flicDisplayModeDetails-${klickTyp}`);

                if (!selector || !nameDisplay || !detailsDisplay) return; // Stellt sicher, dass alle Elemente da sind

                const selectedId = selector.value ? parseInt(selector.value) : null;
                const selectedMode = modes.find(m => m.id === selectedId);

                if (selectedMode) {
                    // Modus ist zugewiesen
                    nameDisplay.textContent = selectedMode.title;
                    nameDisplay.title = selectedMode.title; // Für Tooltip, falls Text abgeschnitten wird

                    // Detaillierte Einstellungen für die blaue Box
                    const config = selectedMode.config || {};
                    const recipients = (config.userKeys || []).map(u => u.name).join(', ') || 'Niemand';
                    // HTML für die Details-Box, \u00A0 ist ein geschütztes Leerzeichen, um unschönen Umbruch zu verhindern
                    detailsDisplay.innerHTML = `
            <strong class="block">Empfänger:</strong>
            <span class="block pl-2 mb-1">${recipients}</span>
            <strong class="block">Nachricht:</strong>
            <span class="block pl-2 mb-1">"${config.message || 'Keine'}"</span>
            <strong class="block">Prio:\u00A0${config.priority || 'N/A'}, Retry:\u00A0${config.retry || 'N/A'}s</strong>
        `;
                } else {
                    // Kein Modus zugewiesen
                    nameDisplay.textContent = 'Kein Modus';
                    nameDisplay.title = 'Kein Modus';
                    detailsDisplay.innerHTML = 'Kein Modus zugewiesen.';
                }
            }
            // *** NEUE Funktion: Rendert die Liste der Modi im Editor-Bereich ***
            function renderModeEditorList() {
                const listContainer = document.getElementById('existingModesList');
                if (notrufSettings.modes.length === 0) {
                    listContainer.innerHTML = '<p class="text-sm text-center text-gray-400">Keine Modi vorhanden.</p>';
                    return;
                }
                listContainer.innerHTML = notrufSettings.modes.map(mode => `
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded-md border">
            <div>
                <p class="font-semibold">${mode.title}</p>
                <p class="text-xs text-gray-500">${mode.description}</p>
            </div>
            <div class="flex gap-1">
                <button data-mode-id="${mode.id}" class="edit-mode-btn p-2 text-blue-500 hover:bg-blue-100 rounded-full" title="Bearbeiten">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M13.488 2.513a1.75 1.75 0 0 0-2.475 0L6.75 6.775a.75.75 0 0 0-.22.53l-.5 2.5a.75.75 0 0 0 .913.913l2.5-.5a.75.75 0 0 0 .53-.22l4.263-4.262a1.75 1.75 0 0 0 0-2.475Z" /><path d="M4.75 3.5c-.69 0-1.25.56-1.25 1.25v9.5c0 .69.56 1.25 1.25 1.25h9.5c.69 0 1.25-.56 1.25-1.25V9.5a.75.75 0 0 1 1.5 0v5.25A2.75 2.75 0 0 1 14.25 18h-9.5A2.75 2.75 0 0 1 2 15.25v-9.5A2.75 2.75 0 0 1 4.75 3.5h5.25a.75.75 0 0 1 0 1.5H4.75Z" /></svg>
                 </button>
                 <button data-mode-id="${mode.id}" class="delete-mode-btn p-2 text-red-500 hover:bg-red-100 rounded-full" title="Löschen">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1H2V3Zm2 2h8v8a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5Z" /></svg>
                 </button>
            </div>
        </div>
    `).join('');
            }

            // *** NEUE Funktion: Öffnet das Konfigurationsformular für einen Modus (neu oder Bearbeitung) ***
            // *** ERSETZE die gesamte 'openModeConfigForm' Funktion hiermit ***
            // *** ERSETZE die gesamte 'openModeConfigForm' Funktion hiermit ***
            function openModeConfigForm(modeId = null) {
                const formContainer = document.getElementById('modeConfigFormContainer');
                const formTitle = document.getElementById('modeConfigFormTitle');
                const editingModeIdInput = document.getElementById('editingModeId');
                const titleInput = document.getElementById('notrufModeTitle'); // Für Modus-Titel
                const descInput = document.getElementById('notrufModeDescInput');
                const pushoverTitleInput = document.getElementById('notrufTitle'); // Für Pushover-Titel
                const messageInput = document.getElementById('notrufMessage');
                const priorityButtons = document.querySelectorAll('#priority-buttons-container .priority-btn');
                // NEU: Referenzen für Retry-Input
                const retrySecondsInput = document.getElementById('retrySecondsInput');
                const retryCheckbox = document.getElementById('retryDeaktiviert');
                // -- Ende NEU --
                const apiTokenDisplay = document.getElementById('notrufApiTokenDisplay');
                const userKeyDisplay = document.getElementById('notrufUserKeyDisplay');
                const soundDisplay = document.getElementById('notrufSoundDisplay');

                // --- Standardwerte setzen & Felder leeren ---
                editingModeIdInput.value = '';
                titleInput.value = '';
                descInput.value = '';
                pushoverTitleInput.value = '';
                messageInput.value = '';
                apiTokenDisplay.innerHTML = '<span class="text-gray-400 italic">Kein Token ausgewählt</span>';
                userKeyDisplay.innerHTML = '';
                soundDisplay.innerHTML = '<span class="text-gray-400 italic">Standard (pushover)</span>';
                tempSelectedApiTokenId = null;
                tempSelectedSoundId = null; // Standardmäßig null

                // Priorität zurücksetzen
                priorityButtons.forEach(btn => btn.classList.remove('bg-indigo-600', 'text-white'));
                const defaultPrioButton = document.querySelector('.priority-btn[data-priority="0"]');
                if (defaultPrioButton) defaultPrioButton.classList.add('bg-indigo-600', 'text-white');

                // NEU: Retry/Expire zurücksetzen
                retryCheckbox.checked = false;
                retrySecondsInput.value = 30;
                retrySecondsInput.disabled = false;
                // -- Ende NEU --

                if (modeId) {
                    // --- Bearbeiten-Modus: Felder befüllen ---
                    const modeToEdit = notrufSettings.modes.find(m => m.id == modeId);
                    if (!modeToEdit) return;

                    formTitle.textContent = 'Modus Bearbeiten';
                    editingModeIdInput.value = modeId;
                    titleInput.value = modeToEdit.title || '';
                    descInput.value = modeToEdit.description || '';

                    const config = modeToEdit.config || {};
                    pushoverTitleInput.value = config.title || '';
                    messageInput.value = config.message || '';

                    // API Token anzeigen
                    tempSelectedApiTokenId = config.selectedApiTokenId || null;
                    const selectedToken = (notrufSettings.apiTokens || []).find(t => t.id === tempSelectedApiTokenId);
                    if (selectedToken) {
                        apiTokenDisplay.innerHTML = `<span class="api-token-badge inline-flex items-center gap-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full" data-token-id="${selectedToken.id}">${selectedToken.name}</span>`;
                    } else {
                        apiTokenDisplay.innerHTML = '<span class="text-gray-400 italic">Kein Token ausgewählt</span>';
                        tempSelectedApiTokenId = null;
                    }

                    // User Keys (Empfänger) anzeigen
                    userKeyDisplay.innerHTML = '';
                    (config.userKeys || []).forEach(contactRef => {
                        const contact = (notrufSettings.contacts || []).find(c => c.id === contactRef.id);
                        if (contact) {
                            userKeyDisplay.innerHTML += `<span class="contact-badge inline-flex items-center gap-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full" data-contact-id="${contact.id}">${contact.name}</span>`;
                        }
                    });

                    // Sound anzeigen
                    tempSelectedSoundId = config.selectedSoundId === undefined ? null : config.selectedSoundId; // Explizit null, wenn nicht gesetzt
                    const selectedSound = (notrufSettings.sounds || []).find(s => s.id === tempSelectedSoundId);
                    if (selectedSound) {
                        const displayName = selectedSound.useCustomName && selectedSound.customName ? selectedSound.customName : selectedSound.code;
                        soundDisplay.innerHTML = `<span class="sound-badge inline-flex items-center gap-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full" data-sound-id="${selectedSound.id}">${displayName}</span>`;
                    } else {
                        soundDisplay.innerHTML = '<span class="text-gray-400 italic">Standard (pushover)</span>';
                        tempSelectedSoundId = null;
                    }

                    // Priorität setzen
                    priorityButtons.forEach(btn => btn.classList.remove('bg-indigo-600', 'text-white'));
                    const prio = config.priority !== undefined ? config.priority : 0;
                    const selectedPrioButton = document.querySelector(`.priority-btn[data-priority="${prio}"]`);
                    if (selectedPrioButton) selectedPrioButton.classList.add('bg-indigo-600', 'text-white');

                    // NEU: Retry/Expire setzen vom gespeicherten Wert
                    const savedRetry = config.retry !== undefined ? config.retry : 30; // 'retry' statt 'retrySeconds'
                    if (savedRetry === 0) {
                        retryCheckbox.checked = true;
                        retrySecondsInput.disabled = true;
                        retrySecondsInput.value = 30; // Setze auf Minimum als Platzhalter
                    } else {
                        retryCheckbox.checked = false;
                        retrySecondsInput.disabled = false;
                        // Sicherstellen, dass der Wert im gültigen Bereich liegt
                        retrySecondsInput.value = Math.max(30, Math.min(10800, savedRetry));
                    }
                    // -- Ende NEU --

                } else {
                    // --- Neu-Anlegen-Modus ---
                    formTitle.textContent = 'Neuen Modus Anlegen';
                    // Felder wurden bereits oben zurückgesetzt
                }

                formContainer.classList.remove('hidden'); // Zeige das Formular an
            }

            function renderContactBook() {
                const list = document.getElementById('contactBookList');
                const contacts = notrufSettings.contacts || [];

                // Finde die aktuell im *Formular* angezeigten User Keys
                const currentFormUserKeys = [];
                document.querySelectorAll('#notrufUserKeyDisplay .contact-badge').forEach(badge => {
                    currentFormUserKeys.push(parseInt(badge.dataset.contactId));
                });

                if (contacts.length === 0) {
                    list.innerHTML = '<p class="text-sm text-center text-gray-400">Keine Kontakte gefunden.</p>';
                    return;
                }

                list.innerHTML = contacts.map(contact => {
                    // Prüfe gegen die Keys im *Formular*
                    const isChecked = currentFormUserKeys.includes(contact.id) ? 'checked' : '';
                    return `
            <div class="flex items-center justify-between p-2 hover:bg-gray-100 rounded-md">
                <label class="flex items-center gap-3 cursor-pointer flex-grow">
                    <input type="checkbox" value="${contact.id}" class="h-4 w-4 contact-checkbox" ${isChecked}>
                    <div>
                        <span class="font-semibold text-gray-800">${contact.name}</span>
                        <p class="text-xs text-gray-500">${contact.type}: <span class="font-mono">${contact.key}</span></p>
                    </div>
                </label>
                <button data-contact-id="${contact.id}" class="delete-contact-btn p-2 text-red-400 hover:text-red-600 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1H2V3Zm2 2h8v8a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5Z" /></svg>
                </button>
            </div>
        `;
                }).join('');
            }
            // ENDE: Neue Funktionen


            // --- NEUE FUNKTIONEN für API Token & Sound Books ---

            function renderApiTokenBook() {
                const list = document.getElementById('apiTokenBookList');
                const tokens = notrufSettings.apiTokens || [];
                // 'tempSelectedApiTokenId' enthält die ID des Tokens, das gerade im Formular ausgewählt ist
                const currentlySelectedId = tempSelectedApiTokenId;

                if (tokens.length === 0) {
                    list.innerHTML = '<p class="text-sm text-center text-gray-400">Keine Tokens gefunden.</p>';
                    return;
                }

                list.innerHTML = tokens.map(token => {
                    const isChecked = token.id === currentlySelectedId ? 'checked' : '';
                    return `
                    <div class="flex items-center justify-between p-2 hover:bg-gray-100 rounded-md">
                        <label class="flex items-center gap-3 cursor-pointer flex-grow">
                            <input type="radio" name="apiTokenSelection" value="${token.id}" class="h-4 w-4 api-token-radio" ${isChecked}>
                            <div>
                                <span class="font-semibold text-gray-800">${token.name}</span>
                                <p class="text-xs text-gray-500 font-mono">${token.key.substring(0, 4)}...${token.key.substring(token.key.length - 4)}</p>
                            </div>
                        </label>
                        <button data-token-id="${token.id}" class="delete-api-token-btn p-2 text-red-400 hover:text-red-600 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1H2V3Zm2 2h8v8a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5Z" /></svg>
                        </button>
                    </div>
                    `;
                }).join('');
            }

            function renderSoundBook() {
                const list = document.getElementById('soundBookList');
                const sounds = notrufSettings.sounds || [];
                const currentlySelectedId = tempSelectedSoundId; // Kann null sein für Standard
                const placeholder = document.getElementById('sound-list-placeholder');

                // Entferne alte benutzerdefinierte Einträge (Standard-Option bleibt)
                list.querySelectorAll('.custom-sound-item').forEach(item => item.remove());

                if (sounds.length === 0) {
                    if (placeholder) placeholder.classList.remove('hidden');
                } else {
                    if (placeholder) placeholder.classList.add('hidden');
                    let customSoundsHTML = '';
                    sounds.forEach(sound => {
                        // Wähle Radio aus, wenn seine ID mit der aktuell ausgewählten ID übereinstimmt
                        const isChecked = sound.id === currentlySelectedId ? 'checked' : '';
                        const displayName = sound.useCustomName && sound.customName ? sound.customName : sound.code;
                        const displayCode = sound.useCustomName && sound.customName ? `(${sound.code})` : '';

                        customSoundsHTML += `
                        <div class="custom-sound-item flex items-center justify-between p-2 hover:bg-gray-100 rounded-md">
                            <label class="flex items-center gap-3 cursor-pointer flex-grow">
                                <input type="radio" name="soundSelection" value="${sound.id}" class="h-4 w-4 sound-radio" ${isChecked}>
                                <div>
                                    <span class="font-semibold text-gray-800">${displayName}</span>
                                    <p class="text-xs text-gray-500 font-mono">${displayCode}</p>
                                </div>
                            </label>
                            <button data-sound-id="${sound.id}" class="delete-sound-btn p-2 text-red-400 hover:text-red-600 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M2 3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1H2V3Zm2 2h8v8a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5Z" /></svg>
                            </button>
                        </div>
                        `;
                    });
                    // Füge die benutzerdefinierten Sounds nach der Standardoption ein
                    list.insertAdjacentHTML('beforeend', customSoundsHTML);
                }

                // Stelle sicher, dass der Standard-Radio-Button ausgewählt ist, wenn currentlySelectedId null ist
                const defaultRadio = list.querySelector('input[name="soundSelection"][value="default"]');
                if (defaultRadio) {
                    defaultRadio.checked = (currentlySelectedId === null);
                }
            }            // Hilfsfunktion zum Formatieren von Sekunden
            /**
                     * Richtet alle Event-Listener für den Vorlagen-Editor-Bereich ein. (FINALE, KORRIGIERTE VERSION)
                     * Steuert das Erstellen, Auswählen, Bearbeiten und Löschen von Vorlagen und deren Einträgen.
                     */
            /**
                     * Richtet alle Event-Listener für den Vorlagen-Editor-Bereich ein. (FINALE, KORRIGIERTE VERSION)
                     * Steuert das Erstellen, Auswählen, Bearbeiten und Löschen von Vorlagen und deren Einträgen.
                     */
            function setupTemplateEditorListeners() {
                const templatesCard = document.getElementById('card-templates');
                if (!templatesCard || templatesCard.dataset.listenerAttached === 'true') {
                    return; // Verhindert, dass der Listener mehrfach hinzugefügt wird
                }

                templatesCard.addEventListener('click', async (e) => {
                    const templateItem = e.target.closest('.template-selection-item');
                    if (templateItem) {
                        selectedTemplateId = templateItem.dataset.templateId;
                        document.getElementById('template-editor-title').textContent = `Einträge für Container "${TEMPLATES[selectedTemplateId].name}"`;
                        document.getElementById('template-item-editor').classList.remove('hidden');
                        renderTemplateList();

                        if (unsubscribeTemplateItems) unsubscribeTemplateItems();

                        const itemsSubCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-templates', selectedTemplateId, 'template-items');
                        unsubscribeTemplateItems = onSnapshot(query(itemsSubCollectionRef), (snapshot) => {
                            TEMPLATE_ITEMS[selectedTemplateId] = [];
                            snapshot.forEach(doc => TEMPLATE_ITEMS[selectedTemplateId].push({ id: doc.id, ...doc.data() }));
                            renderTemplateItemsEditor();
                        });
                        return;
                    }

                    if (e.target.closest('#add-template-item-btn') && selectedTemplateId) {
                        const textInput = document.getElementById('new-template-item-text');
                        const assigneeSelect = document.getElementById('new-template-item-assignee');
                        const categorySelect = document.getElementById('new-template-item-category');
                        const importantCheckbox = document.getElementById('new-template-item-important');
                        const text = textInput.value.trim();
                        if (!text) return alertUser("Bitte Text eingeben.", "error");

                        const assignedTo = assigneeSelect.value;
                        const assignedToName = assignedTo ? assigneeSelect.options[assigneeSelect.selectedIndex].text : null;
                        const categoryId = categorySelect.value;
                        const categoryName = categoryId ? categorySelect.options[categorySelect.selectedIndex].text : null;

                        const newItemData = { text, important: importantCheckbox.checked, assignedTo: assignedTo || null, assignedToName, categoryId: categoryId || null, categoryName };
                        const itemsSubCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-templates', selectedTemplateId, 'template-items');
                        await addDoc(itemsSubCollectionRef, newItemData);

                        textInput.value = '';
                        assigneeSelect.value = '';
                        categorySelect.value = '';
                        importantCheckbox.checked = false;
                        textInput.focus();
                        return;
                    }

                    const createForm = templatesCard.querySelector('#create-template-form');
                    const showCreateFormBtn = templatesCard.querySelector('#show-create-template-form-btn');

                    if (e.target.closest('#show-create-template-form-btn')) {
                        createForm.classList.remove('hidden');
                        showCreateFormBtn.classList.add('hidden');
                    }

                    if (e.target.closest('#create-template-btn')) {
                        const newTemplateNameInput = document.getElementById('new-template-name');
                        const templateName = newTemplateNameInput.value.trim();
                        if (!templateName) return alertUser("Bitte geben Sie einen Namen für den Container ein.", "error");

                        const templatesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-templates');
                        await addDoc(templatesCollectionRef, { name: templateName, createdAt: serverTimestamp() });
                        alertUser(`Container "${templateName}" wurde erstellt!`, "success");
                        newTemplateNameInput.value = '';
                        createForm.classList.add('hidden');
                        showCreateFormBtn.classList.remove('hidden');
                        return;
                    }

                    const deleteTemplateItemBtn = e.target.closest('.delete-template-item-btn');
                    if (deleteTemplateItemBtn && selectedTemplateId) {
                        const itemId = deleteTemplateItemBtn.dataset.itemId;
                        if (confirm("Möchten Sie diesen Eintrag wirklich aus dem Container löschen?")) {
                            const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'checklist-templates', selectedTemplateId, 'template-items', itemId);
                            await deleteDoc(itemRef);
                        }
                        return;
                    }

                    const deleteTemplateBtn = e.target.closest('#delete-template-btn');
                    if (deleteTemplateBtn && selectedTemplateId) {
                        if (confirm(`Möchten Sie den Container "${TEMPLATES[selectedTemplateId].name}" wirklich unwiderruflich löschen?`)) {
                            const templateRef = doc(db, 'artifacts', appId, 'public', 'data', 'checklist-templates', selectedTemplateId);
                            await deleteDoc(templateRef);
                            selectedTemplateId = null;
                            document.getElementById('template-item-editor').classList.add('hidden');
                            renderTemplateList();
                        }
                        return;
                    }
                });

                templatesCard.dataset.listenerAttached = 'true';
            }

            function openTemplateModal(targetListId) {
                const modal = document.getElementById('templateApplyModal');
                modal.dataset.targetListId = targetListId;

                const templateTypeRadios = modal.querySelectorAll('input[name="template-type"]');
                const templateSelect = document.getElementById('template-select');

                const updateTemplateDropdown = () => {
                    const selectedType = modal.querySelector('input[name="template-type"]:checked').value;
                    document.getElementById('template-items-container').innerHTML = '';
                    document.getElementById('template-mode-section').classList.toggle('hidden', selectedType !== 'Schiff');

                    templateSelect.innerHTML = '<option value="">Bitte Quelle wählen...</option>';

                    if (selectedType === 'Container') {
                        let groupedContainerOptions = Object.values(CHECKLIST_STACKS).map(stack => {
                            const containersInStack = Object.values(TEMPLATES).filter(t => t.stackId === stack.id);
                            if (containersInStack.length === 0) return '';
                            return `
                    <optgroup label="${stack.name}">
                        ${containersInStack.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                    </optgroup>
                `;
                        }).join('');
                        const containersWithoutStack = Object.values(TEMPLATES).filter(t => !t.stackId);
                        if (containersWithoutStack.length > 0) {
                            groupedContainerOptions += `<optgroup label="Ohne Stack">
                    ${containersWithoutStack.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                </optgroup>`;
                        }
                        templateSelect.innerHTML += groupedContainerOptions;

                    } else if (selectedType === 'Schiff') {
                        Object.values(CHECKLISTS).forEach(checklist => {
                            templateSelect.innerHTML += `<option value="${checklist.id}">${checklist.name}</option>`;
                        });
                    }
                };

                templateTypeRadios.forEach(radio => radio.addEventListener('change', updateTemplateDropdown));

                templateSelect.addEventListener('change', async (e) => {
                    const selectedId = e.target.value;
                    const selectedType = modal.querySelector('input[name="template-type"]:checked').value;
                    const itemsContainer = document.getElementById('template-items-container');

                    // Wichtig: Wir leeren den Container, um Platz für die neuen Einträge zu machen.
                    itemsContainer.innerHTML = '';

                    if (selectedId) {
                        // Wenn ein Container ausgewählt wurde...
                        if (selectedType === 'Container') {
                            // 1. Zeige eine Lade-Nachricht an
                            itemsContainer.innerHTML = '<p class="text-xs text-gray-500">Lade Einträge...</p>';

                            // 2. Lade die Einträge direkt aus der Datenbank
                            const itemsSubCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'checklist-templates', selectedId, 'template-items');
                            const snapshot = await getDocs(query(itemsSubCollectionRef, orderBy('text')));

                            // 3. Speichere die geladenen Einträge
                            TEMPLATE_ITEMS[selectedId] = [];
                            snapshot.forEach(doc => TEMPLATE_ITEMS[selectedId].push({ id: doc.id, ...doc.data() }));

                            // 4. Zeige die Einträge an
                            renderTemplateItemsView(selectedId, selectedType);

                            // Wenn ein Schiff (eine andere Checkliste) ausgewählt wurde...
                        } else if (selectedType === 'Schiff') {
                            // Zeige einfach die bereits geladenen Einträge an
                            renderTemplateItemsView(selectedId, selectedType);
                        }
                    }
                });
                updateTemplateDropdown();
                modal.style.display = 'flex';
            }

            function renderTemplateItemsView(templateId, templateType) {
                const container = document.getElementById('template-items-container');
                container.innerHTML = '';
                let items = [];

                if (templateType === 'Container') {
                    items = TEMPLATE_ITEMS[templateId] || [];
                } else if (templateType === 'Schiff') {
                    items = CHECKLIST_ITEMS[templateId] || [];
                }

                if (items.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-500">Diese Vorlage hat keine Einträge.</p>';
                    return;
                }

                container.innerHTML += `
        <label class="flex items-center gap-2 p-2 border-b font-semibold cursor-pointer">
            <input type="checkbox" id="template-select-all" class="h-4 w-4">
            <span>Alle auswählen</span>
        </label>
    `;

                items.forEach(item => {
                    container.innerHTML += `
            <label class="flex items-center gap-2 p-1 cursor-pointer hover:bg-gray-100 rounded">
                <input type="checkbox" value="${item.id}" class="h-4 w-4 template-item-cb" 
                    data-text="${item.text}" 
                    data-important="${item.important || false}"
                    data-assigned-to="${item.assignedTo || ''}"
                    data-assigned-to-name="${item.assignedToName || ''}"
                    data-category-id="${item.categoryId || ''}"
                    data-category-name="${item.categoryName || ''}"
                    data-category-color="${item.categoryColor || ''}"> 
                <span class="text-sm">${item.text}</span>
            </label>
        `;
                });

                document.getElementById('template-select-all').addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    container.querySelectorAll('.template-item-cb').forEach(cb => cb.checked = isChecked);
                });
            }
            function closeTemplateModal() {
                const modal = document.getElementById('templateApplyModal');
                modal.style.display = 'none';

                // Setzt das Modal für die nächste Benutzung zurück
                const itemsContainer = document.getElementById('template-items-container');
                itemsContainer.innerHTML = '';
                document.getElementById('template-select').innerHTML = '<option value="">Bitte zuerst Typ wählen...</option>';
                document.getElementById('template-mode-section').classList.add('hidden');
            }

            // Event-Listener für die Schließen-Buttons des neuen Modals hinzufügen
            document.getElementById('closeTemplateModalBtn').addEventListener('click', closeTemplateModal);
            document.getElementById('cancel-template-modal-btn').addEventListener('click', closeTemplateModal);
            document.getElementById('apply-template-btn').addEventListener('click', applyTemplateLogic);


            window.onload = function () {
                setupEventListeners();
                initializeFirebase();
                if ('serviceWorker' in navigator) {
                    try {
                        navigator.serviceWorker.register('/sw.js');
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                }
            };

            // ===============================================================
            // ============ START: LOGIK FÜR ESSENSBERECHNUNG ================
            // ===============================================================

            // Globales Objekt, um den aktuellen Zustand der Mahlzeit zu speichern
            let currentMeal = {
                name: '',
                singleProducts: [], // { id, name, weight }
                recipes: [],        // { id, name, ingredients: [{...}] }

                // Die "distribution" speichert jetzt die Eingaben des Benutzers, nicht das Ergebnis
                userInputDistribution: [], // { id, portionName, personId, personName, anzahl, productInputs: [{productId, mode, value}] }

                // Hier speichern wir, ob der "Rest" berechnet werden soll
                calculateRest: false,

                // Das Endergebnis der Berechnung wird separat gespeichert
                finalDistribution: []
            };
            let editingPortionId = null;
            // ERSETZEN: Komplette Funktion mit korrigiertem Workflow
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION MIT DIESER KORRIGIERTEN VERSION

            // ERSETZEN SIE IHRE AKTUELLE FUNKTION KOMPLETT HIERMIT
            function setupEssensberechnungListeners() {
                const view = document.getElementById('essensberechnungView');
                if (view.dataset.listenerAttached === 'true') return;

                // ----- Helper-Funktion zum Zurücksetzen des Formulars -----
                const resetPortionForm = () => {
                    editingPortionId = null;
                    const restBtn = document.getElementById('rest-mode-btn');
                    if (restBtn.classList.contains('bg-indigo-500')) {
                        restBtn.classList.remove('bg-indigo-500', 'text-white');
                        restBtn.classList.add('bg-gray-200', 'text-gray-800');
                        document.getElementById('person-select').disabled = false;
                        document.getElementById('portion-name').disabled = false;
                    }
                    const personSelect = document.getElementById('person-select');
                    personSelect.value = '';
                    const placeholderOption = personSelect.querySelector('option[value=""]');
                    if (placeholderOption) placeholderOption.disabled = false;

                    document.getElementById('portion-name').value = '';
                    document.getElementById('portion-anzahl').value = 1;
                    document.querySelectorAll('.recipe-portion-weight-input, .product-value-input').forEach(input => {
                        input.value = '';
                        input.disabled = false;
                    });
                    document.querySelectorAll('.product-mode-radio[value="gramm"]').forEach(radio => radio.checked = true);
                    document.getElementById('add-portion-definition-btn').classList.remove('hidden');
                    document.getElementById('update-portion-definition-btn').classList.add('hidden');
                    document.getElementById('delete-portion-definition-btn').classList.add('hidden');
                    document.getElementById('portion-definition-form').classList.remove('bg-yellow-50');
                    setDefaultPortionName();
                    renderDistributionList();
                };

                view.addEventListener('keydown', (e) => {
                    if (e.key !== 'Enter') return;

                    if (e.target.id === 'single-product-weight') {
                        e.preventDefault();
                        document.getElementById('add-single-product-btn').click();
                    }
                    if (e.target.classList.contains('ingredient-weight')) {
                        e.preventDefault();
                        const recipeCard = e.target.closest('.recipe-card');
                        if (recipeCard) {
                            recipeCard.querySelector('.add-ingredient-btn').click();
                        }
                    }
                });

                const personSelectForEvent = document.getElementById('person-select');
                if (personSelectForEvent) {
                    personSelectForEvent.addEventListener('change', setDefaultPortionName);
                }

                // ----- Haupt-Click-Listener -----
                view.addEventListener('click', (e) => {
                    // --- Interaktionen im oberen Bereich (Produkte, Rezepte) ---
                    if (e.target.closest('#add-single-product-btn')) {
                        const nameInput = view.querySelector('#single-product-name');
                        const weightInput = view.querySelector('#single-product-weight');
                        const name = nameInput.value.trim();
                        const weight = parseFloat(weightInput.value);
                        if (name && weight > 0) {
                            currentMeal.singleProducts.push({ id: Date.now(), name, weight });
                            nameInput.value = '';
                            weightInput.value = '';
                            renderMealComposition();
                            renderDistributionInputs();
                            nameInput.focus();
                        }
                    }
                    if (e.target.closest('.delete-recipe-btn')) {
                        const recipeId = parseInt(e.target.closest('.delete-recipe-btn').dataset.recipeId);
                        if (confirm("Möchten Sie dieses Rezept wirklich löschen?")) {
                            currentMeal.recipes = currentMeal.recipes.filter(r => r.id !== recipeId);
                            renderMealComposition();
                            renderDistributionInputs();
                        }
                    }
                    if (e.target.closest('.delete-single-product-btn')) {
                        const productId = parseInt(e.target.closest('.delete-single-product-btn').dataset.id);
                        currentMeal.singleProducts = currentMeal.singleProducts.filter(p => p.id !== productId);
                        renderMealComposition();
                        renderDistributionInputs();
                    }
                    if (e.target.closest('#add-recipe-btn')) {
                        const recipeName = prompt("Wie soll das neue Rezept heißen?");
                        if (recipeName && recipeName.trim()) {
                            currentMeal.recipes.push({ id: Date.now(), name: recipeName.trim(), ingredients: [], calculatedFinalWeight: 0 });
                            renderMealComposition();
                            renderDistributionInputs();
                        }
                    }
                    // ERSETZE DEN KOMPLETTEN if-BLOCK FÜR ".add-ingredient-btn"

                    if (e.target.closest('.add-ingredient-btn')) {
                        const recipeId = parseInt(e.target.closest('.add-ingredient-btn').dataset.recipeId);
                        const recipeCard = view.querySelector(`.recipe-card[data-recipe-id="${recipeId}"]`);
                        const nameInput = recipeCard.querySelector('.ingredient-name');
                        const weightInput = recipeCard.querySelector('.ingredient-weight');
                        const name = nameInput.value.trim();
                        const weight = parseFloat(weightInput.value);

                        if (name && weight > 0) {
                            const recipe = currentMeal.recipes.find(r => r.id === recipeId);
                            if (recipe) {
                                // 1. Daten aktualisieren
                                recipe.ingredients.push({ id: Date.now(), name, weight });

                                // 2. Den Bereich komplett neu zeichnen
                                renderMealComposition();

                                // 3. JETZT ERST das neue Eingabefeld im neu gezeichneten
                                //    Bereich suchen und den Fokus darauf setzen.
                                const newRecipeCard = view.querySelector(`.recipe-card[data-recipe-id="${recipeId}"]`);
                                if (newRecipeCard) {
                                    const newNameInput = newRecipeCard.querySelector('.ingredient-name');
                                    if (newNameInput) {
                                        newNameInput.focus();
                                    }
                                }
                            }
                        }
                    } if (e.target.closest('.delete-ingredient-btn')) {
                        const btn = e.target.closest('.delete-ingredient-btn');
                        const recipeId = parseInt(btn.dataset.recipeId);
                        const ingredientId = parseInt(btn.dataset.ingredientId);
                        const recipe = currentMeal.recipes.find(r => r.id === recipeId);
                        if (recipe) {
                            recipe.ingredients = recipe.ingredients.filter(i => i.id !== ingredientId);
                            renderMealComposition();
                        }
                    }

                    // --- Logik für den "Rest"-Button ---
                    if (e.target.closest('#rest-mode-btn')) {
                        const btn = e.target.closest('#rest-mode-btn');
                        const personSelect = document.getElementById('person-select');
                        const portionNameInput = document.getElementById('portion-name');
                        const isActivating = !btn.classList.contains('bg-indigo-500');

                        if (isActivating) {
                            btn.classList.add('bg-indigo-500', 'text-white');
                            btn.classList.remove('bg-gray-200', 'text-gray-800');
                            personSelect.disabled = true;
                            portionNameInput.disabled = true;
                            portionNameInput.value = 'Rest';
                            personSelect.value = '';
                        } else {
                            btn.classList.remove('bg-indigo-500', 'text-white');
                            btn.classList.add('bg-gray-200', 'text-gray-800');
                            personSelect.disabled = false;
                            portionNameInput.disabled = false;
                            portionNameInput.value = '';
                            setDefaultPortionName();
                        }
                    }

                    // --- Modus-Umschalter für Produkte ---
                    const modeRadio = e.target.closest('.product-mode-radio');
                    if (modeRadio) {
                        const group = modeRadio.closest('.product-input-group');
                        const valueInput = group.querySelector('.product-value-input');
                        valueInput.disabled = (modeRadio.value !== 'gramm');
                        if (valueInput.disabled) valueInput.value = '';
                    }

                    // --- Klick auf eine definierte Portion zum Bearbeiten ODER ABWÄHLEN ---
                    const portionItem = e.target.closest('.portion-definition-item');
                    if (portionItem && !e.target.closest('.delete-portion-definition-btn')) {
                        const portionId = parseInt(portionItem.dataset.id);

                        if (editingPortionId === portionId) {
                            resetPortionForm();
                            return;
                        }

                        const portionData = currentMeal.userInputDistribution.find(p => p.id === portionId);
                        if (!portionData) return;

                        editingPortionId = portionId;
                        document.getElementById('portion-definition-form').classList.add('bg-yellow-50');
                        document.getElementById('add-portion-definition-btn').classList.add('hidden');
                        document.getElementById('update-portion-definition-btn').classList.remove('hidden');
                        document.getElementById('delete-portion-definition-btn').classList.remove('hidden');

                        const personSelect = document.getElementById('person-select');
                        const placeholderOption = personSelect.querySelector('option[value=""]');
                        const restBtn = document.getElementById('rest-mode-btn');

                        if (portionData.personId === 'rest_user') {
                            if (!restBtn.classList.contains('bg-indigo-500')) {
                                restBtn.click();
                            }
                        } else {
                            if (restBtn.classList.contains('bg-indigo-500')) {
                                restBtn.click();
                            }
                            personSelect.value = portionData.personId;
                            if (placeholderOption) placeholderOption.disabled = true;
                        }

                        document.getElementById('portion-name').value = portionData.portionName;
                        document.getElementById('portion-anzahl').value = portionData.anzahl;

                        portionData.recipeInputs.forEach(ri => {
                            const input = view.querySelector(`.recipe-portion-weight-input[data-recipe-id="${ri.recipeId}"]`);
                            if (input) input.value = ri.weight > 0 ? ri.weight : '';
                        });
                        portionData.productInputs.forEach(pi => {
                            const group = view.querySelector(`.product-input-group[data-product-id="${pi.productId}"]`);
                            if (group) {
                                group.querySelector(`input[name="mode-${pi.productId}"][value="${pi.mode}"]`).checked = true;
                                const valueInput = group.querySelector('.product-value-input');
                                valueInput.value = pi.value > 0 ? pi.value : '';
                                valueInput.disabled = (pi.mode !== 'gramm');
                            }
                        });

                        renderDistributionList();
                    }

                    // --- Klick auf "Änderung übernehmen" ---
                    if (e.target.closest('#update-portion-definition-btn')) {
                        if (!editingPortionId) return;
                        const portionToUpdate = currentMeal.userInputDistribution.find(p => p.id === editingPortionId);
                        if (!portionToUpdate) return;

                        const isRestPortion = document.getElementById('rest-mode-btn').classList.contains('bg-indigo-500');
                        const personSelect = document.getElementById('person-select');

                        portionToUpdate.personId = isRestPortion ? 'rest_user' : personSelect.value;
                        portionToUpdate.personName = isRestPortion ? 'Rest' : personSelect.options[personSelect.selectedIndex].text;
                        portionToUpdate.portionName = document.getElementById('portion-name').value.trim();
                        portionToUpdate.anzahl = parseInt(document.getElementById('portion-anzahl').value) || 1;

                        portionToUpdate.recipeInputs = [];
                        document.querySelectorAll('.recipe-portion-weight-input').forEach(input => {
                            portionToUpdate.recipeInputs.push({ recipeId: parseInt(input.dataset.recipeId), weight: parseFloat(input.value) || 0 });
                        });
                        portionToUpdate.productInputs = [];
                        document.querySelectorAll('.product-input-group').forEach(group => {
                            portionToUpdate.productInputs.push({
                                productId: parseInt(group.dataset.productId),
                                mode: group.querySelector('.product-mode-radio:checked').value,
                                value: parseFloat(group.querySelector('.product-value-input').value) || 0
                            });
                        });

                        resetPortionForm();
                    }

                    // --- Portion zur Definitions-Liste hinzufügen ---
                    if (e.target.closest('#add-portion-definition-btn')) {
                        const isRestPortion = document.getElementById('rest-mode-btn').classList.contains('bg-indigo-500');
                        const personSelect = document.getElementById('person-select');
                        const personId = isRestPortion ? 'rest_user' : personSelect.value;
                        const personName = isRestPortion ? 'Rest' : personSelect.options[personSelect.selectedIndex].text;
                        const portionName = document.getElementById('portion-name').value.trim();
                        const anzahl = parseInt(document.getElementById('portion-anzahl').value) || 1;

                        if ((isRestPortion && currentMeal.userInputDistribution.some(p => p.personId === 'rest_user')) || (!isRestPortion && !personId) || !portionName) {
                            if (isRestPortion) alertUser("Es kann nur eine 'Rest'-Portion definiert werden.", "error");
                            else alertUser("Bitte Person und Portionsnamen angeben.", "error");
                            return;
                        }

                        const recipeInputs = [];
                        document.querySelectorAll('.recipe-portion-weight-input').forEach(input => {
                            recipeInputs.push({ recipeId: parseInt(input.dataset.recipeId), weight: parseFloat(input.value) || 0 });
                        });
                        const productInputs = [];
                        document.querySelectorAll('.product-input-group').forEach(group => {
                            productInputs.push({
                                productId: parseInt(group.dataset.productId),
                                mode: group.querySelector('.product-mode-radio:checked').value,
                                value: parseFloat(group.querySelector('.product-value-input').value) || 0
                            });
                        });

                        currentMeal.userInputDistribution.push({
                            id: Date.now(), portionName, personId, personName, anzahl,
                            recipeInputs, productInputs
                        });

                        resetPortionForm();
                    }

                    // --- Eine Portions-Definition wieder aus der Liste löschen ---
                    const deleteDefBtn = e.target.closest('#delete-portion-definition-btn');
                    if (deleteDefBtn) {
                        if (editingPortionId && confirm("Möchten Sie die ausgewählte Portion wirklich löschen?")) {
                            // Filtere die gelöschte Portion aus der Liste
                            currentMeal.userInputDistribution = currentMeal.userInputDistribution.filter(p => p.id !== editingPortionId);
                            // Setze das Formular zurück
                            resetPortionForm();
                        }
                    }
                    // --- Finale Berechnung für alles in der Liste starten ---
                    if (e.target.closest('#run-calculation-btn')) {
                        calculateAndRenderDistribution();
                    }

                    // --- Interaktive Buttons im Ergebnisbereich ---
                    const viewBtn = e.target.closest('.view-btn');
                    if (viewBtn) {
                        const mode = viewBtn.dataset.viewMode;
                        displayCalculationResult(mode);

                        document.querySelectorAll('#calculation-view-switcher .view-btn').forEach(btn => {
                            btn.classList.remove('bg-indigo-500', 'text-white');
                            btn.classList.add('bg-gray-300', 'hover:bg-gray-400');
                        });
                        viewBtn.classList.add('bg-indigo-500', 'text-white');
                        viewBtn.classList.remove('bg-gray-300', 'hover:bg-gray-400');
                    }
                });

                view.dataset.listenerAttached = 'true';
            }



            function renderMealComposition() {
                const singleProductsList = document.getElementById('single-products-list');
                const recipesArea = document.getElementById('recipes-area');

                singleProductsList.innerHTML = currentMeal.singleProducts.map(p => `
        <div class="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
            <span>${p.name} - <strong>${p.weight}g</strong></span>
            <button data-id="${p.id}" class="delete-single-product-btn p-1 text-red-400 hover:text-red-600">&times;</button>
        </div>
    `).join('');

                recipesArea.innerHTML = currentMeal.recipes.map(r => {
                    const totalRawWeight = r.ingredients.reduce((sum, i) => sum + i.weight, 0);
                    return `
        <div class="recipe-card p-3 border rounded-lg bg-blue-50" data-recipe-id="${r.id}">
            <div class="flex justify-between items-center">
                <h4 class="font-semibold text-blue-800">${r.name}</h4>
                <button data-recipe-id="${r.id}" class="delete-recipe-btn p-1 text-red-500 hover:bg-red-100 rounded-full">&times;</button>
            </div>

            <div class="mt-3 p-2 bg-blue-100 rounded-md">
                <span class="text-sm font-semibold text-blue-900">Berechnetes Endgewicht (gekocht):</span>
                <div id="recipe-calculated-weight-${r.id}" class="text-lg font-bold text-blue-900">${r.calculatedFinalWeight ? r.calculatedFinalWeight.toFixed(1) + 'g' : '...'}</div>
                <div class="text-xs text-blue-700">Rohgewicht der Zutaten: ${totalRawWeight}g</div>
            </div>
            <div class="mt-2 space-y-1 pl-4">
                ${r.ingredients.map(i => `
                    <div class="flex justify-between items-center text-sm">
                        <span>- ${i.name} (${i.weight}g)</span>
                        <button data-recipe-id="${r.id}" data-ingredient-id="${i.id}" class="delete-ingredient-btn p-1 text-red-400 hover:text-red-600">&times;</button>
                    </div>
                `).join('')}
            </div>
            <div class="flex gap-2 mt-3 pt-3 border-t">
                <input type="text" class="ingredient-name flex-grow p-1 border rounded-md text-sm" placeholder="Zutat">
                <input type="number" class="ingredient-weight w-20 p-1 border rounded-md text-sm" placeholder="g">
                <button data-recipe-id="${r.id}" class="add-ingredient-btn py-1 px-2 bg-blue-500 text-white text-xs font-bold rounded-md hover:bg-blue-600">+</button>
            </div>
        </div>
    `}).join('');
            }
            // ERSETZEN Sie die Funktion renderDistributionList
            // ERSETZEN: Diese Funktion zeigt jetzt die Eingaben an
            // ERSETZEN: Macht die Liste klickbar
            // ERSETZEN: Hebt die ausgewählte Portion hervor
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION HIERMIT
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION HIERMIT
            function renderDistributionList() {
                const distributionList = document.getElementById('distribution-list');

                if (currentMeal.userInputDistribution.length === 0) {
                    distributionList.innerHTML = '<p class="text-sm text-center text-gray-400">Noch keine Portionen definiert.</p>';
                } else {
                    distributionList.innerHTML = currentMeal.userInputDistribution.map(p => {
                        const isEditing = p.id === editingPortionId;
                        const itemClasses = isEditing
                            ? 'bg-yellow-100 border-yellow-400'
                            : 'bg-gray-50 hover:bg-yellow-50';

                        const displayName = p.personName === 'Rest'
                            ? 'Rest'
                            : `${p.portionName} (${p.personName})`;

                        return `
                <div data-id="${p.id}" class="portion-definition-item flex justify-between items-center p-2 rounded-lg text-sm border cursor-pointer transition-colors ${itemClasses}">
                    <div>
                        <p class="font-bold">${displayName}</p>
                        <p class="text-xs text-gray-600">Anzahl: ${p.anzahl}</p>
                    </div>
                </div>
            `;
                    }).join('');
                }
            }
            const distributionList = document.getElementById('distribution-list');
            const userOptions = Object.values(USERS)
                .filter(u => u.name && u.isActive)
                .map(user => `<option value="${user.id}">${user.name}</option>`)
                .join('');

            document.getElementById('person-select').innerHTML = `<option value="">Benutzer auswählen...</option>${userOptions}`;

            distributionList.innerHTML = currentMeal.distribution.map(p => {
                let detailsHTML = p.recipeWeights.map(rw => {
                    const recipe = currentMeal.recipes.find(r => r.id === rw.recipeId);
                    return `${recipe ? recipe.name : 'Unbekannt'}: ${rw.weight}g`;
                }).join(' | ');

                let productDetailsHTML = p.productWeights.map(pw => {
                    const product = currentMeal.singleProducts.find(prod => prod.id === pw.productId);
                    return `${product ? product.name : 'Unbekannt'}: ${pw.weight}g`;
                }).join(' | ');

                return `
        <div class="flex justify-between items-center bg-gray-100 p-2 rounded-lg text-sm">
            <div>
                <p><strong>${p.personName}</strong>: ${p.servings} Portion(en)</p>
                <p class="text-xs text-blue-700">${detailsHTML}</p>
                <p class="text-xs text-green-700">${productDetailsHTML}</p>
            </div>
            <button data-person-id="${p.personId}" class="delete-person-btn p-1 text-red-400 hover:text-red-600">&times;</button>
        </div>
    `}).join('');


            // ERSETZEN Sie die komplette Funktion
            // ERSETZEN: Erstellt jetzt auch Eingabefelder für Rezepte
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION KOMPLETT HIERMIT
            function renderDistributionInputs() {
                const recipeContainer = document.getElementById('recipe-weights-for-person');
                const productContainer = document.getElementById('product-weights-for-person');
                if (!recipeContainer || !productContainer) return;

                // KORREKTUR: Dieser Block erstellt die fehlenden Eingabefelder für Rezepte
                if (currentMeal.recipes.length > 0) {
                    recipeContainer.innerHTML = `<h4 class="text-sm font-semibold text-gray-600 mb-2">Rezept-Gewicht pro Portion (gekocht):</h4>` +
                        currentMeal.recipes.map(recipe => `
            <div class="flex items-center gap-2 mb-2">
                <label class="flex-grow text-sm font-medium">${recipe.name}:</label>
                <input type="number" class="recipe-portion-weight-input w-24 p-1 border rounded-md" placeholder="g" data-recipe-id="${recipe.id}">
            </div>
        `).join('');
                } else {
                    recipeContainer.innerHTML = '';
                }

                // Dieser Teil für die Einzelprodukte war bereits korrekt
                if (currentMeal.singleProducts.length > 0) {
                    productContainer.innerHTML = `<h4 class="text-sm font-semibold text-gray-600 mb-2">Gewicht der Einzelprodukte:</h4>` +
                        currentMeal.singleProducts.map(product => `
            <div class="p-2 border rounded-md bg-gray-50 product-input-group" data-product-id="${product.id}">
                <label class="font-semibold text-sm text-gray-800">${product.name}:</label>
                <div class="flex items-center gap-2 mt-1">
                    <input type="number" class="product-value-input flex-grow p-1 border rounded-md" placeholder="g">
                    <div class="flex items-center gap-3 text-xs font-medium">
                        <label><input type="radio" name="mode-${product.id}" value="gramm" class="product-mode-radio" checked> g</label>
                        <label><input type="radio" name="mode-${product.id}" value="auto %" class="product-mode-radio"> auto %</label>
                        <label><input type="radio" name="mode-${product.id}" value="auto Port." class="product-mode-radio"> auto Port.</label>
                    </div>
                </div>
            </div>
        `).join('');
                } else {
                    productContainer.innerHTML = '';
                }
            }
            // Globale Variable, um die aktive Ansicht zu speichern
            let activeDisplayMode = 'gesamt';

            // ERSETZEN Sie die komplette Funktion calculateAndRenderDistribution
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION HIERMIT
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION KOMPLETT HIERMIT
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION KOMPLETT HIERMIT
            function calculateAndRenderDistribution() {
                currentMeal.finalDistribution = [];
                const resultsTable = document.getElementById('results-table');
                resultsTable.innerHTML = `<p class="text-sm text-gray-500 text-center">Bitte eine Ansicht (Gesamt, Rest oder eine Portion) auswählen, um das Ergebnis anzuzeigen.</p>`;

                if (currentMeal.userInputDistribution.length === 0) {
                    renderCalculationViewSwitcher();
                    return;
                }

                currentMeal.recipes.forEach(recipe => {
                    const totalCookedWeight = currentMeal.userInputDistribution.reduce((sum, p) => {
                        const recipeInput = p.recipeInputs.find(ri => ri.recipeId === recipe.id);
                        return sum + ((recipeInput ? recipeInput.weight : 0) * p.anzahl);
                    }, 0);
                    recipe.calculatedFinalWeight = totalCookedWeight;
                });

                let totalGrammValueForRatio = currentMeal.userInputDistribution.reduce((sum, p) => {
                    const grammSum = p.productInputs.reduce((s, pi) => s + (pi.mode === 'gramm' ? pi.value : 0), 0);
                    return sum + (grammSum * p.anzahl);
                }, 0);
                const totalPortionCount = currentMeal.userInputDistribution.reduce((sum, p) => sum + p.anzahl, 0);

                currentMeal.userInputDistribution.forEach(portionInput => {
                    for (let i = 0; i < portionInput.anzahl; i++) {
                        const finalPortionData = new Map();

                        portionInput.recipeInputs.forEach(ri => {
                            const recipe = currentMeal.recipes.find(r => r.id === ri.recipeId);
                            if (!recipe || ri.weight === 0) return;
                            finalPortionData.set(`Rezept: ${recipe.name}`, ri.weight);
                        });

                        const portionGrammValue = portionInput.productInputs.reduce((s, pi) => s + (pi.mode === 'gramm' ? pi.value : 0), 0);
                        const portionProductRatio = (totalGrammValueForRatio > 0) ? (portionGrammValue / totalGrammValueForRatio) : (1 / totalPortionCount);
                        portionInput.productInputs.forEach(pi => {
                            const product = currentMeal.singleProducts.find(p => p.id === pi.productId);
                            if (!product) return;
                            let amount = 0;
                            if (pi.mode === 'gramm') amount = pi.value;
                            else if (pi.mode === 'auto %') amount = product.weight * portionProductRatio;
                            else if (pi.mode === 'auto Port.') amount = (totalPortionCount > 0) ? product.weight / totalPortionCount : 0;

                            if (amount > 0) {
                                finalPortionData.set(product.name, (finalPortionData.get(product.name) || 0) + amount);
                            }
                        });

                        const portionId = portionInput.id + i;
                        const portionName = (portionInput.anzahl > 1) ? `${portionInput.portionName} ${i + 1}/${portionInput.anzahl}` : portionInput.portionName;
                        const displayName = portionInput.personName === 'Rest' ? 'Rest' : `${portionName} (${portionInput.personName})`;

                        currentMeal.finalDistribution.push({ id: portionId, name: displayName, data: finalPortionData });
                    }
                });

                currentMeal.finalDistribution = currentMeal.finalDistribution.filter(p => p.name !== 'Rest');

                const hasRestDefinition = currentMeal.userInputDistribution.some(p => p.personId === 'rest_user');
                if (hasRestDefinition) {
                    const restData = new Map();

                    // ★★★ START DER KORREKTUR ★★★
                    // Zuerst den Rest der gekochten Rezepte berechnen und zu den Rest-Daten hinzufügen.
                    currentMeal.recipes.forEach(recipe => {
                        const totalRequiredCooked = currentMeal.userInputDistribution
                            .filter(p => p.personId !== 'rest_user') // "Rest"-Eingabe ignorieren
                            .reduce((sum, p) => {
                                const recipeInput = p.recipeInputs.find(ri => ri.recipeId === recipe.id);
                                return sum + ((recipeInput ? recipeInput.weight : 0) * p.anzahl);
                            }, 0);

                        const leftoverCooked = recipe.calculatedFinalWeight - totalRequiredCooked;
                        if (leftoverCooked > 0.1) {
                            restData.set(`Rezept: ${recipe.name}`, leftoverCooked);
                        }
                    });

                    // Danach wie bisher die Reste der rohen Zutaten berechnen.
                    const totalRequiredRaw = new Map();
                    currentMeal.finalDistribution.forEach(portion => {
                        portion.data.forEach((value, key) => {
                            if (key.startsWith('Rezept: ')) {
                                const recipeName = key.replace('Rezept: ', '');
                                const recipe = currentMeal.recipes.find(r => r.name === recipeName);
                                if (recipe && recipe.calculatedFinalWeight > 0) {
                                    const ratio = value / recipe.calculatedFinalWeight;
                                    recipe.ingredients.forEach(ing => {
                                        totalRequiredRaw.set(ing.name, (totalRequiredRaw.get(ing.name) || 0) + (ing.weight * ratio));
                                    });
                                }
                            } else {
                                totalRequiredRaw.set(key, (totalRequiredRaw.get(key) || 0) + value);
                            }
                        });
                    });

                    const totalAvailableRaw = new Map();
                    currentMeal.singleProducts.forEach(p => {
                        totalAvailableRaw.set(p.name, (totalAvailableRaw.get(p.name) || 0) + p.weight);
                    });
                    currentMeal.recipes.forEach(r => {
                        r.ingredients.forEach(ing => {
                            totalAvailableRaw.set(ing.name, (totalAvailableRaw.get(ing.name) || 0) + ing.weight);
                        });
                    });

                    totalAvailableRaw.forEach((availableAmount, ingredientName) => {
                        const requiredAmount = totalRequiredRaw.get(ingredientName) || 0;
                        const leftover = availableAmount - requiredAmount;
                        if (leftover > 0.1) {
                            restData.set(ingredientName, leftover);
                        }
                    });

                    currentMeal.finalDistribution.push({ id: 'rest', name: "Rest", data: restData });
                    // ★★★ ENDE DER KORREKTUR ★★★
                }

                renderMealComposition();
                renderCalculationViewSwitcher();
                displayCalculationResult('gesamt');
                const gesamtBtn = document.querySelector('.view-btn[data-view-mode="gesamt"]');
                if (gesamtBtn) {
                    document.querySelectorAll('#calculation-view-switcher .view-btn').forEach(btn => {
                        btn.classList.remove('bg-indigo-500', 'text-white');
                        btn.classList.add('bg-gray-300', 'hover:bg-gray-400');
                    });
                    gesamtBtn.classList.add('bg-indigo-500', 'text-white');
                }
            }

            function renderCalculationViewSwitcher() {

                const switcher = document.getElementById('calculation-view-switcher');
                if (!switcher) return;

                // Prüfen, ob eine "Rest"-Portion im finalen Ergebnis existiert
                const hasRestPortion = currentMeal.finalDistribution.some(p => p.id === 'rest');

                let switcherHTML = `
        <button class="view-btn p-2 text-sm font-semibold rounded-md bg-gray-300 hover:bg-gray-400" data-view-mode="gesamt">Gesamt</button>
    `;

                // Nur wenn eine Rest-Portion da ist, den Button hinzufügen
                if (hasRestPortion) {
                    switcherHTML += `<button class="view-btn p-2 text-sm font-semibold rounded-md bg-gray-300 hover:bg-gray-400" data-view-mode="rest">Rest</button>`;
                }

                currentMeal.finalDistribution.forEach(portion => {
                    // Nur echte Portionen als Button anzeigen, nicht den Rest
                    if (portion.id !== 'rest') {
                        switcherHTML += `<button class="view-btn p-2 text-sm font-semibold rounded-md bg-gray-300 hover:bg-gray-400" data-view-mode="${portion.id}">${portion.name}</button>`;
                    }
                });

                switcher.innerHTML = switcherHTML;
            }            // NEUE FUNKTION: Zeigt das Ergebnis für die gewählte Ansicht an
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION KOMPLETT HIERMIT
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION KOMPLETT HIERMIT
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION KOMPLETT HIERMIT
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION KOMPLETT HIERMIT
            // ERSETZEN SIE IHRE AKTUELLE FUNKTION KOMPLETT HIERMIT
            function displayCalculationResult(mode) {
                const resultsTable = document.getElementById('results-table');
                let dataToShow = new Map();
                let header = '';

                if (mode === 'gesamt') {
                    header = 'Gesamt';
                    currentMeal.singleProducts.forEach(p => {
                        dataToShow.set(p.name, (dataToShow.get(p.name) || 0) + p.weight);
                    });
                    currentMeal.recipes.forEach(r => {
                        if (r.calculatedFinalWeight > 0) {
                            dataToShow.set(`Rezept: ${r.name}`, r.calculatedFinalWeight);
                        }
                        r.ingredients.forEach(ing => {
                            dataToShow.set(ing.name, (dataToShow.get(ing.name) || 0) + ing.weight);
                        });
                    });

                } else {
                    const portionId = (mode === 'rest') ? 'rest' : parseInt(mode);
                    const targetPortion = currentMeal.finalDistribution.find(p => p.id === portionId);
                    if (targetPortion) {
                        header = targetPortion.name;
                        dataToShow = new Map(targetPortion.data);

                        if (mode !== 'rest') {
                            currentMeal.recipes.forEach(recipe => {
                                if (dataToShow.has(`Rezept: ${recipe.name}`)) {
                                    const portionCookedWeight = dataToShow.get(`Rezept: ${recipe.name}`);
                                    if (recipe.calculatedFinalWeight > 0) {
                                        const ratio = portionCookedWeight / recipe.calculatedFinalWeight;
                                        recipe.ingredients.forEach(ing => {
                                            dataToShow.set(ing.name, (dataToShow.get(ing.name) || 0) + (ing.weight * ratio));
                                        });
                                    }
                                }
                            });
                        }
                    }
                }

                let tableHTML = `<div class="overflow-x-auto"><table class="min-w-full bg-white border rounded-lg text-sm">
        <thead class="bg-gray-100"><tr>
            <th class="p-2 border-b text-left">Zutat / Rezept</th>
            <th class="p-2 border-b text-right">${header}</th>
        </tr></thead><tbody>`;

                const renderedKeys = new Set();

                // ★★★ START DER KORRIGIERTEN ANZEIGELOGIK ★★★

                // 1. Rezepte und deren Zutaten rendern
                currentMeal.recipes.forEach(recipe => {
                    const recipeKey = `Rezept: ${recipe.name}`;
                    const recipeCookedWeight = dataToShow.get(recipeKey) || 0;

                    // Finde die Zutaten dieses Rezepts, die im Rest vorhanden sind
                    const leftoverIngredientsForRecipe = recipe.ingredients.filter(ing => dataToShow.has(ing.name) && dataToShow.get(ing.name) > 0.1);

                    // Zeige die blaue Kopfzeile an, wenn entweder das gekochte Rezept ODER Restzutaten davon existieren
                    if (recipeCookedWeight > 0 || (mode === 'rest' && leftoverIngredientsForRecipe.length > 0)) {
                        tableHTML += `<tr class="bg-blue-50 font-semibold hover:bg-blue-100">
                <td class="p-2 border-b">${recipe.name}</td>
                <td class="p-2 border-b text-right">${recipeCookedWeight > 0 ? recipeCookedWeight.toFixed(1) + 'g' : '<span class="text-gray-400 italic">Restzutaten</span>'}</td>
            </tr>`;
                        renderedKeys.add(recipeKey);

                        // Zeige die dazugehörigen Zutaten an
                        const ingredientsToShow = (mode === 'rest') ? leftoverIngredientsForRecipe : recipe.ingredients;
                        ingredientsToShow.forEach(ingredient => {
                            const ingredientWeight = dataToShow.get(ingredient.name) || 0;
                            if (ingredientWeight > 0.1 && !renderedKeys.has(ingredient.name)) {
                                tableHTML += `<tr class="hover:bg-gray-50">
                        <td class="p-2 border-b pl-6 text-gray-600">${ingredient.name}</td>
                        <td class="p-2 border-b text-right text-gray-600">${ingredientWeight.toFixed(1)}g</td>
                    </tr>`;
                                renderedKeys.add(ingredient.name);
                            }
                        });
                    }
                });

                // 2. Alle restlichen Einträge rendern (Einzelprodukte oder Zutaten, die keinem Rezept zugeordnet sind)
                for (const [key, value] of dataToShow.entries()) {
                    if (!renderedKeys.has(key) && value > 0.1) {
                        tableHTML += `<tr class="hover:bg-gray-50">
                <td class="p-2 border-b font-semibold">${key}</td>
                <td class="p-2 border-b text-right">${value.toFixed(1)}g</td>
            </tr>`;
                    }
                }
                // ★★★ ENDE DER KORRIGIERTEN ANZEIGELOGIK ★★★

                tableHTML += `</tbody></table></div>`;
                resultsTable.innerHTML = tableHTML;
            }
            function initializeEssensberechnungView() {
                setupEssensberechnungListeners(); // Stellt sicher, dass die Listener nur einmal gesetzt werden
                populatePersonDropdown();         // Füllt das Dropdown-Menü EINMALIG

                // Beim ersten Öffnen die UI korrekt aufbauen
                renderMealComposition();
                renderDistributionInputs();
                renderDistributionList(); // Zeigt die Liste der bereits definierten Portionen an

                // Setzt den Standard-Portionsnamen (z.B. "Mittwoch")
                setDefaultPortionName();
            }
        </script>

</body>

</html>